"use strict";define("Wit/Common/WorkItemNodeService",["require","exports","VSS/Platform/Context","Wit/Clients/Wit/RestClient/WorkItemTracking","Wit/Common/NodeHelpers"],function(t,e,r,a,o){!function(t){var i,s;e.IWorkItemNodeService={},function(t){t.maxNodeDepth=15}(i||(i={})),function(t){t.SettingsKey="ClassificationFieldsMru",t.AreaPathMruKey="AreaPath",t.IterationPathMruKey="IterationPath",t.MruLength=5}(s||(s={}));r.Services.add("IWorkItemNodeService",{serviceFactory:class extends r.VssService{constructor(){super(...arguments),this.projectToAreaPathMap=new Map,this.projectToIterationMap=new Map,this.projectPromiseMap=new Map,this.projectToMruAreaPathsMap=new Map,this.projectToMruIterationsMap=new Map,this.projectMruPromiseMap=new Map}_serviceStart(t){super._serviceStart(t)}async findIterationNodeByPath(t,e){this.projectToIterationMap.get(t)||await this.loadNodes(t);const r=this.projectToIterationMap.get(t);return(0,o.findByPath)(r,e,void 0,1)}async getAreaPathNodes(t){return this.projectToAreaPathMap.get(t)||await this.loadNodes(t),this.projectToAreaPathMap.get(t)}async getIterationNodes(t){return this.projectToIterationMap.get(t)||await this.loadNodes(t),this.projectToIterationMap.get(t)}removeIterationNodes(t){this.projectToIterationMap.delete(t),this.projectPromiseMap.delete(t)}async getMruAreaPaths(t){return this.projectToMruAreaPathsMap.get(t)||await this.loadMruNodeIds(t),this.projectToMruAreaPathsMap.get(t)}async updateMruAreaPaths(t,e){let r=this.projectToMruAreaPathsMap.get(t);r||(r=await this.getMruAreaPaths(t));const a=await this.updateMru(t,r,e,s.AreaPathMruKey);return this.projectToMruAreaPathsMap.set(t,a),a}async getMruIterations(t){return this.projectToMruIterationsMap.get(t)||await this.loadMruNodeIds(t),this.projectToMruIterationsMap.get(t)}async updateMruIterations(t,e){let r=this.projectToMruIterationsMap.get(t);r||(r=await this.getMruIterations(t));const a=await this.updateMru(t,r,e,s.IterationPathMruKey);return this.projectToMruIterationsMap.set(t,a),a}async updateMru(t,e,r,a){const o=this.buildNewMru(e,r),i={[`${s.SettingsKey}/${a}`]:o},n=this.pageContext.getService("ISettingsService");return await n.setEntries(i,0,"project",t),o}async loadMruNodeIds(t){let e=this.projectMruPromiseMap.get(t);e||(e=this.pageContext.getService("ISettingsService").getEntriesAsync(s.SettingsKey,0,"project",t));const r=await e;if(!r)return;const a=r&&r[s.AreaPathMruKey]||[],o=r&&r[s.IterationPathMruKey]||[];this.projectToMruAreaPathsMap.set(t,a),this.projectToMruIterationsMap.set(t,o)}async loadNodes(t){const e=(0,a.getWorkItemTrackingClient)(this.pageContext);let r=this.projectPromiseMap.get(t);const o=this.pageContext.getService("IWorkItemDataManager").beginGetFieldProjectData(t);r||(r=e.getRootNodes(t,i.maxNodeDepth),this.projectPromiseMap.set(t,r));const[s,n]=await Promise.all([r,o]);if(!s)return;const c=null==n?void 0:n.projects[0],p=this.normalizeNode(c,s.find(t=>0===t.structureType)),h=this.normalizeNode(c,s.find(t=>1===t.structureType));p&&this.projectToAreaPathMap.set(t,p),h&&this.projectToIterationMap.set(t,h)}normalizeNode(t,e){return t&&e?{attributes:{},children:e.children,hasChildren:e.hasChildren,id:t.id,identifier:t.guid,name:t.name,path:t.name,structureType:e.structureType}:e}buildNewMru(t,e){if(!e||0===e.length)return t;const r=new Set(e),a=t.filter(t=>!r.has(t)),o=[...r,...a];return o.splice(s.MruLength,o.length-s.MruLength),o}}})}()},["IWorkItemNodeService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-node-service"}}));