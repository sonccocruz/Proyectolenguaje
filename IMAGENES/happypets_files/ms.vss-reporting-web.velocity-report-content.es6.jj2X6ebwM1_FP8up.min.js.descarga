"use strict";define("Reporting/VelocityReport",["require","exports","Analytics/Boards/BoardsQueries/BacklogsQuery","VSS/Core/Util/String","react","Reporting/BoardsCommon/BoardsReport","Reporting/BoardsCommon/BoardsRoutingHelper","Reporting/BoardsCommon/Pickers/AggregationPicker","Reporting/BoardsCommon/ReportGuidedTourUtility","Reporting/BoardsCommon/ReportQueryHelper","Reporting/BoardsCommon/ReportTelemetry","Reporting/BoardsCommon/ResetElement","Reporting/BoardsCommon/Resources","Reporting/BoardsCommon/UnmaterializedBoardMessage","VSS/Core/Observable","VSS/Platform/Components/Layout","VSS/Platform/FPS","VSS/Platform/Layout","VSSUI/FormItem","VSSUI/TextField","Widgets/Configs/Common/GenericSelectionDropdown","Widgets/VelocityWidget/VelocityWidgetComponents/VelocitySettingsManager","Reporting/BoardsCommon/ReportPageState"],function(e,t,i,o,s,r,a,n,l,c,g,u,m,p,h,d,b,y,S,R,C,f,I){var B,V,T,x,k,w;B=t.Resources={},t.Resources.ReportTitle="Velocity",t.Resources.MissingBacklogDetail="The active backlog level could not be found on the Analytics service.",t.Resources.CustomIterations="Custom iterations",t.Resources.TourBubbleTitle="The Velocity Report",t.Resources.TourBubbleText="Get insights into your team's average speed in completing work across several sprints. Use this information to plan future requirements. Customize this report by changing the metrics and number of iterations. Click next to take a quick tour.",t.Resources.FilterBubbleTitle="Velocity Report Configuration",t.Resources.FilterBubbleText="Customize the aggregation metric and number of iterations of your Velocity report. Your selection will be saved next time you visit the report.",t.Resources.ChartBubbleTitle="Velocity Chart",t.Resources.ChartBubbleText="Use the chart to compare planned velocity versus actual (completed) velocity and work completed later than planned. Learn more on how to control the calculation of planned work and work completed late.",t.Resources.LegendBubbleTitle="Velocity Chart Legend",t.Resources.LegendBubbleText="â€‹Click the chart's legend to hide or show parts of the chart.",t.Resources.AggregateByLabel="Velocity by",t.Resources.NumberOfIterationsLabel="Number of Iterations",t.Resources.CustomNumberOfIterationsLabel="Custom Number of Iterations",t.Resources.VelocityWidgetTitleFormat="{0} Velocity",t.Resources.IterationCountPickerOption="Last {0} iterations",function(e){V=t.VelocityReportUserSettings={};class i{static async reset(e,t,o){const s=e.getService("ISettingsService");await s.removeEntries("VelocityReport",0,i.teamScopeName,t)}static async save(e,t,o,s){const r=e.getService("ISettingsService"),a=`VelocityReport/${s}`,n={};n[a+"/"+i.aggregationKey]=t.aggregation,n[a+"/"+i.iterationKey]=t.numberOfIterations,await r.setEntries(n,0,i.teamScopeName,o)}static async load(e,t,o){const s=e.getService("ISettingsService"),r=await s.getEntriesAsync("VelocityReport/"+o,0,i.teamScopeName,t);return{aggregationSettings:r[i.aggregationKey],numberOfIterations:r[i.iterationKey]}}}function o(){return"VelocityReport"}t.VelocityReportUserSettings.VelocityReportUserSettings=i,i.aggregationKey="AggregationSettings",i.iterationKey="NumberOfIterations",i.teamScopeName="team",t.VelocityReportUserSettings.getVelocityReportSettingsStorageKey=o}(),function(e){T=t.VelocityReportTeachingBubbleHelper={},t.VelocityReportTeachingBubbleHelper.getTeachingBubblesData=function(){return{reportKey:(0,V.getVelocityReportSettingsStorageKey)(),tourBubble:{title:B.TourBubbleTitle,text:B.TourBubbleText},filterBubble:{title:B.FilterBubbleTitle,text:B.FilterBubbleText},chartBubble:{title:B.ChartBubbleTitle,text:B.ChartBubbleText},legendBubble:{title:B.LegendBubbleTitle,text:B.LegendBubbleText},reportDocumentationUrl:"https://go.microsoft.com/fwlink/?linkid=2095910"}}}(),function(e){x=t.PickersBacklogsQuery={},t.PickersBacklogsQuery.getBacklog=async function(e,t,o,s){const r=e.getService("IDashboardsCacheableQueryService"),a=new i.BacklogsQuery(t,[o]),n=await r.getCacheableQueryResult(a),l=n.findIndex(e=>e.BoardCategoryReferenceName===s);return l>=0?n[l]:void 0}}(),function(e){function i(e){return{id:e.toString(),text:(0,o.format)(B.IterationCountPickerOption,e),data:e}}k=t[e]={},t[e].customIterationsId="customiterations",t[e].getIterationOptions=function(){return[i(2),i(3),i(6),i(10),i(15),{id:"separator",type:3},{id:t[e].customIterationsId,text:B.CustomIterations}]}}("PickersIterationsPickerOptions"),function(e){w=t.VelocityReport={};class i extends r.BoardsReport{constructor(e,t){super(e,t),this.textFieldValue=new h.ObservableValue(""),this.resetSettings=(async()=>{await V.VelocityReportUserSettings.reset(this.context.pageContext,this.props.teamId,this.props.categoryReferenceName),this.initializeReportState()}),this.onAggregationSelect=(e=>{const t=Object.assign({},this.state.widgetSettings);t.aggregation=e,this.setUserSelection(t)}),this.onIterationSelect=(e=>{const t=e.id===k.customIterationsId;if(t)this.textFieldValue.value=this.state.widgetSettings.numberOfIterations.toString(),this.setState({customIterationValidationMessage:null});else{const t=Object.assign({},this.state.widgetSettings);t.numberOfIterations=e.data,this.setUserSelection(t)}this.setState({isCustomIteration:t})}),this.onCustomIterationChanged=((e,t)=>{const i=t.replace(/\D/g,"");this.textFieldValue.value=i,this.validateAndSaveCustomIterationsInput(i)}),this.toggleTeachingBubble=(()=>{this.setState({showTeachingBubble:!this.state.showTeachingBubble})}),this.onBubbleDismiss=(()=>{this.setState({showTeachingBubble:!1})}),this.state=this.getDefaultState()}getReportTitle(){return B.ReportTitle}getReportTelemetryName(){return"VelocityReport"}getWidgetName(){const e=this.props.teamName;return(0,o.format)(B.VelocityWidgetTitleFormat,e)}getWidgetContributionId(){return"ms.vss-dashboards-web.Microsoft.VisualStudioOnline.Dashboards.VelocityWidget"}initializeOnRender(){this.reportGuidedTourUtility=new l.ReportGuidedTourUtility(this.context.pageContext,(0,T.getTeachingBubblesData)(),this.onBubbleDismiss)}renderTeachingBubble(){return s.createElement(s.Fragment,null," ",this.reportGuidedTourUtility.render(this.state.showTeachingBubble)," ")}getTitleBlock(){const e=this.isReady()&&!this.isInAbnormalState()&&this.isConfigurationValid();return s.createElement(s.Fragment,null,super.getTitleBlock((0,l.getInfoIcon)(this.reportGuidedTourUtility.titleBubbleCallback,this.toggleTeachingBubble,e,this.getReportTitle())))}decorateWidgetContent(e){return s.createElement("div",{ref:this.reportGuidedTourUtility.chartBubbleCallback},e)}getFilterItems(){return s.createElement(s.Fragment,null,s.createElement("div",{ref:this.reportGuidedTourUtility.filterBubbleCallback},s.createElement(S.FormItem,{label:B.AggregateByLabel},s.createElement(n.AggregationPicker,{value:this.state.widgetSettings.aggregation,items:this.state.aggregationOptions,onSelect:this.onAggregationSelect}))),s.createElement(S.FormItem,{label:B.NumberOfIterationsLabel},s.createElement(C.GenericSelectionDropdown,{selectedId:this.state.isCustomIteration?k.customIterationsId:this.state.widgetSettings.numberOfIterations.toString(),items:this.state.iterationOptions,onSelect:this.onIterationSelect})),this.state.isCustomIteration&&s.createElement(S.FormItem,{className:"custom-iterations-form-item",label:B.CustomNumberOfIterationsLabel,message:this.state.customIterationValidationMessage,error:null!==this.state.customIterationValidationMessage},s.createElement(R.TextField,{ariaLabel:B.CustomIterations,value:this.textFieldValue,onChange:this.onCustomIterationChanged,width:"auto",className:"custom-iterations-text-field",inputClassName:"custom-iterations-text-field-input"})),s.createElement(u.ResetElement,{onClick:this.resetSettings,isEnabled:this.state.hasCustomUserSettings}))}getKnownWarningComponent(){return this.state.knownWarning===B.MissingBacklogDetail?s.createElement(p.UnmaterializedBoardMessage,null):null}componentDidMount(){(0,c.resetQueryCache)(this.context.pageContext),this.initializeReportState()}componentDidUpdate(e){JSON.stringify(this.props)!==JSON.stringify(e)&&(this.props.lastRefresh!==e.lastRefresh&&(0,c.resetQueryCache)(this.context.pageContext),this.setState(this.getDefaultState()),this.initializeReportState())}async initializeReportState(){this.cancelDataPromises();try{const e=await V.VelocityReportUserSettings.load(this.context.pageContext,this.props.teamId,this.props.categoryReferenceName),t=await(0,l.hasUserSeenBubble)(this.context.pageContext,(0,V.getVelocityReportSettingsStorageKey)());this.backlogCanceleablePromise=this.trackPromise((0,x.getBacklog)(this.context.pageContext,this.props.projectId,this.props.teamId,this.props.categoryReferenceName));const i=await this.backlogCanceleablePromise.promise;if(null==i){const e=B.MissingBacklogDetail;return this.setState({knownWarning:e}),void(0,g.publishEmptyReportTelemetry)(this.context.pageContext,this.getReportTelemetryName(),e)}const o=(0,k.getIterationOptions)();this.aggregationCanceleablePromise=this.trackPromise((0,n.getAggregationOptionsForBacklogCategories)(this.context.pageContext,this.props.projectId,this.props.teamId,[this.props.categoryReferenceName]));const s=await this.aggregationCanceleablePromise.promise,r=e.numberOfIterations||6,a=(0,f.packSettings)(this.props,i.BoardCategoryReferenceName,e.aggregationSettings,r),c=this.isCustomIteration(o,r);this.setState({aggregationOptions:s,iterationOptions:o,widgetSettings:a,isCustomIteration:c,showTeachingBubble:!t,hasCustomUserSettings:"{}"!==JSON.stringify(e)}),c&&(this.textFieldValue.value=this.state.widgetSettings.numberOfIterations.toString()),(0,g.publishReportTelemetry)(this.context.pageContext,this.getReportTelemetryName(),{aggregationMode:a.aggregation.identifier,numberOfIterations:a.numberOfIterations})}catch(e){if(e.isCanceled)return;this.handleCommonInitError(e)}finally{this.props.onLoadCompleted&&this.props.onLoadCompleted()}}getDefaultState(){return Object.assign({aggregationOptions:[],iterationOptions:[],customIterationValidationMessage:null},super.getDefaultState())}isConfigurationValid(){return null===this.state.customIterationValidationMessage}getBackButtonProps(){return{onClick:()=>{const e=(0,a.getBoardsReportUrl)(this.context.pageContext,this.props.categoryName);(0,b.FastPageSwitch)(this.context.pageContext,e,!0)}}}cancelDataPromises(){this.backlogCanceleablePromise&&this.backlogCanceleablePromise.cancel(),this.aggregationCanceleablePromise&&this.aggregationCanceleablePromise.cancel()}validateAndSaveCustomIterationsInput(e){const t=Number(e);if(""!==e&&t>=1&&t<=15){this.setState({customIterationValidationMessage:null});const e=Object.assign({},this.state.widgetSettings);e.numberOfIterations=t,this.setUserSelection(e)}else this.setState({customIterationValidationMessage:(0,o.format)(m.ValueMustBeWithinRange,1,15)})}isCustomIteration(e,t){return!e.some(e=>null!=e.data&&e.data===t)}setUserSelection(e){V.VelocityReportUserSettings.save(this.context.pageContext,e,this.props.teamId,this.props.categoryReferenceName),this.setState({widgetSettings:e,hasCustomUserSettings:!0})}}t.VelocityReport.VelocityReport=i,y.VssComponent.register("VelocityReport",i),y.VssComponent.register("VelocityReportPreloader",d.NoOpComponent)}(),function(e){t.VelocityReportPage={};class i extends y.VssComponent{async componentDidMount(){this.setState(await(0,I.getReportPageState)(this.context.pageContext))}render(){return null==this.state?null:s.createElement(w.VelocityReport,{categoryReferenceName:this.state.categoryReferenceName,categoryName:this.state.categoryName,teamId:this.state.teamId,teamName:this.state.teamName,projectId:this.state.projectId})}}t.VelocityReportPage.VelocityReportPage=i,y.VssComponent.register("VelocityReportPage",i)}()},["Resources","VelocityReportUserSettings","VelocityReportTeachingBubbleHelper","Pickers/BacklogsQuery","Pickers/IterationsPickerOptions","VelocityReport","VelocityReportPage"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-reporting-web.velocity-report-content"}}));