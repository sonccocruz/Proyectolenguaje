"use strict";define("WidgetCommon/ModernWidgetTypes",["require","exports","Reporting/Visuals/LayoutComponents/Widgets/LayoutState","Reporting/Visuals/LayoutComponents/Widgets/Demands/DemandTracker","Reporting/Visuals/LayoutComponents/Widgets/Demands/DemandType","react","Reporting/Visuals/VisualMessages/ActionRequiredContent","Reporting/Visuals/VisualMessages/AxFaultInMessage","Reporting/Visuals/VisualMessages/NoDataMessage","Reporting/Visuals/VisualMessages/UnconfiguredMessage","WidgetCommon/IterationDatesMessage/SetIterationDatesMessage","Dashboards/WidgetCommon/WidgetTelemetry","Dashboards/WidgetContracts/WidgetProps","Reporting/Visuals/LayoutComponents/Widgets/ComponentLayoutEngine","Reporting/Visuals/LayoutComponents/Widgets/LayoutActions","Reporting/Visuals/LayoutComponents/Widgets/LayoutStore","VSS/Platform/Layout"],function(e,t,s,i,a,n,r,o,g,d,p,h,c,l,u,m,S){var y,C,M,D,T,f,w;y=t.Resources={},t.Resources.UnableToValidateSettingsMessage="Existing settings for this widget could not be validated. Please re-configure the widget.",t.Resources.UnableToGenerateSettingsMessage="Unable to generate default settings for this widget. Supporting information needed to configure the widget may not be available. Please attempt to re-configure the widget for more information.",function(e){t.ActionCreatorBase={};t.ActionCreatorBase.ActionCreatorBase=class{constructor(e,t,s,i,a,n){this._context=e,this._state=s,this._dataManager=t,this._actions=i,this.stringifyError=n}initialize(){this._actions.ProvideData.invoke(this._dataManager.getInitialState())}async requestData(){await this._dataManager.getData().then(e=>(this._actions.ProvideData.invoke(e),Promise.resolve(null)),e=>{if(this._actions.ProvideData.invoke(e),e.messageType===s.MessageType.WidgetError)return Promise.reject(e.message);{const t=this.stringifyError(e);return Promise.reject(t)}})}handleMessageState(e,t){const i=(0,s.packMessageAsState)(e,t);this._actions.ProvideData.invoke(i)}registerDemand(e){this._dataManager.registerDemand(e)}}}(),function(e){t.ChartOptionFactoryBase={};t.ChartOptionFactoryBase.ChartOptionFactoryBase=class{}}(),t[w="CommonConfigurationTypes"]={},(f=t[w].AggregationMode||(t[w].AggregationMode={}))[f.Count=0]="Count",f[f.Sum=1]="Sum",(T=t[w].BehaviorTiming||(t[w].BehaviorTiming={}))[T.Delayed=0]="Delayed",T[T.Immediate=1]="Immediate",(D=t[w].NotificationMode||(t[w].NotificationMode={}))[D.On=0]="On",D[D.Silent=1]="Silent",function(e){C=t.SettingsManagerBase={};t.SettingsManagerBase.SettingsManagerBase=class{constructor(){}isCorrectlyConfigured(e){return this.isConfigured(e)}async ensureInitialSettings(e,t){let s;if(this.isConfigured(e))return s=e.settings?JSON.parse(e.settings):void 0,t||this.evaluateSettingsForValidity(e,s,y.UnableToValidateSettingsMessage),Promise.resolve(s);{const s=await this.generateDefaultSettings();return t||this.evaluateSettingsForValidity(e,s,y.UnableToGenerateSettingsMessage),s}}isConfigured(e){return null!=e.settings}evaluateSettingsForValidity(e,t,s){const i=Object.assign({},e);if(i.settings=JSON.stringify(t),!this.isCorrectlyConfigured(i))throw new Error(s)}}}(),function(e){t.EmptySettingsManager={};t.EmptySettingsManager.EmptySettingsManager=class extends C.SettingsManagerBase{constructor(e){super(),this.featureName=e}getFeatureName(){return this.featureName}generateDefaultSettings(){return Promise.resolve(void 0)}}}(),t.ModefulValueSetting={},function(e){t.WidgetDataManagerBase={};t.WidgetDataManagerBase.WidgetDataManagerBase=class{constructor(e,t){this.currentState={},this.update(t),this.context=e,this.demandTracker=new i.DemandTracker}registerDemand(e){if(!this.demandTracker.isDemandPresent(e))switch(this.demandTracker.registerDemand(e),e){case a.DemandType.title:this.currentState.title={text:this.title};break;case a.DemandType.subtitle:case a.DemandType.scalar:case a.DemandType.chart:case a.DemandType.submetrics:break;default:throw new Error("An unrecognized demand was issued to the DataManager.")}}update(e){this.title=e.title,this.settings=e.settings,this.suppressAnimations=e.suppressAnimations,this.widgetPropsForTelemetry=e.widgetTelemetryProps,this.hideTitle=e.hideTitle}getInitialState(){return this.currentState}async packMessageAsState(e,t){return this.currentState=(0,s.packMessageAsState)(e,t),(0,s.isErrorMessageType)(e)?Promise.reject(this.currentState):Promise.resolve(this.currentState)}}}(),function(e){M=t.WidgetMessageCardFactory={};t.WidgetMessageCardFactory.WidgetMessageCardFactory=class extends n.Component{constructor(e){super(e)}render(){const e=this.getMessageCard();return n.createElement("div",{className:"widget-message-card-container"},e)}getMessageCard(){switch(this.props.messageType){case s.MessageType.NoData:return n.createElement(g.NoDataMessage,{visualTitle:this.props.title,size:this.props.size,hideTitle:this.props.hideTitle});case s.MessageType.SetIterationDates:return n.createElement(p.SetIterationDatesMessage,{visualTitle:this.props.title,actionOptions:this.getWidgetCardAction(),size:this.props.size});case s.MessageType.AxFaultIn:return n.createElement(o.AxFaultInMessage,{visualTitle:this.props.title,size:this.props.size});case s.MessageType.Unconfigured:return n.createElement(d.UnconfiguredMessage,{visualTitle:this.props.title,size:this.props.size,onClick:this.getWidgetCardAction().onClick});case s.MessageType.MissingPermissions:return n.createElement(r.ActionRequiredContent,{visualTitle:this.props.title,onClick:this.getWidgetCardAction().onClick});default:return null}}getWidgetCardAction(){return{text:this.props.messageOptions?this.props.messageOptions.actionText:"",ariaLabel:this.props.messageOptions?this.props.messageOptions.actionAriaLabel:"",onClick:this.props.messageOptions?this.props.messageOptions.actionOnClickDelegate:void 0}}}}(),function(e){t.ViewComponentBase={};t.ViewComponentBase.ViewComponentBase=class extends S.VssComponent{constructor(){super(...arguments),this.settingsAreInitialized=!1,this.setStoreStateDelegate=(()=>this.setStoreState())}componentDidUpdate(e,t){super.componentDidUpdate(e,t),this.sizesAreSame(e.size,this.props.size)?this.props.settings!==e.settings&&this.ensureSettings():(this.layoutFactory=this.selectLayoutFactory(),this.layoutFactory.registerDemands(this.actionsCreator),this.ensureSettings())}componentWillMount(){this.initializeCommonMembers(),this.ensureSettings()}render(){if(!this.settingsAreInitialized)return null;try{return this.getStoreState().showMessage?this.renderMessageCard():this.renderView()}catch(e){return this.handleErrorOnRenderCompletion(e),null}}componentDidCatch(e,t){this.handleErrorOnRenderCompletion(e)}componentDidMount(){this.store&&this.store.addChangedListener(this.setStoreStateDelegate),this.props.settings&&h.onWidgetLoaded(this.context.pageContext,this.props,this.packWidgetLoadedTelemetryData(JSON.parse(this.props.settings)))}componentWillUnmount(){this.store&&this.store.removeChangedListener(this.setStoreStateDelegate)}setStoreStateAndRenderCompletion(){this.setStoreState(),this.props.onRenderCompletion({outcome:c.LoadingStatus.success})}initializeCommonMembers(){this.dataManager=this.instantiateDataManager(),this.actions=new u.LayoutActions,this.store=new m.LayoutStore(this.actions,this.dataManager.getInitialState()),this.actionsCreator=this.createActionCreator(),this.layoutFactory=this.selectLayoutFactory(),this.layoutFactory.registerDemands(this.actionsCreator),this.actionsCreator.initialize(),this.setState(this.getStoreState()),this.settingsManager=this.createSettingsManager()}instantiateDataManager(){const e=Object.assign({},this.props),t={title:e.name,hideTitle:e.shouldNotShowTitle,settings:e.settings,suppressAnimations:this.props.suppressAnimations,widgetTelemetryProps:this.props};return this.createDataManager(t)}updateWithLatestConfiguration(e,t){this.dataManager.update(e),this.actionsCreator.requestData().then(e=>{this.props.onRenderCompletion()},e=>{this.handleErrorOnRenderCompletion(e)})}packWidgetLoadedTelemetryData(e){return{}}getLayoutMappings(){return l.DefaultComponentLayouts.getDefaultMappings()}selectLayoutFactory(){return(new l.ComponentLayoutEngine).selectLayoutFactory(this.props.size,this.getLayoutMappings())}handleErrorOnRenderCompletion(e){this.props.onRenderCompletion({outcome:c.LoadingStatus.failure,outcomeDescription:e&&e.message?e.message:e})}renderMessageCard(){const e=this.props.name,t=this.props.size,s=this.getStoreState().message,i=this.getStoreState().messageType,a=this.getMessageOptions();return n.createElement(M.WidgetMessageCardFactory,{messageType:i,message:s,messageOptions:a,title:e,size:t,hideTitle:this.props.shouldNotShowTitle})}setStoreState(){this.setState(this.getStoreState())}getStoreState(){return Object.assign(Object.assign({},this.store.getState()),{title:{text:this.props.name,hideTitle:this.props.shouldNotShowTitle}})}handleSettingsError(e){this.store.setState((0,s.packMessageAsState)(s.MessageType.Unconfigured)),this.setStoreStateAndRenderCompletion()}sizesAreSame(e,t){return e.height===t.height&&e.width===t.width}async ensureSettings(){try{const e=await this.settingsManager.ensureInitialSettings(this.props),t=Object.assign({},this.props);t.settings=JSON.stringify(e);const s={title:t.name,hideTitle:t.shouldNotShowTitle,settings:t.settings,suppressAnimations:this.props.suppressAnimations,widgetTelemetryProps:Object.assign(Object.assign({},this.props),{settings:t.settings})};h.onWidgetLoading(this.context.pageContext,this.props,this.packWidgetLoadedTelemetryData(e)),this.settingsAreInitialized=!0,this.updateWithLatestConfiguration(s,e)}catch(e){this.settingsAreInitialized=!0,this.handleSettingsError(e)}}renderView(){return n.createElement("div",{className:"view-component-base"},this.layoutFactory.render(this.getStoreState()))}}}()},["Resources","ActionCreatorBase","ChartOptionFactoryBase","CommonConfigurationTypes","SettingsManagerBase","EmptySettingsManager","ModefulValueSetting","WidgetDataManagerBase","WidgetMessageCardFactory","ViewComponentBase"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-dashboards-web.modern-widget-types"}}));