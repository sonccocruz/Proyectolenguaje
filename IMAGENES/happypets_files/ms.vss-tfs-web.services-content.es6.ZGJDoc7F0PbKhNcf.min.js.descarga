"use strict";define("TFS/Services",["require","exports","react","VSS/Platform/Layout","VSSUI/Dialog","VSS/Platform/Context","VSS/Platform/Feature","VSS/Platform/Telemetry","VSS/Core/Observable","VSS/Platform/Location"],function(e,t,r,s,o,i,n,a,c,l){var u,g;u=t.Resources={},t.Resources.Cancel="Cancel",t.Resources.DialogTitle="Authenticate",t.Resources.OpenPopup="Open popup",t.Resources.ReauthenticationDialogText="Azure DevOps needs to update your authentication.",t.Resources.PopupBlockedMessage="It looks like popups are blocked. Please click the Open Popup button to open the authentication window.",t.Resources.VerificationFailedMessage="Unable to confirm authentication. Click the Open Popup button to authenticate again, or refresh the page.",t.TfsRestErrorHandlerServicetypes={},function(e){g=t.ReauthenticationDialog={},t.ReauthenticationDialog.ReauthenticationDialog=function(e){const t=(0,s.useComponentContext)(),[i,n]=r.useState("opening"),a=r.useRef(null),c=r.useRef(-1);let l=!1;return console.log(`ReauthenticationDialog state: ${i}`),r.useEffect(()=>(window.addEventListener("message",g),p(),()=>{d(),window.removeEventListener("message",g)}),[]),r.createElement(o.Dialog,{footerButtonProps:[{onClick:()=>{d(),e.onResolve(2),e.onDismiss()},text:u.Cancel},{onClick:()=>{p()},primary:!0,text:u.OpenPopup}],lightDismiss:!1,onDismiss:()=>{e.onResolve(2),e.onDismiss()},titleProps:{text:u.DialogTitle}},r.createElement("p",null,u.ReauthenticationDialogText),"blocked"===i&&r.createElement("p",null,u.PopupBlockedMessage),"verificationFailed"===i&&r.createElement("p",null,u.VerificationFailedMessage));function g(e){"reauthenticationPopupOpened"===e.data?(n("open"),a.current=e.source):"reauthenticationPopupClosed"===e.data&&(d(),v())}function p(){n("opening"),c.current>0&&d();const t=window.open(e.popupUrl,"AzureDevOpsReauthentication",`width=500,height=500,left=${(screen.width-500)/2},top=${(screen.height-500)/2}`);console.log("Popped popup: %O",t),a.current=t,t?(n("open"),c.current=setInterval(h,100)):n("blocked")}function h(){var e;(null===(e=a.current)||void 0===e?void 0:e.closed)&&(console.log("Popup closed"),d(),v())}function d(){var e;clearInterval(c.current),c.current=-1,null===(e=a.current)||void 0===e||e.close(),a.current=null}async function v(){if(n("verifying"),!l){l=!0;try{const r=t.pageContext.getService("ITfsRestErrorHandlerService");(await r.verify()).success?(e.onResolve(1),e.onDismiss()):n("verificationFailed")}finally{l=!1}}}}}(),function(e){t.TfsRestErrorHandlerService={};const s="TfsRestErrorHandlerService",o="VisualStudio.Services.WebAccess.RestErrorHandler.FetchSignout";i.Services.add("ITfsRestErrorHandlerService",{serviceFactory:class extends i.VssService{_serviceStart(e){super._serviceStart(e)}async handleError(e,t,r,s){const o=r&&new URL(r.url);return this._handleError(e,t,o,s,"newplat")}async handleOldPlatError(e,t,r,s){const o=r&&new URL(r.responseURL);return this._handleError(e,t,o,s,"oldplat")}verify(){return new Promise((e,t)=>{console.log("Verifying authentication."),this.pageContext.getRestClient("IWebContributionsRestClient",{errorHandler:async(t,r,s,o,i)=>(console.log(`Handling error in verification, new url ${null==o?void 0:o.url}`),e({success:!1,newUrl:null==o?void 0:o.url}),2),ignoreQueue:!0}).queryContributedHierarchy({contributionIds:["ms.vss-web.user-claims-data"],dataProviderContext:{properties:{}}},void 0,void 0).then(t=>{console.log(`Verification result: ${JSON.stringify(t)}`),t.dataProviders["ms.vss-web.user-claims-data"].member?e({success:!0}):e({success:!1})},e=>{console.error(`Exception in authentication verification: ${e}`),t(e)})})}getPageType(e){switch(e.pathname){case"/_signin":return"signin";case"/_signout":return"signout";default:return"other"}}getSigninUrl(e){const t=this.pageContext.getService("IVssContributionService").getData("ms.vss-tfs-web.tfs-rest-error-handler-service-data-provider"),r=new URL(e.href);r.searchParams.set("force","1"),r.searchParams.set("reply_to",t.closePopupUrl);const s=new URL(t.openPopupUrl);return s.searchParams.set("r",r.href),s}async _handleError(e,t,r,i,c){var l;if(!r)return 2;let u=this.getPageType(r);if("other"!==u&&1===e&&("SyntaxError"===i.name||"TFS.WebApi.Exception"===i.name&&(null===(l=i.message)||void 0===l?void 0:l.includes("parsererror")))){if((0,a.publishEvent)(this.pageContext,s,"handleErrorStart",{tries:e,responseUrl:r.href,errorName:i.name,errorMessage:i.message,source:c}),"signout"===u&&(0,n.isFeatureFlagEnabled)(this.pageContext,o)){const e=this.getSigninUrl(r);e.searchParams.set("mode","federated");const t=await fetch(e.href);(0,a.publishEvent)(this.pageContext,s,"handleErrorFetch",{status:t.status,statusText:t.statusText})}if("signout"===u){const e=await this.verify();if((0,a.publishEvent)(this.pageContext,s,"handleErrorSkip",{originalUrl:r.href,result:e}),e.success)return 1;e.newUrl&&(r=new URL(e.newUrl),u=this.getPageType(r))}if("signin"!==u)return 2;const t=this.getSigninUrl(r),l=await this._showReauthenticationDialog(t.href);return(0,a.publishEvent)(this.pageContext,s,"handleErrorResponse",{result:l,tries:e,responseUrl:r.href,popupUrl:t.href,errorName:i.name,errorMessage:i.message,source:c}),l}return 2}_showReauthenticationDialog(e){return new Promise((t,s)=>{this.pageContext.getService("IVssLayoutManager").renderCallout(o=>r.createElement(g.ReauthenticationDialog,{onDismiss:o,onReject:s,onResolve:t,popupUrl:e}))})}}})}(),function(e){t.TfsProjectService={};const r="ms.vss-tfs-web.project-plus-product-data-provider",s="ms.vss-tfs-web.project-mru-data-provider";i.Services.add("ITfsProjectService",{serviceFactory:class extends i.VssService{getAllProjects(){if(!this.allProjects){this.allProjects=new c.ReadyableObservableArray;const e=this.pageContext.getService("IVssContributionService"),t=e.getData(r);t?(this.allProjects.push(...this.getProjectsFromProjectData(t)),this.allProjects.ready.value=!0,this.allProjectsPromise=Promise.resolve(this.allProjects.value)):this.allProjectsPromise=e.getDataAsync(r).then(e=>(this.allProjects.push(...this.getProjectsFromProjectData(e)),this.allProjects.ready.value=!0,this.allProjects.value))}return this.allProjects}getAllProjectsLoadedPromise(){return this.allProjectsPromise||this.getAllProjects(),this.allProjectsPromise}getMruProjects(){if(!this.mruProjects){this.mruProjects=new c.ObservableArray([]);const e=this.pageContext.getService("IVssContributionService"),t=e.getData(s);t?this.mruProjects.push(...this.getProjectsFromProjectData(t)):e.getDataAsync(s).then(e=>{this.mruProjects.push(...this.getProjectsFromProjectData(e))})}return this.mruProjects}getProjectsFromProjectData(e){let t=[];return e&&(t=e.projects.map(e=>{const t=(0,l.routeUrl)(this.pageContext,"ms.vss-tfs-web.project-overview-route",{project:e.projectName});return{id:e.projectId,imageUrl:e.projectImageUrl,name:e.projectName,url:t,description:e.projectDescription,products:e.products}})),t}}})}(),function(e){t.TfsTeamService={};i.Services.add("ITfsTeamService",{serviceFactory:class extends i.VssService{constructor(){super(...arguments),this.allTeamsByProject={},this.myTeamsByProject={}}getAllTeams(e){let t;if(e)(t=this.allTeamsByProject[e])||(t=this.pageContext.getRestClient("ICoreRestClient").getTeams(e,void 0,1e3),this.allTeamsByProject[e]=t);else{if(!this.allTeams){const e=this.pageContext.getRestClient("ICoreRestClient");this.allTeams=e.getAllTeams(void 0,1e3)}t=this.allTeams}return t}getMyTeams(e){let t;if(!e){if(!this.myTeams){const e=this.pageContext.getRestClient("ICoreRestClient");this.myTeams=e.getAllTeams(!0,1e3)}return this.myTeams}return(t=this.myTeamsByProject[e])||(t=this.pageContext.getRestClient("ICoreRestClient").getTeams(e,!0,1e3),this.myTeamsByProject[e]=t),t}getPageTeam(e=!1){const t=this.pageContext.getService("IVssContributionService").getData("ms.vss-tfs-web.team-data");if(t&&(t.explicit||!e))return t.team}}})}(),function(e){var r;t.LocalSettingsService={},function(e){e[e.Global=0]="Global",e[e.Collection=1]="Collection",e[e.Project=2]="Project",e[e.Team=3]="Team"}(r=t.LocalSettingsService.LocalSettingsScope||(t.LocalSettingsService.LocalSettingsScope={}));class s extends i.VssService{_serviceStart(e){this.pageContext=e,this.tfsPageDataService=e.getService("ITfsPageService")}write(e,t,s=r.Global){if(0===e.trim().length)return!1;const o=this._getScopedKey(e,s);if(o)try{return window.localStorage.setItem(o,JSON.stringify({v:t})),!0}catch(e){return console.error("Failed to write to local storage: "+e),!1}return!1}read(e,t,s=r.Global){if(0===e.trim().length)return;const o=this._getScopedKey(e,s);if(o)try{var i=window.localStorage.getItem(o);if(i&&"string"==typeof i)return JSON.parse(i).v}catch(e){console.warn("Failed to read from local storage: "+e)}return t}_getScopedKey(e,t){switch(t){case r.Global:return s.GLOBAL_SETTING_KEY+"/"+e;case r.Collection:const o=this.getCollectionId();return o?s.COLLECTION_SETTING_KEY+"/"+o+"/"+e:(console.warn("Collection scope requested for key '"+e+"' but no collection scope in context."),null);case r.Project:const i=this.getProjectId();return i?s.PROJECT_SETTING_KEY+"/"+i+"/"+e:(console.warn("Project scope requested for key '"+e+"' but no project scope in context."),null);case r.Team:const n=this.getTeamId();return n?s.TEAM_SETTING_KEY+"/"+n+"/"+e:(console.warn("Team scope requested for key '"+e+"' but no team scope in context."),null);default:return console.error("Local storage: unknown scope"),null}}getCollectionId(){const e=this.pageContext.getService("IVssPageService").getData();return e&&e.hostId}getProjectId(){const e=this.tfsPageDataService.getData();return e&&e.project&&e.project.id}getTeamId(){const e=this.tfsPageDataService.getHorizontalNavigationTeamData();return e&&e.id}}s.GLOBAL_SETTING_KEY="global",s.COLLECTION_SETTING_KEY="collection",s.PROJECT_SETTING_KEY="project",s.TEAM_SETTING_KEY="team",i.Services.add("ILocalSettingsService",{serviceFactory:s})}()},["Resources","TfsRestErrorHandlerService.types","ReauthenticationDialog","TfsRestErrorHandlerService","TfsProjectService","TfsTeamService","LocalSettingsService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-tfs-web.services-content"}}));