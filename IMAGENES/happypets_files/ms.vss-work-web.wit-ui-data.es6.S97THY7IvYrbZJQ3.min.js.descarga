"use strict";define("Wit/UI",["require","exports","react","prop-types","Wit/Common/Generated/Constants"],function(e,t,o,r,s){var i,n,a,m,d,c,I,h,p,l,_;i=t.ResourcesData={},t.ResourcesData.PagedWorkItemsList_NotInitialized="The work items list is not initialized.",t.ResourcesData.PagedWorkItemsList_ItemIndexOutOfRange="The work item index out of range.",function(e){n=t.Client={},t.Client.isWorkItemIdType=function(e){return"number"==typeof e}}(),function(e){a=t.ComponentProvidersBaseProviderBaseProviderComponent={};class s extends o.Component{constructor(e,t){super(e,t),this._componentMounted=!1}componentDidMount(){this._componentMounted=!0}componentWillUnmount(){this._componentMounted=!1}componentMounted(){return this._componentMounted}}t.ComponentProvidersBaseProviderBaseProviderComponent.BaseProviderComponent=s,s.propTypes={children:r.func.isRequired}}(),m=t.ComponentProvidersBaseProviderindex={},__exportStar(a,t.ComponentProvidersBaseProviderindex),function(e){d=t.ComponentProvidersWorkItemStateProvider={};t.ComponentProvidersWorkItemStateProvider.WorkItemStateProvider=class extends a.BaseProviderComponent{constructor(e){super(e),this._setStateFromProps()}render(){const{stateAndColor:e}=this.state;if(!e)return null;const{children:t}=this.props;return t?t(e):null}componentDidMount(){var e;super.componentDidMount(),(null===(e=this.state.stateAndColor)||void 0===e?void 0:e.fill)||this._initializeStateColor()}componentDidUpdate(e){this._didPropsChange(e)&&this._setStateFromProps()}shouldComponentUpdate(e,t){return this._didPropsChange(e)||t.stateInfo!==this.state.stateInfo||t.stateAndColor!==this.state.stateAndColor}_didPropsChange(e){return e.dataSource!==this.props.dataSource||e.dataProvider!==this.props.dataProvider}_setStateFromProps(){const e=this._getStateInfo(this.props.dataSource);if(e instanceof Promise)e.then(e=>{this.componentMounted()&&(this.setState({stateInfo:e}),this._initializeStateColor())},()=>{}),this.componentMounted()||(this.state={stateInfo:null,stateAndColor:null});else if(this.componentMounted())this._initializeStateColor(e);else{let t=null;if(e){const o=this.props.dataProvider.getWorkItemStateAndColor(e.projectIdOrName,e.workItemTypeName,e.stateName);o instanceof Promise||(t=o)}this.state={stateInfo:e,stateAndColor:null!=t?t:e?{name:e.stateName}:null}}}_getStateInfo(e){return e?(0,n.isWorkItemIdType)(e)?this.props.dataProvider.getWorkItem(e).then(e=>e?this._createStateInfoFromWorkItem(e):null):void 0!==e.stateName?e:this._createStateInfoFromWorkItem(e):null}_createStateInfoFromWorkItem(e){return{stateName:e.fields[s.CoreFieldRefNames.State],projectIdOrName:e.fields[s.CoreFieldRefNames.TeamProject],workItemTypeName:e.fields[s.CoreFieldRefNames.WorkItemType]}}async _initializeStateColor(e){const t=e||this.state.stateInfo;if(t)try{const{projectIdOrName:e,workItemTypeName:o,stateName:r}=t,{dataProvider:s}=this.props,i=await s.getWorkItemStateAndColor(e,o,r);this.componentMounted()&&this.setState({stateAndColor:i})}catch(e){this.componentMounted()&&this.setState({stateAndColor:{name:t.stateName}})}}}}(),function(e){c=t.ComponentProvidersWorkItemTypeIconProvider={};t.ComponentProvidersWorkItemTypeIconProvider.WorkItemTypeIconProvider=class extends a.BaseProviderComponent{constructor(e){super(e);const{dataSource:t}=this.props,o=(0,n.isWorkItemIdType)(t)?null:this._getTypeInfo(t);let r=null;if(o){const t=e.dataProvider.getWorkItemTypeColorAndIcon(o.projectIdOrName,o.workItemTypeName);t instanceof Promise||(r=t)}this.state={workItemTypeInfo:o,colorAndIcon:r}}render(){const{colorAndIcon:e}=this.state;if(!e)return null;const{children:t}=this.props;return t?t(e):null}componentDidMount(){super.componentDidMount();const{workItemTypeInfo:e,colorAndIcon:t}=this.state;t||(e?this._initializeIcon():this._updateColorAndIconFromProps())}componentDidUpdate(e,t){this._needToUpdateColorAndIcon(e.dataSource,this.props.dataSource)&&this._updateColorAndIconFromProps()}_updateColorAndIconFromProps(){const e=this._getTypeInfo(this.props.dataSource);e instanceof Promise?(e.then(e=>{this.componentMounted()&&this.setState({workItemTypeInfo:e},()=>{this._initializeIcon()})},()=>{}),this.state={workItemTypeInfo:null,colorAndIcon:null}):this.setState({workItemTypeInfo:e,colorAndIcon:null},()=>{this._initializeIcon()})}_getTypeInfo(e){return e?(0,n.isWorkItemIdType)(e)?this.props.dataProvider.getWorkItem(e).then(e=>e?this._createTypeInfoFromWorkItem(e):null):void 0!==e.projectIdOrName?e:this._createTypeInfoFromWorkItem(e):null}_createTypeInfoFromWorkItem(e){return{projectIdOrName:e.fields[s.CoreFieldRefNames.TeamProject],workItemTypeName:e.fields[s.CoreFieldRefNames.WorkItemType]}}_needToUpdateColorAndIcon(e,t){if(!e&&!t)return!1;if(!e||!t||(0,n.isWorkItemIdType)(e)&&e!==t)return!0;{const o=this._getTypeInfo(e),r=this._getTypeInfo(t);if(o.workItemTypeName!==r.workItemTypeName||o.projectIdOrName!==r.projectIdOrName)return!0}return!1}async _initializeIcon(){const{workItemTypeInfo:e}=this.state;if(!e)return;const{projectIdOrName:o,workItemTypeName:r}=e;try{const{dataProvider:e}=this.props,s=await e.getWorkItemTypeColorAndIcon(o,r);this.componentMounted()&&this.setState({colorAndIcon:s})}catch(e){this.componentMounted()&&this.setState({colorAndIcon:Object.assign(Object.assign({},t.WorkItemTypeIcon.DEFAULT_WORKITEMTYPE_COLOR_AND_ICON),{workItemTypeName:r})})}}}}(),I=t.ComponentProvidersindex={},__exportStar(d,t.ComponentProvidersindex),__exportStar(c,t.ComponentProvidersindex),function(e){var o;h=t[e]={},function(e){e[e.Ids=0]="Ids",e[e.Wiql=1]="Wiql",e[e.WorkItems=2]="WorkItems"}(o=t[e].ItemsSourceType||(t[e].ItemsSourceType={}));class r{constructor(e,t,i,n,a,m){this._context=e,this._itemsSource=t,this._workItemsCache=i,this._pageSize=n,this._projectIdOrName=a,this._fieldRefNames=m,this._getWorkItemsPromises={},this._itemsSource=this._itemsSource.slice(0),this._itemsSourceType=r.getItemsSourceType(this._itemsSource),this._itemsSourceType===o.WorkItems?this._itemsData=this._itemsSource:this._itemsData=null,m&&(this._fieldRefNames=[...m,s.CoreFieldRefNames.TeamProject,s.CoreFieldRefNames.WorkItemType])}static getItemsSourceType(e){return e instanceof Array?e.length<=0?o.WorkItems:(0,n.isWorkItemIdType)(e[0])?o.Ids:o.WorkItems:o.Wiql}isFirstPageReady(){return!(!this._itemsData||0!==this._itemsData.length&&!this._itemsData[0])}async ensureFirstPage(){this._itemsSourceType!==o.WorkItems&&await this._pageWorkItems(0)}async loadItemPage(e){this._itemsSourceType!==o.WorkItems&&await this._pageWorkItems(e)}async _ensureWorkItemIds(){if(!this._workItemIds){if(this._itemsSourceType===o.Ids)this._workItemIds=this._itemsSource;else if(this._itemsSourceType===o.Wiql){if(!this._getQueryResultPromise){const e={query:this._itemsSource},t=this._context.getRestClient("IWorkItemTrackingRestClient");this._getQueryResultPromise=t.queryByWiql(e,this._projectIdOrName)}const e=await this._getQueryResultPromise;this._workItemIds||(this._workItemIds=e.workItems.map(e=>e.id),this._getQueryResultPromise=null)}if(this._workItemIds&&!this._itemsData){this._itemsData=[],this._itemsData.length=this._workItemIds.length;for(let e=0;e<this._itemsData.length;e++)this._itemsData[e]=null}}}async _pageWorkItems(e){if(await this._ensureWorkItemIds(),!this._workItemIds||!this._itemsData||this._workItemIds.length!==this._itemsData.length)throw new Error(i.PagedWorkItemsList_NotInitialized);const{length:t}=this._workItemIds;if(e<0||t>0&&e>=t)throw new Error(i.PagedWorkItemsList_ItemIndexOutOfRange);if(0===t)return;if(this._itemsData[e])return;const o=this._pageSize,r=Math.floor(e/o)*o,s=Math.min(r+o,t)-1,n=this._workItemIds.filter((e,t)=>{const o=!this._workItemsCache[e];return t>=r&&t<=s&&o});let a=[];const m=`${r}_${s}`;if(n&&n.length>0)if(this._getWorkItemsPromises[m])a=await this._getWorkItemsPromises[m];else{const e=this._context.getRestClient("IWorkItemTrackingRestClient");this._getWorkItemsPromises[m]=e.getWorkItems(n,this._projectIdOrName,this._fieldRefNames,void 0,this._fieldRefNames?3:4,2),a=await this._getWorkItemsPromises[m],delete this._getWorkItemsPromises[m]}if(this._itemsData[e])return;const d={};a.forEach(e=>{d[e.id]=e});for(let e=r;e<=s;e++){const t=this._workItemIds[e],o=d[t];o?(this._itemsData[e]=o,this._workItemsCache[t]=o):this._workItemsCache[t]?this._itemsData[e]=this._workItemsCache[t]:this._itemsData[e]=null}}getAllItems(){return this._itemsData}}t[e].PagedWorkItemsList=r}("PagedWorkItemsListPagedWorkItemsList"),p=t.PagedWorkItemsListindex={},__exportStar(h,t.PagedWorkItemsListindex),function(e){l=t[e]={},t[e].DEFAULT_WORKITEM_PAGE_SIZE=200;t[e].WorkItemTrackingDataProvider=class{constructor(e,t,o){this._context=e,this._defaultProjectIdOrName=t,this._fieldRefNames=o,this._cachedWorkItemPromises={},this._workItemsCache={}}getWorkItemTypeColorAndIcon(e,o){return this._context.getService(t.Servicesindex.WorkItemTypeIconMetadataServiceId).getWorkItemIcon(e,o)}getWorkItemStateAndColor(e,o,r){return this._context.getService(t.Servicesindex.WorkItemStateColorMetadataServiceId).getWorkItemStateColor(e,o,r)}async getWorkItem(e){if(this._workItemsCache[e])return this._workItemsCache[e];try{if(!this._cachedWorkItemPromises[e]){const t=this._context.getRestClient("IWorkItemTrackingRestClient");this._cachedWorkItemPromises[e]=t.getWorkItem(e,this._defaultProjectIdOrName,void 0,void 0,4)}return this._workItemsCache[e]=await this._cachedWorkItemPromises[e],delete this._cachedWorkItemPromises[e],this._workItemsCache[e]||null}catch(e){return null}}getPagedWorkItemsList(o,r=t[e].DEFAULT_WORKITEM_PAGE_SIZE){return new p.PagedWorkItemsList(this._context,o,this._workItemsCache,r,this._defaultProjectIdOrName,this._fieldRefNames)}getFieldReferenceNames(){return this._fieldRefNames}_getProjectWorkItemTypeKey(e,t){return`${e}_${t}`.toLocaleLowerCase()}}}("DataProvidersWorkItemTrackingDataProvider"),_=t.DataProvidersindex={},__exportStar(l,t.DataProvidersindex),t.Data={},__exportStar(n,t.Data),__exportStar(I,t.Data),__exportStar(m,t.Data),__exportStar(_,t.Data),__exportStar(p,t.Data)},["Resources.Data","Client","ComponentProviders/BaseProvider/BaseProviderComponent","ComponentProviders/BaseProvider/index","ComponentProviders/WorkItemStateProvider","ComponentProviders/WorkItemTypeIconProvider","ComponentProviders/index","PagedWorkItemsList/PagedWorkItemsList","PagedWorkItemsList/index","DataProviders/WorkItemTrackingDataProvider","DataProviders/index","Data"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.wit-ui-data"}}));