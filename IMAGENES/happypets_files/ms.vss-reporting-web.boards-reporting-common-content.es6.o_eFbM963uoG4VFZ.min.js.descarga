"use strict";define("Reporting/BoardsCommon",["require","exports","VSS/Platform/Feature","VSS/Platform/FPS","VSS/Platform/Location","VSS/Platform/Navigation","VSS/Core/Observable","VSS/Platform/Context","Analytics/Boards/BoardsQueries/BacklogsQuery","VSS/Platform/Util/Url","react","VSS/Platform/Components/Format","VSS/Platform/Layout","VSSUI/ZeroData","VSSUI/MessageCard","VSSUI/Spinner","Analytics/Common/Utilities/AnalyticsExceptionUtilities","Reporting/ReportWidgetHost/ReportWidgetHost","VSS/Platform/Trace","VSSUI/Header","VSSUI/Util","VSS/Core/Util/String","VSSUI/Button","VSSUI/Observer","VSSUI/TeachingBubble","Analytics/Boards/BoardsQueries/AggregationFieldsQuery","Analytics/Boards/BoardsQueries/ProcessesQuery","VSSUI/Dropdown","VSSUI/Utilities/DropdownSelection","WidgetCommon/ModernWidgetTypes/CommonConfigurationTypes"],function(e,t,r,i,o,s,n,a,l,u,c,g,d,m,h,p,b,y,B,S,f,R,v,T,P,k,x,C,w,A){var U,D,E,I,N,L,V;U=t.Resources={},t.Resources.AggregationPicker_CountOfWorkItems="Count of Work Items",t.Resources.AggregationPicker_SumOfNamedProperty="Sum of {0}",t.Resources.InfoIcon="Info icon for {0}",t.Resources.DataNotReadyImageDescription="A worker shaking data from a cloud into a machine producing a graphs",t.Resources.DataNotFoundImageDescription="A picture of a man looking out a telescope",t.Resources.UnmaterializedBoardHeader="Board information not found",t.Resources.UnmaterializedBoardDetail="Information about the selected boards category for this team could not be found. Have you visited the corresponding boards page yet?",t.Resources.GoToBoard="Go to board",t.Resources.AccessDeniedSummary="Analytics view permission required",t.Resources.AccessDeniedDetail='Using this service requires "View Analytics" permission. Instructions on how to configure it can be found {0}. Changing the permissions requires administrator rights to the associated project.',t.Resources.AccessDeniedMoreInfoDocLink="https://go.microsoft.com/fwlink/?LinkId=786441",t.Resources.AccessDeniedLinkText="here",t.Resources.NoPermissionImageDescription="A dog sitting outside a closed door on a snowy day",t.Resources.ValueMustBeWithinRange="Value must be between {0} and {1}",t.Resources.TeachingBubbleLearnMoreButtonText="Learn more",t.Resources.TeachingBubbleLearnMoreButtonDescriptiveText="Learn more about {0}",t.Resources.TeachingBubbleNextButtonText="Next",t.Resources.TeachingBubblePreviousButtonText="Previous",t.Resources.TeachingBubbleEndTourButtonText="End tour",t.Resources.ResetLabel="Reset",t.Resources.ResetButtonDetail="Reset to report defaults",function(e){function n(){return window.location.href.indexOf("_backlogs")>=0}function a(){return n()?"ms.vss-work-web.backlogs-content-route":"ms.vss-work-web.team-board-content-route"}D=t.BoardsRoutingHelper={},t.BoardsRoutingHelper.isBacklogsPage=n,t.BoardsRoutingHelper.chooseAnalyticsRootRoute=a,t.BoardsRoutingHelper.getBoardsAnalyticsRootUrl=function(e){const t=(0,s.getCurrentRoute)(e),r={project:t.routeValues.project,teamName:t.routeValues.teamName,pivot:"analytics"},i=a();return(0,o.routeUrl)(e,i,r)},t.BoardsRoutingHelper.getBoardsReportUrl=function(e,t,i){const a=(0,s.getCurrentRoute)(e),l={project:a.routeValues.project,teamName:a.routeValues.teamName,backlogLevel:t,pivot:"analytics"};null!=i&&(l.report=i);const u=n()?(0,r.isFeatureEnabled)(e,"ms.vss-work-web.new-boards-hub-feature",!1)?"ms.vss-work-web.new-backlogs-content-route":"ms.vss-work-web.backlogs-content-route":"ms.vss-work-web.team-board-content-route";return(0,o.routeUrl)(e,u,l)},t.BoardsRoutingHelper.getSprintsReportUrl=function(e){const t=(0,s.getCurrentRoute)(e),i={project:t.routeValues.project,teamName:t.routeValues.teamName,iteration:t.routeValues.iteration,pivot:"analytics"},n=(0,r.isFeatureEnabled)(e,"ms.vss-work-web.new-boards-hub-feature",!1)?"ms.vss-work-web.new-sprints-content-route":"ms.vss-work-web.sprints-content-route";return(0,o.routeUrl)(e,n,i)},t.BoardsRoutingHelper.getNavigateToBoardHandler=function(e){return()=>{const t=(0,s.getCurrentRoute)(e),r={project:t.routeValues.project,teamName:t.routeValues.teamName,backlogLevel:t.routeValues.backlogLevel,pivot:"board"},n=(0,o.routeUrl)(e,"ms.vss-work-web.team-board-content-route",r);(0,i.FastPageSwitch)(e,n,!0)}}}(),function(e){t.BoardsReportingHeaderBreadcrumbService={};class r extends a.VssService{constructor(){super(...arguments),this.items=new n.ObservableArray}getBreadcrumbItems(e){return this.items.push({key:"analytics",text:"Analytics",href:(0,D.getBoardsAnalyticsRootUrl)(this.pageContext)}),this.items}}t.BoardsReportingHeaderBreadcrumbService.BoardsReportingHeaderBreadcrumbService=r,a.Services.add("boards-reporting-header-breadcrumb-service",{serviceFactory:r})}(),t.PickersWorkItemBacklogFilter={},function(e){async function r(e){const t=e.getService("IVssContributionService");return(await t.getDataAsync("ms.vss-work-web.agile-backlog-configuration-data-provider")).taskBacklog.id}t.PickersBacklogCategoryPickerHelpers={},t.PickersBacklogCategoryPickerHelpers.getTaskBacklogCategoryReferenceName=r,t.PickersBacklogCategoryPickerHelpers.ensureWorkItemFilter=async function(e,t){let i;i=null!=t?t:{identifier:"BacklogCategory",settings:await r(e)};return i}}(),function(e){function r(e,t){const r=(0,s.getCurrentRoute)(e).routeValues;return void 0!==r[t]?r.backlogLevel:new u.Uri(window.location.href).getQueryParam(t)}t.ReportPageState={},t.ReportPageState.getReportPageState=async function(e){const t=e.getService("ITfsPageService"),i=await t.getData().project,o=await t.getHorizontalNavigationTeamData(),s=e.getService("IDashboardsCacheableQueryService"),n=new l.BacklogsQuery(i.id,[o.id]),a=await s.getCacheableQueryResult(n),u=r(e,"backlogLevel"),c=a.findIndex(e=>e.BoardName===u&&e.IsBoardVisible);return{teamId:o.id,teamName:o.name,projectId:i.id,categoryReferenceName:c>=0&&a[c].BoardCategoryReferenceName||"",categoryName:u}},t.ReportPageState.extractParameter=r}(),function(e){t.ReportQueryHelper={},t.ReportQueryHelper.resetQueryCache=function(e){e.getService("IDashboardsCacheableQueryService").resetCache()}}(),function(e){function r(r,i,o){const s=r.getService("IVssTelemetryService"),n=Object.assign({isEmptyState:!1},o);s.publishEvent(t[e].telemetryAreaName,i,n)}E=t[e]={},t[e].telemetryAreaName="Analytics-Reports",t[e].publishEmptyReportTelemetry=function(e,t,i){r(e,t,{isEmptyState:!0,emptyStateReason:i})},t[e].publishReportTelemetry=r,t[e].publishTeachingBubbleTelemetry=function(r,i,o){const s=r.getService("IVssTelemetryService"),n=Object.assign({isEmptyState:!1},o);s.publishEvent(t[e].telemetryAreaName,i,n)}}("ReportTelemetry"),function(e){I=t.AccessDeniedMessage={};t.AccessDeniedMessage.AccessDeniedMessage=class extends d.VssComponent{constructor(){super(...arguments),this.linkUrl="https://go.microsoft.com/fwlink/?LinkId=786441"}render(){return c.createElement(m.ZeroData,{primaryText:U.AccessDeniedSummary,secondaryText:c.createElement(g.FormatComponent,{format:U.AccessDeniedDetail},c.createElement("a",{href:this.linkUrl},U.AccessDeniedLinkText)),imageAltText:U.NoPermissionImageDescription,imagePath:(0,o.getAssetLocation)(this.context.pageContext,"ms.vss-reporting-web/boards-reporting-common-content/images/no-permission.svg")})}}}(),function(e){N=t.ReportError={};t.ReportError.ReportError=class extends c.Component{render(){return c.createElement(h.MessageCard,{severity:"Error"},this.props.errorMessage)}}}(),function(e){L=t.ReportLoading={};t.ReportLoading.ReportLoading=class extends c.Component{render(){return c.createElement(p.Spinner,null)}}}(),function(e){t.BoardsReport={};t.BoardsReport.BoardsReport=class extends d.VssComponent{constructor(){super(...arguments),this.getTeamContext=(()=>(null!=this.lastTeamContext&&this.lastTeamContext.id==this.props.teamId&&this.lastTeamContext.name==this.props.teamName||(this.lastTeamContext={id:this.props.teamId,name:this.props.teamName}),this.lastTeamContext))}getWidgetName(){return this.getReportTitle()}render(){if(this.isMinimalReport())return this.renderMinimalReport();this.initializeOnRender();const e=this.isLightbox()?this.renderLightboxReportContents():this.renderReportContents(),t=this.isLightbox()?"":"bolt-page-grey";return c.createElement("div",{className:(0,f.css)("boards-widget-report",t)},this.getTitleBlock(),e,!this.isReady()&&!this.isInAbnormalState()&&c.createElement(L.ReportLoading,null),this.state.error&&c.createElement(N.ReportError,{errorMessage:this.state.error}),this.state.knownWarning&&this.renderConfigurationWarning())}isReady(){return null!=this.state.widgetSettings}getFilterRow(e){return c.createElement("div",{className:"report-filter-area flex-self-center"},c.createElement("div",{className:"report-filter-area-content flex-row"},e))}getWidgetContent(){return this.isConfigurationValid()?c.createElement(y.ReportWidgetHostContainer,{settings:JSON.stringify(this.state.widgetSettings),name:this.getWidgetName(),parentPageName:this.getParentPagePrefix()+this.getReportTelemetryName(),contributionId:this.getWidgetContributionId(),renderSize:this.getSize(),widgetPinningSize:this.getWidgetPinningSize(),allowPinning:this.allowPinning(),teamContext:this.getTeamContext(),lastRefreshDate:this.getLastRefreshDate()}):null}renderMinimalReport(){return this.isReady()||this.isInAbnormalState()?this.isInAbnormalState()?this.renderConfigurationWarning():this.getWidgetContent():null}getTitleBlock(e){return c.createElement(S.Header,{titleSize:1,backButtonProps:this.getBackButtonProps(),title:c.createElement(c.Fragment,null,this.getReportTitle()," ",e),titleClassName:"boards-report-header-title"})}componentDidCatch(e,t){this.setState({error:e.toString()}),(0,B.traceException)(this.context.pageContext,E.telemetryAreaName,this.getReportTelemetryName(),e)}isInAbnormalState(){return null!=this.state.error||null!=this.state.knownWarning}getLastRefreshDate(){}isMinimalReport(){return!1}isLightbox(){return!1}getDefaultState(){return{widgetSettings:void 0,error:void 0,knownWarning:void 0}}renderConfigurationWarning(){let e;return null!==(e=this.state.knownWarning!==U.AccessDeniedSummary||this.isMinimalReport()?this.getKnownWarningComponent():c.createElement(I.AccessDeniedMessage,null))?e:c.createElement(N.ReportError,{errorMessage:this.state.knownWarning})}handleCommonInitError(e){(0,b.recognizeAnalyticsException)(e)===b.AnalyticsExceptionType.MissingAnalyticsPermissions?this.setState({knownWarning:U.AccessDeniedSummary}):(this.setState({error:e.toString()}),(0,B.traceException)(this.context.pageContext,E.telemetryAreaName,this.getReportTelemetryName(),e))}getBackButtonProps(){}allowPinning(){return!0}getWidgetPinningSize(){return{columnSpan:3,rowSpan:2}}renderReportContents(){return this.isReady()?this.isInAbnormalState()?this.renderConfigurationWarning():c.createElement("div",{className:"boards-report-content"},this.getFilterRow(this.getFilterItems()),this.decorateWidgetContent(this.getWidgetContent()),this.renderTeachingBubble()):null}renderLightboxReportContents(){return this.isReady()?this.isInAbnormalState()?this.renderConfigurationWarning():c.createElement("div",{className:"boards-report-lightbox-content"},this.getWidgetContent(),this.renderTeachingBubble()):null}getSize(){return this.isMinimalReport()?{width:140,height:40}:this.isLightbox()?{width:1010,height:483}:{width:1010,height:670}}getParentPagePrefix(){return this.isMinimalReport()?"Header":this.isLightbox()?"Lightbox":""}}}(),function(e){V=t.ReportGuidedTourUtility={};class r{constructor(e,t,r){this.pageContext=e,this.tourUtilityProps=t,this.dismissBubble=r,this.tutorialDismissed=-1,this.teachingBubbleTourProps=[],this.activeTourStep=new n.ObservableValue(this.tutorialDismissed),this.titleBubbleCallback=(e=>{this.teachingBubbleTourProps.push({anchorElement:e,anchorOrigin:{horizontal:"center",vertical:"end"},primaryButtonProps:this.getLinkButton(),secondaryButtonProps:this.getNextButton(),title:this.tourUtilityProps.tourBubble.title,text:this.tourUtilityProps.tourBubble.text}),this.activeTourStep.value=0}),this.filterBubbleCallback=(e=>{this.teachingBubbleTourProps.push({anchorElement:e,anchorOrigin:{horizontal:"end",vertical:"end"},primaryButtonProps:this.getPreviousButton(),secondaryButtonProps:this.getNextButton(),title:this.tourUtilityProps.filterBubble.title,text:this.tourUtilityProps.filterBubble.text})}),this.chartBubbleCallback=(e=>{this.teachingBubbleTourProps.splice(1,0,{anchorElement:e,anchorOrigin:{horizontal:"start",vertical:"start"},primaryButtonProps:this.getPreviousButton(),secondaryButtonProps:this.getNextButton(),title:this.tourUtilityProps.chartBubble.title,text:this.tourUtilityProps.chartBubble.text}),this.teachingBubbleTourProps.push({anchorElement:e,anchorOrigin:{horizontal:"start",vertical:"end"},primaryButtonProps:this.getPreviousButton(),secondaryButtonProps:this.getDismissButton(),title:this.tourUtilityProps.legendBubble.title,text:this.tourUtilityProps.legendBubble.text})}),this.dismissTour=(()=>{this.dismissBubble(),(0,E.publishTeachingBubbleTelemetry)(this.pageContext,this.tourUtilityProps.reportKey,this.getTelemetryProps(this.activeTourStep.value,"Dismiss")),this.activeTourStep.value=this.tutorialDismissed,o(this.pageContext,this.tourUtilityProps.reportKey),this.render(!1)}),this.nextBubble=(()=>{this.activeTourStep.value<this.teachingBubbleTourProps.length-1&&((0,E.publishTeachingBubbleTelemetry)(this.pageContext,this.tourUtilityProps.reportKey,this.getTelemetryProps(this.activeTourStep.value,"Next")),this.activeTourStep.value++,this.render(!0))}),this.previousBubble=(()=>{this.activeTourStep.value>0&&((0,E.publishTeachingBubbleTelemetry)(this.pageContext,this.tourUtilityProps.reportKey,this.getTelemetryProps(this.activeTourStep.value,"Previous")),this.activeTourStep.value--,this.render(!0))}),this.publishLearnMoreClickTelemetry=(()=>{(0,E.publishTeachingBubbleTelemetry)(this.pageContext,this.tourUtilityProps.reportKey,this.getTelemetryProps(this.activeTourStep.value,"LearnMore"))})}render(e){return c.createElement(c.Fragment,null,e&&c.createElement(T.Observer,{activeBubble:this.activeTourStep},e=>e.activeBubble!==this.tutorialDismissed?c.createElement(P.TeachingBubble,Object.assign({},this.teachingBubbleTourProps[e.activeBubble],{onDismiss:this.dismissTour})):null))}getLinkButton(){return{text:U.TeachingBubbleLearnMoreButtonText,target:"_blank",href:this.tourUtilityProps.reportDocumentationUrl,onClick:this.publishLearnMoreClickTelemetry,role:"link",ariaLabel:(0,R.format)(U.TeachingBubbleLearnMoreButtonDescriptiveText,this.tourUtilityProps.tourBubble.title)}}getDismissButton(){return{text:U.TeachingBubbleEndTourButtonText,primary:!0,onClick:this.dismissTour}}getNextButton(){return{text:U.TeachingBubbleNextButtonText,primary:!0,onClick:this.nextBubble}}getPreviousButton(){return{text:U.TeachingBubblePreviousButtonText,onClick:this.previousBubble}}getTelemetryProps(e,t){return{currentTeachingBubbleName:i[e],buttonAction:t}}}var i;async function o(e,t){const i=e.getService("ISettingsService"),o={};o[t+"/"+r.teachingBubbleSeenKey]=!0,await i.setEntries(o,0)}t.ReportGuidedTourUtility.ReportGuidedTourUtility=r,r.teachingBubbleSeenKey="ReportTourSeen",function(e){e[e.Dismiss=-1]="Dismiss",e[e.IntroBubble=0]="IntroBubble",e[e.ChartBubble=1]="ChartBubble",e[e.FilterBubble=2]="FilterBubble",e[e.LegendBubble=3]="LegendBubble"}(i||(i={})),t.ReportGuidedTourUtility.saveUserBubbleSettings=o,t.ReportGuidedTourUtility.hasUserSeenBubble=async function(e,t){const i=e.getService("ISettingsService");return(await i.getEntriesAsync(t,0))[r.teachingBubbleSeenKey]},t.ReportGuidedTourUtility.getInfoIcon=function(e,t,r,i){return r?c.createElement("span",{ref:e},c.createElement(v.Button,{className:"boards-report-info-icon subtle",ariaLabel:(0,R.format)(U.InfoIcon,i),iconProps:{iconName:"Unknown"},onClick:t})):null}}(),function(e){t.LightboxReportGuidedTourUtility={};t.LightboxReportGuidedTourUtility.LightboxReportGuidedTourUtility=class{constructor(e,t,r){this.pageContext=e,this.tourUtilityProps=t,this.dismissBubble=r,this.tutorialDismissed=-1,this.activeTourStep=new n.ObservableValue(this.tutorialDismissed),this.titleBubbleCallback=(e=>{this.teachingBubbleTourProps={anchorElement:e,anchorOrigin:{horizontal:"center",vertical:"end"},title:this.tourUtilityProps.tourBubble.title,text:this.tourUtilityProps.tourBubble.text,onDismiss:this.dismissTour},this.activeTourStep.value=0}),this.dismissTour=(()=>{this.dismissBubble(),this.activeTourStep.value=this.tutorialDismissed,(0,V.saveUserBubbleSettings)(this.pageContext,this.tourUtilityProps.reportKey),this.render(!1)})}render(e){return c.createElement(c.Fragment,null,e&&c.createElement(T.Observer,{activeBubble:this.activeTourStep},e=>e.activeBubble!==this.tutorialDismissed?c.createElement(P.TeachingBubble,Object.assign({},this.teachingBubbleTourProps)):null))}},t.LightboxReportGuidedTourUtility.getInfoIcon=function(e,t,r,i){return r?c.createElement("span",{ref:e},c.createElement(v.Button,{className:"boards-report-info-icon subtle",ariaLabel:(0,R.format)(U.InfoIcon,i),iconProps:{iconName:"Unknown"},onClick:t})):null}}(),function(e){t[e]={};function r(e){return e.identifier===A.AggregationMode.Sum?A.AggregationMode[e.identifier]+"_"+e.settings:A.AggregationMode[e.identifier]}async function i(e,t,r,i,s){const n=await async function(e,t,r,i,o){const s=e.getService("IDashboardsCacheableQueryService");return(await s.getCacheableQueryResult(x.ProcessesQuery.onTeam(e,t,r).setAutomationMode(o))).filter(e=>i.some(t=>e.BacklogCategoryReferenceName===t)).map(e=>e.WorkItemType)}(e,t,r,i,s);return o(e,t,n,s)}async function o(e,t,i,o){const s=e.getService("IDashboardsCacheableQueryService"),n=new k.AggregationFieldsQuery(t).setAutomationMode(o),a={identifier:A.AggregationMode.Count,settings:""},l={id:r(a),text:U.AggregationPicker_CountOfWorkItems,data:a},u=(0,k.getDistinctFieldsOfTypes)(i,await s.getCacheableQueryResult(n)).map(e=>{const t={identifier:A.AggregationMode.Sum,settings:e.FieldReferenceName};return{id:r(t),text:(0,R.format)(U.AggregationPicker_SumOfNamedProperty,e.FieldName),data:t}});return[l].concat(u)}t[e].AggregationPicker=class extends d.VssComponent{constructor(){super(...arguments),this.selection=new w.DropdownSelection,this.onSelect=((e,t)=>{this.props.onSelect(t.data)})}componentDidMount(){this.applySelection(this.props)}componentWillReceiveProps(e){JSON.stringify(e)!=JSON.stringify(this.props)&&this.applySelection(e)}render(){return c.createElement(C.Dropdown,{className:"aggregation-picker",items:this.props.items,selection:this.selection,onSelect:this.onSelect,showFilterBox:this.props.items.length>7})}applySelection(e){const t=r(e.value),i=e.items.findIndex(e=>e.id===t);i>=0?this.selection.select(i,1,!1):this.selection.clear()}},t[e].getAggregationOptions=async function(e,t,r,s,n){let a;return a="BacklogCategory"===s.identifier?i(e,t,r,[s.settings],n):o(e,t,[s.settings],n)},t[e].ensureAggregationSettings=function(e,t){let r={identifier:A.AggregationMode.Count,settings:""};return null==t||t.identifier!==A.AggregationMode.Count&&!e.some(e=>t.settings===e.data.settings)?e.some(e=>"Microsoft.VSTS.Scheduling.RemainingWork"===e.data.settings)&&(r={identifier:A.AggregationMode.Sum,settings:"Microsoft.VSTS.Scheduling.RemainingWork"}):r=t,r},t[e].getAggregationOptionsForBacklogCategories=i,t[e].getAggregationOptionsForWorkItemTypes=o}("PickersAggregationPicker"),function(e){t.ResetElement={};t.ResetElement.ResetElement=class extends c.Component{render(){return c.createElement(v.Button,{className:"reset-settings-button subtle",ariaLabel:U.ResetButtonDetail,onClick:this.props.onClick,text:U.ResetLabel,disabled:!this.props.isEnabled,tooltipProps:{text:U.ResetButtonDetail}})}}}(),function(e){t.UnmaterializedBoardMessage={};t.UnmaterializedBoardMessage.UnmaterializedBoardMessage=class extends d.VssComponent{constructor(e,t){super(e,t),this.navigateTo=(0,D.getNavigateToBoardHandler)(t.pageContext)}render(){return c.createElement(m.ZeroData,{primaryText:U.UnmaterializedBoardHeader,secondaryText:c.createElement("span",null,U.UnmaterializedBoardDetail),imageAltText:U.DataNotFoundImageDescription,imagePath:(0,o.getAssetLocation)(this.context.pageContext,"ms.vss-reporting-web/boards-reporting-common-content/images/data-not-found.svg"),actionText:U.GoToBoard,actionType:0,onActionClick:this.navigateTo})}}}()},["Resources","BoardsRoutingHelper","BoardsReportingHeaderBreadcrumbService","Pickers/WorkItemBacklogFilter","Pickers/BacklogCategoryPickerHelpers","ReportPageState","ReportQueryHelper","ReportTelemetry","AccessDeniedMessage","ReportError","ReportLoading","BoardsReport","ReportGuidedTourUtility","LightboxReportGuidedTourUtility","Pickers/AggregationPicker","ResetElement","UnmaterializedBoardMessage"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-reporting-web.boards-reporting-common-content"}}));