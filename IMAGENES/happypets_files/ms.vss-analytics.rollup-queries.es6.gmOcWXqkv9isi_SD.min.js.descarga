"use strict";define("Analytics/Boards/RollupQueries",["require","exports","Analytics/Boards/BoardsQueries/WitFieldUtilities","Analytics/Common/AnalyticsCacheableQueryBase","Analytics/Common/Utilities/QueryUtilities"],function(e,t,r,s,a){var o,i,n;o=t.Contracts={},(n=t.Contracts.RollupType||(t.Contracts.RollupType={}))[n.Progress=0]="Progress",n[n.Total=1]="Total",(i=t.Contracts.RollupAggregation||(t.Contracts.RollupAggregation={}))[i.Count=1]="Count",i[i.Sum=2]="Sum",function(e){t.RollupQuery={};class i extends s.AnalyticsCacheableQueryBase{constructor(e,t,r,s,a){super(i.commandName,i.generateQueryOptions(e,t,r,s,a)),this.workItemIds=e,this.rollupMetric=t,this.projectId=r,this.backlogWorkItemTypes=s,this.syncDateConditions=a}static generateQueryOptions(e,t,r,s,o){const n=i.getMultiFilterClause("WorkItemId",e),l=`Descendants(${i.getDescendantsApplyClause(t,s)})`;return{entityType:"WorkItems",oDataVersion:a.latestODataVersion,project:r,batchRequestMode:1,$filter:n,$select:"WorkItemId",$expand:l,getProviderSyncDates:!0,expectSinglePage:e.length<i.axServerPageSize,syncDateConditions:o,getBatchResponseInnerHeaders:!!o}}static getMultiFilterClause(e,t){let r="";return t&&t.forEach(t=>{"string"==typeof t&&(t=`'${t}'`),r?r+=` or ${e} eq ${t}`:r=`${e} eq ${t}`}),r}static getDescendantsApplyClause(e,t){let r="";e.backlogFilter?r=i.getMultiFilterClause("WorkItemType",t):e.workItemTypeFilter&&(r=i.getMultiFilterClause("WorkItemType",[e.workItemTypeFilter]));const s="$apply=filter(StateCategory ne null"+(r?` and ${r})`:")"),a=i.getAggregateClause(e);if(e.type===o.RollupType.Progress){return[s,"compute(StateCategory eq 'Completed' as isCompleted)",`groupby((isCompleted), ${a})`].join("/")}return[s,a].join("/")}static getAggregateClause(e){let t="aggregate(";switch(e.aggregation){case o.RollupAggregation.Sum:if(!e.aggregationField)throw new Error("Missing aggregation field");return t+=`${r.WitFieldUtilities.getFieldODataPropertyName(e.aggregationField)} with sum as Sum)`;case o.RollupAggregation.Count:default:return t+="$count as Count)"}}getQueryName(){return`RollupQuery${JSON.stringify(this.workItemIds)}${JSON.stringify(this.rollupMetric)}`}interpretQueryResults(e){const t={results:e.value,syncDates:{}},r=e["@vsts.warnings"];if(r){let e="";r.some(t=>{if(0===t.indexOf("ProviderSyncDates:"))return e=t.substring("ProviderSyncDates:".length),!0});let s=[],a=null,o=null;try{s=JSON.parse(e)}catch(e){}for(const e of s){const t=Date.parse(e.ProviderSyncDate);"WorkItemRevision"===e.ProviderTableName?a=Math.min(t,a||t):"WorkItemLink"===e.ProviderTableName&&(o=Math.min(t,o||t))}a&&a>0&&(t.syncDates.workItemsChangedUtcTimestamp=a),o&&o>0&&(t.syncDates.workItemLinksChangedUtcTimestamp=o)}return t}inspectResponseFormat(e){e&&e.responseStatus&&"304"===e.responseStatus.StatusCode||super.inspectResponseFormat(e)}}t.RollupQuery.RollupQuery=i,i.commandName="RollupQuery",i.axServerPageSize=1e3}()},["Contracts","RollupQuery"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-analytics.rollup-queries"}}));