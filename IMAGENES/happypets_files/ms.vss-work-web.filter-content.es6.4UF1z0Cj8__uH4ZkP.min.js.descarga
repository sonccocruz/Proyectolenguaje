"use strict";define("Wit/Filter",["require","exports","VSS/Core/Observable","VSS/Core/TimerManagement","Wit/Common/Constants/CustomerInteligence","Wit/Common/Utilities/Core","Wit/Common/Generated/Constants","Wit/Common/Utilities/Array","react","VSS/Core/Util/String","VSS/Platform/Identity","VSS/Platform/Location","VSSUI/Dropdown","VSSUI/FilterBar","VSSUI/RadioButton","VSSUI/TextFilterBarItem","VSSUI/Utilities/DropdownSelection","VSSUI/Utilities/Filter","Wit/Identity/Utilities/WorkItemIdentityHelper","Wit/UI/IdentityConstants","Wit/Common/WiqlOperators","Wit/UI/IdentityView","Wit/UI/Services/index","Wit/UI/WorkItemState","Wit/UI/WorkItemTypeIcon"],function(e,t,r,i,s,a,n,o,l,c,d,h,u,p,f,m,g,_,v,F,S,I,y,T,P){var C,V,A,N,E,b,M,x,O,U;C=t.Resources={},t.Resources.AssignedToEmptyText="Unassigned",t.Resources.AndOperator="And",t.Resources.OrOperator="Or",t.Resources.Wiql_MacroMe="Me",t.Resources.UnparentedText="Unparented",V=t.ConstantsConstants={},t.ConstantsConstants.WITCIFilterFeature="ResultFilter",function(e){var a;A=t.FilterManager={},function(e){e.useAndOperator="useAndOperator",e.filterByTree="filterByTree"}(a||(a={})),function(e){e.children="children",e.tree="tree"}(t.FilterManager.IParentFilterOperators||(t.FilterManager.IParentFilterOperators={}));class n{constructor(e){this._filterProviders={},this._timerManagement=new i.TimerManagement,this._reset(),this._dataSource=e}activate(e){this._isActive||(this._isActive=!0,this._fireEvent(n.EVENT_FILTER_ACTIVATED),this._publishActivatedTelemetry(e))}deactivate(){this._isActive&&(this._isActive=!1,this._fireEvent(n.EVENT_FILTER_DEACTIVATED))}isActive(){return this._isActive}dataUpdated(){for(const e in this._filterProviders){this._filterProviders[e].dataUpdated()}this._fireEvent(n.EVENT_DATA_UPDATED)}isFiltering(){if(!this.isActive())return!1;let e=!1;for(const t in this._filterProviders){const r=this._filterProviders[t];e=e||r.isFiltering()}return e}registerFilterProvider(e,t){this._filterProviders[e]=t,t.bind(this._dataSource)}unregisterFilterProvider(e){delete this._filterProviders[e]}clearFilterProviders(){this._filterProviders={}}getFilterProvider(e){return this._filterProviders[e]}setFilters(e){if(this._clearAllFilters(),e)for(const t in e){const r=this._filterProviders[t];r&&r.setFilter(e[t])}this._fireFilterChanged()}getFilters(){const e={};for(const t in this._filterProviders){const r=this._filterProviders[t];if(r.isFiltering()){const i=r.getFilter();e[t]=i}}return e}setFilter(e,t){const r=this._getFilterProvider(e);r&&(r.setFilter(t),this._fireFilterChanged())}getFilter(e){const t=this._getFilterProvider(e);return t?t.getFilter():null}clearFilters(e){this.isFiltering()&&(e?this._filterProviders[e].clearFilters():this._clearAllFilters(),this._fireFilterChanged())}filter(e){const t=Date.now();if(!this.isFiltering())return this._dataSource.getIds();let r=null;for(let e in this._filterProviders){const t=this._filterProviders[e];t.isFiltering()&&(r=t.getMatchingItems(r))}return r||(r=[]),this._publishFilterTelemetry(r.length,Date.now()-t,e),r}itemMatchesFilters(e){this.isFiltering();let t=[e];for(let e in this._filterProviders){const r=this._filterProviders[e];r.isFiltering()&&(t=r.getMatchingItems(t))}return t.length>0}attachEvent(e,t){this._events||(this._events=new r.Observable),this._events.subscribe(t,e)}detachEvent(e,t){this._events&&this._events.unsubscribe(t,e)}getFilterDataSource(){return this._dataSource}_reset(){this.clearFilters()}_getFilterProvider(e){return this._filterProviders[e]}_clearAllFilters(){for(const e in this._filterProviders){this._filterProviders[e].clearFilters()}}_fireFilterChanged(){this.isActive()&&(this.isFiltering()?this._fireEvent(n.EVENT_FILTER_CHANGED):this._fireEvent(n.EVENT_FILTER_CLEARED))}_fireEvent(e,t){if(this._events){let t=!1;if(this._events.notify(e=>{if(!1===e)return t=!0,!0},e),t)return!1}}_publishActivatedTelemetry(e){e.getService("IVssTelemetryService").publishEvent(s.WITCustomerIntelligenceArea,V.WITCIFilterFeature,{experience:this._dataSource.getDataSourceName(),action:"ActivateFilter",totalCount:this._dataSource.getItemCount(),initialPagedCount:this._dataSource.getIds().length,columnsCount:(this._dataSource.getVisibleFields()||[]).length})}_publishFilterTelemetry(e,t,r){this._lastResultCount=e,this._lastDuration=t,this._filterTelemetryThrottleDelegate||(this._filterTelemetryThrottleDelegate=this._timerManagement.debounce(()=>{if(!this.isFiltering())return;r.getService("IVssTelemetryService").publishEvent(s.WITCustomerIntelligenceArea,V.WITCIFilterFeature,{experience:this._dataSource.getDataSourceName(),action:"Filter",totalCount:this._dataSource.getItemCount(),pagedCount:this._dataSource.getIds().length,columnsCount:(this._dataSource.getVisibleFields()||[]).length,resultCount:this._lastResultCount,activeFilterProviders:Object.keys(this.getFilters()),duration:this._lastDuration})},2e3,{leading:!1,trailing:!0})),this._filterTelemetryThrottleDelegate()}}t.FilterManager.FilterManager=n,n.EVENT_FILTER_CHANGED="filter-changed",n.EVENT_FILTER_CLEARED="filter-cleared",n.EVENT_FILTER_ACTIVATED="filter-activated",n.EVENT_FILTER_DEACTIVATED="filter-deactivated",n.EVENT_DATA_UPDATED="filter-data-updated",t.FilterManager.isFilterStateEmpty=function(e){return!e||!Object.keys(e).some(t=>{const r=e[t]&&e[t].values;return r&&r.length>0})},t.FilterManager.mapFilterStateToHistoryState=function(e){var t,r;const i={};for(const s of Object.keys(e)){const n=e[s];if(n.values.length<=0)continue;const o=n.values.map(e=>e.toString());let l="";(null===(t=n.options)||void 0===t?void 0:t.useAndOperator)?l=a.useAndOperator:(null===(r=n.options)||void 0===r?void 0:r.filterByTree)&&(l=a.filterByTree);const c=o.join(",");i[s]=l?`${c};${l}`:c}return i},t.FilterManager.mapHistoryStateToFilterState=function(e,t){const r={};for(const i of t){const t=e[i];if(!t)continue;const s=t.split(";"),n={values:s[0].split(",")};s[1]===a.useAndOperator?n.options={useAndOperator:!0}:s[1]===a.filterByTree&&(n.options={filterByTree:!0}),r[i]=n}return r}}(),function(e){N=t.FieldFilterProvider={};t.FieldFilterProvider.FieldFilterProvider=class{constructor(e){this._fieldName=e,this._filterValueMap={}}bind(e){this._dataProvider=e}setFilter(e){if(this._filter=e,this._filterValueMap={},e&&e.values&&e.values.length)for(const t of e.values){const e=(0,a.convertValueToDisplayString)(t);this._filterValueMap[e]=!0}}getFilter(){return this._filter}clearFilters(){this._filterValueMap={}}dataUpdated(){}getMatchingItems(e){null===e&&(e=this._dataProvider.getIds());const t=[];for(const r of e){const e=this._dataProvider.getValue(r,this._fieldName);this.matchesFilter(e)&&t.push(r)}return t}isFiltering(){return!!this._filterValueMap&&Object.keys(this._filterValueMap).length>0}matchesFilter(e){return(0,a.convertValueToDisplayString)(e)in this._filterValueMap}}}(),function(e){E=t.AreaPathHelper={},t.AreaPathHelper.getAreaPathLeafNode=function(e){const t=e?e.split("\\"):[""];return t[t.length-1]}}(),function(e){t.AreaPathFilterProvider={};t.AreaPathFilterProvider.AreaPathFilterProvider=class extends N.FieldFilterProvider{constructor(){super(n.CoreFieldRefNames.AreaPath)}matchesFilter(e){return(0,E.getAreaPathLeafNode)(e)in this._filterValueMap}}}(),function(e){function r(e,t){var r,i,s={};if(t)for(r=0,i=e.length;r<i;r++)s[e[r].toLocaleUpperCase()]=r;else for(r=0,i=e.length;r<i;r++)s[e[r]]=r;return s}b=t.UtilitiesArray={},t.UtilitiesArray.intersectPrimitives=function(e,t,i){var s,a,n,o,l;if(!t)return e;if(!e)return t;if(0===t.length||0===e.length)return[];if(e.length<t.length?s=r(e,i):(s=r(t,i),t=e),a=[],i)for(n=0,o=t.length;n<o;n++)l=t[n],s.hasOwnProperty(l.toLocaleUpperCase())&&(a[a.length]=l);else for(n=0,o=t.length;n<o;n++)l=t[n],s.hasOwnProperty(l)&&(a[a.length]=l);return a},t.UtilitiesArray.first=function(e,t){if(!e||0===e.length)return null;if(void 0===t)return e[0];var r,i,s=e.length;for(i=0;i<s;i++)if(!0===t(r=e[i]))return r;return null},t.UtilitiesArray.intersectUniqueSorted=function(e,t,r){var i,s;if(!e||!t||0===e.length||0===t.length)return[];e.length<t.length?(i=e,s=t):(i=t,s=e),r||(r=((e,t)=>e<t?-1:e>t?1:0));var a=0,n=s.length,o=[];for(let e of i){let t=a,i=n-1,l=t+i>>1,c=r(e,s[l]);for(;i>=t;){if(c<0)i=l-1;else{if(!(c>0))break;t=l+1}c=r(e,s[l=t+i>>1])}0===c&&(o.push(e),a=l+1)}return o},t.UtilitiesArray.union=function(e,t,r){var i;return t&&0!==t.length?(i=e.concat(t),(0,o.uniqueSort)(i,r),i):e}}(),function(e){M=t[e]={};class s{constructor(e,t,r){this.fieldName=e,this.dataSource=t,this.pageContext=r}getItems(e){let t=this.dataSource.getUniqueValues(this.fieldName);return t instanceof Promise?t.then(t=>this.transformResults(t,e)):(this.fieldName===n.CoreFieldRefNames.AssignedTo&&(t=t.map(e=>"string"==typeof e?(0,v.parseUniquefiedIdentityName)(e):e)),e&&(e=e.filter(e=>!t.find(t=>{var r;return(null===(r=t)||void 0===r?void 0:r.uniqueName)===e}))),this.transformResults(t,e))}getItemsForValues(e){return this.transformResults(e)}getListItem(e,t){return{id:t.key,text:t.display}}transformResults(r,i){let s=r.slice(0);return i&&(i=i.filter(e=>!!e),s=(0,b.union)(s,i,t[e].filterValueComparer)),s.map(this.transformResult,this)}transformResult(e){if(!(0,v.isWorkItemIdentityRef)(e)&&!(0,v.isIdentityRef)(e))return{key:e,value:e,display:e};let t,r,i;return(0,v.isIdentityRef)(e)?(t=e.displayName,r=e,i=e.uniqueName):(0,v.isWorkItemIdentityRef)(e)&&(t=e.identityRef.displayName,r=e.identityRef,i=e.identityRef.uniqueName),r.imageUrl||(r.imageUrl=(0,h.getAssetLocation)(this.pageContext,F.Identity_UnassignedUserIcon)),{key:i,value:r,display:t,imageUrl:(0,d.getIdentityImageUrl)(this.pageContext,r)}}}var a;t[e].DataSourceFilterValueProvider=s,function(e){e[e.Text=0]="Text",e[e.CheckboxList=1]="CheckboxList"}(a=t[e].WorkItemFilterFieldType||(t[e].WorkItemFilterFieldType={}));class o extends l.Component{constructor(e,t){super(e,t),this._cachedUniqueValues={},this._staleCachedValues=new Set,this._resolveFilterBar=(e=>{this._filterBar=e}),this._handleFilterUpdated=(e=>{if(this.props.filterUpdatedCallback&&!this._suppressFilterUpdatedEvent){const{filter:e}=this.state;if(e){const t=S(e.getState());this.props.filterUpdatedCallback(t)}}}),this._renderOperators=((e,t)=>{var i;const s=this.props.filter.getFilterItemState(t),a=new r.ObservableValue(null!==(i=null==s?void 0:s.operator)&&void 0!==i?i:e[0].key);return l.createElement(f.RadioButtonGroup,{className:"padding-horizontal-8",direction:1,groupClassName:"rhythm-horizontal-16",onSelect:e=>this._onOperatorChange(t,e,a),selectedButtonId:a},e.map((e,t)=>l.createElement(f.RadioButton,{id:e.key,key:`radio-button-${e.key}-${t}`,text:e.name})))}),this._timerManagement=new i.TimerManagement(this),this._updateThrottleDelegate=this._timerManagement.throttle(()=>{for(const e in this._cachedUniqueValues){const t=this._cachedUniqueValues[e].value;t.splice(0,t.length),this._staleCachedValues.add(e)}},250);const{filter:s=new _.Filter}=this.props;this.state={filter:s}}componentDidMount(){const{filter:e}=this.state,{fields:t,dataSource:r,initialFilterState:i,setDefaultFilter:s}=this.props;s&&(e.setDefaultState(I(t)),e.reset()),i?y(t,r,i).then(t=>{this._subscribeToFilterChangeEvent(e),this.state.filter.statesAreEqual(this.state.filter.getState(),t)||this.state.filter.setState(t)}):this._subscribeToFilterChangeEvent(e),this.props.onRenderComplete&&this.props.onRenderComplete()}componentWillUnmount(){const{filter:e}=this.state;e&&this._unsubscribeFromFilterChangeEvent(e)}clearFilters(){this._suppressFilterUpdatedEvent=!0,this.state.filter.reset(),this._suppressFilterUpdatedEvent=!1}focus(){this._filterBar&&this._filterBar.focus()}forceUpdate(){super.forceUpdate(),this._filterBar&&this._filterBar.forceUpdate()}update(){this._updateThrottleDelegate()}render(){const{filter:e}=this.state,{fields:t}=this.props,r=t.map(t=>{if(t.displayType===a.Text)return l.createElement(m.KeywordFilterBarItem,{key:t.fieldName,filter:e,filterItemKey:t.fieldName,placeholder:t.placeholder});{let r;return t.showOrAndOperators?r=[{name:C.OrOperator,key:"or"},{name:C.AndOperator,key:"and"}]:t.customOperators&&(r=t.customOperators),l.createElement(u.DropdownFilterBarItem,{filter:e,filterItemKey:t.fieldName,filterPlaceholderText:t.searchTextPlaceholder,items:this._getUniqueValuesObservable(t.fieldName),key:t.fieldName,noItemsText:t.noItemsText,placeholder:t.placeholder,selection:new g.DropdownMultiSelection,onExpand:()=>this._populateDropdownItems(t.fieldName),renderBeforeContent:r?()=>this._renderOperators(r,t.fieldName):void 0})}});return l.createElement(p.FilterBar,{filter:e,onRenderComplete:this.props.onRenderComplete,componentRef:this._resolveFilterBar,ref:this._resolveFilterBar,onDismissClicked:this.props.onDismissClicked},r)}_populateDropdownItems(e){const t=this._cachedUniqueValues[e];if(!t)return;const r=t.value,i=this._getFieldValueProvider(e),s=i.getItems(this._getCurrentFilterValues(e));s instanceof Promise?s.then(e=>t.push(...e.map(e=>i.getListItem(this.props.pageContext,e)).filter(e=>r.findIndex(t=>t.id===e.id)<0))):t.push(...s.map(e=>i.getListItem(this.props.pageContext,e)).filter(e=>r.findIndex(t=>t.id===e.id)<0))}_getUniqueValuesObservable(e){return this._cachedUniqueValues[e]&&!this._staleCachedValues.has(e)||(this._cachedUniqueValues[e]||(this._cachedUniqueValues[e]=new r.ObservableArray([])),this._populateDropdownItems(e),this._staleCachedValues.delete(e)),this._cachedUniqueValues[e]}_subscribeToFilterChangeEvent(e){e.subscribe(this._handleFilterUpdated,_.FILTER_CHANGE_EVENT)}_unsubscribeFromFilterChangeEvent(e){e.unsubscribe(this._handleFilterUpdated,_.FILTER_CHANGE_EVENT)}_getCurrentFilterValues(e){const t=S(this.state.filter.getState());if(t[e])return t[e].values}_getFieldValueProvider(e){const t=this._getField(e);if(t&&t.valueProvider)return t.valueProvider;const{dataSource:r}=this.props;return new s(e,r)}_getField(e){const{fields:t}=this.props;return(0,b.first)(t,t=>(0,c.equals)(t.fieldName,e,!0))}_onOperatorChange(e,t,r){const i=this.props.filter.getFilterItemState(e);this.props.filter.setFilterItemState(e,{value:null==i?void 0:i.value,operator:t}),r.value=t}}function S(e){const t={};for(const r in e){const i=e[r];let s=i&&i.value;if(s){"string"==typeof s?s=[{value:s}]:s instanceof Array||(s=[s]);const e={values:s.map(e=>{var t;return null!==(t=e.value)&&void 0!==t?t:e}),options:{}};"and"===i.operator?e.options.useAndOperator=!0:i.operator===A.IParentFilterOperators.tree&&(e.options.filterByTree=!0),t[r]=e}}return t}function I(e){const t={};for(const r of e)r.showOrAndOperators&&(t[r.fieldName]={value:void 0,operator:"or"});return t}function y(e,t,r){const i=[];for(const n in r){const o=r[n],l=e.find(e=>e.fieldName===n);if(l)if(l.displayType===a.Text)o.values&&1===o.values.length&&i.push(Promise.resolve({field:l,values:[String(o.values[0])],options:o.options}));else{const e=l.valueProvider;if(e){const t=e.getItemsForValues(o.values);i.push(Promise.resolve(t).then(e=>({field:l,values:e.map(e=>e.key),options:o.options})))}else{const e=new s(n,t);i.push(Promise.resolve(e.getItemsForValues(o.values)).then(e=>({field:l,values:e.map(e=>e.key),options:o.options})))}}}return Promise.all(i).then(t=>{const r=I(e);for(const{field:e,values:i,options:s}of t){let t=void 0;e.showOrAndOperators?t=s&&s.useAndOperator?"and":"or":e.customOperators&&(t=s&&s.filterByTree?A.IParentFilterOperators.tree:A.IParentFilterOperators.children),r[e.fieldName]={value:i,operator:t}}return r})}t[e].WorkItemFilter=o,o.defaultProps={setDefaultFilter:!0},t[e].mapToFilterState=S,t[e].mapFromFilterState=function(e){const t={};for(const r in e){const i=e[r],s={value:i.values.map(e=>({key:e,value:e,display:e}))};i.options&&i.options.useAndOperator?s.operator="and":i.options&&i.options.filterByTree&&(s.operator=A.IParentFilterOperators.tree),t[r]=s}return t},t[e].generateDefaultFilterState=I,t[e].resolveFilterState=y;t[e].workItemFilterItemComparer=((e,t)=>!e&&t?-1:e&&!t?1:(0,c.localeIgnoreCaseComparer)(e.key,t.key));t[e].filterValueComparer=((e,t)=>(e.distinctDisplayName&&(e=e.distinctDisplayName),t.distinctDisplayName&&(t=t.distinctDisplayName),e.displayName&&(e=e.displayName),t.displayName&&(t=t.displayName),"string"==typeof e&&"string"==typeof t?(0,c.localeIgnoreCaseComparer)(e,t):e==t?0:e>t?1:-1))}("WorkItemFilter"),function(e){x=t[e]={};const i={key:S.WiqlOperators.MacroMe,display:`${S.WiqlOperators.MacroStart}${C.Wiql_MacroMe}`,value:S.WiqlOperators.MacroMe};t[e].UnassignedFilterItem={key:"_Unassigned_",display:C.AssignedToEmptyText,value:""};function s(e,t,r,i){let s;const a=t.getIds();for(const o of a){if(i===t.getValue(o,r)){const r=t.getValue(o,n.CoreFieldRefNames.TeamProject)||e,i={projectName:r,workItemType:t.getValue(o,n.CoreFieldRefNames.WorkItemType)};if(0===(0,c.localeIgnoreCaseComparer)(r,e)){s=i;break}s||(s=i)}}return s||(s={projectName:e}),s}t[e].AssignedToFilterValueProvider=class extends M.DataSourceFilterValueProvider{constructor(e,t,r=!1){super(n.CoreFieldRefNames.AssignedTo,t,e),this._excludeMeFilter=r}getItems(e){const t=super.getItems(e);return t instanceof Promise?t.then(this.addMacros):this.addMacros(t)}getItemsForValues(r){const s=[];for(const a of r)a===t[e].UnassignedFilterItem.value?s.push(Promise.resolve(t[e].UnassignedFilterItem)):a===S.WiqlOperators.MacroMe?s.push(Promise.resolve(i)):s.push(Promise.resolve(super.getItemsForValues([a])).then(e=>e[0]));return Promise.all(s)}getListItem(r,s){if(s.key===i.key||s.key===t[e].UnassignedFilterItem.key)return super.getListItem(r,s);const{key:a,value:n,display:o}=s,c=(0,v.convertPotentialIdentityRefFromFieldValue)(r,n,!0);return{id:a,text:o,iconProps:{render:()=>l.createElement(I.IdentityView,{viewMode:1,identityRef:c})}}}transformResults(e,t){let r=e.slice(0);return t&&(t=t.filter(e=>!!e),r=(0,b.union)(r,this._filterDistinctNames(r,t),M.filterValueComparer)),r.map(this.transformResult,this)}_filterDistinctNames(e,t){const r=new Set(t);for(const t of e){let e;(0,v.isWorkItemIdentityRef)(t)?e=t.distinctDisplayName:(0,v.isIdentityRef)(t)&&(e=(0,v.getFriendlyDistinctDisplayName)(t)),e&&r.has(e)&&r.delete(e)}return Array.from(r)}addMacros(r){const s=[i,t[e].UnassignedFilterItem];return r=(0,o.subtract)(r,s,M.workItemFilterItemComparer),this._excludeMeFilter&&s.shift(),s.concat(r)}};t[e].StateFilterValueProvider=class extends M.DataSourceFilterValueProvider{constructor(e,t){super(n.CoreFieldRefNames.State,t),this.defaultProjectNameOrId=e}getListItem(e,t){const i=t.value,a=s(this.defaultProjectNameOrId,this.dataSource,n.CoreFieldRefNames.State,i),o=new r.ObservableValue({fill:null,name:i}),c=e.getService(y.WorkItemStateColorMetadataServiceId);if(a){const e=c.getWorkItemStateColor(a.projectName,a.workItemType,i);e instanceof Promise?e.then(e=>{o.value=e}):o.value=e}return{id:i,text:i,iconProps:{render:()=>l.createElement(T.WorkItemState,{className:"margin-right-4",data:o,hideText:!0})}}}};t[e].WorkItemTypeFilterValueProvider=class extends M.DataSourceFilterValueProvider{constructor(e,t,r){super(n.CoreFieldRefNames.WorkItemType,t,null),this.projectName=e,this._colorAndIconMap=r}getListItem(e,t){const r=t.value,i=s(this.projectName,this.dataSource,n.CoreFieldRefNames.WorkItemType,r);let a={color:null,icon:null,workItemTypeName:r};return this._colorAndIconMap&&this._colorAndIconMap[r]?a=this._colorAndIconMap[r]:i&&i.projectName&&(a=(0,y.getIconDataObservable)(i.projectName,r,e)),{id:r,text:r,iconProps:{render:()=>l.createElement(P.WorkItemTypeIcon,{className:"margin-right-4",data:a})}}}},t[e].UnparentedFilterItem={key:"_Unparented_",display:C.UnparentedText,value:""};t[e].ParentItemFilterValueProvider=class extends M.DataSourceFilterValueProvider{constructor(e,t){super(n.CoreFieldRefNames.Parent,t,e)}addUnparentedFilter(r){return r.filter(r=>r.key===t[e].UnparentedFilterItem.key).length>0?r:[t[e].UnparentedFilterItem].concat(r)}getItems(e){const t=this.dataSource.getParentItems().map(e=>{const t=String(e.id);return{key:t,display:e.title,value:t}});return this.addUnparentedFilter(t)}};const a={key:S.WiqlOperators.MacroCurrentIteration,value:S.WiqlOperators.MacroCurrentIteration,display:(0,S.getLocalizedOperator)(S.WiqlOperators.MacroCurrentIteration)};function d(e){var t;return null===(t=e.attributes)||void 0===t?void 0:t.startDate}t[e].IterationPathFilterValueProvider=class extends M.DataSourceFilterValueProvider{constructor(e,t,r,i){super(n.CoreFieldRefNames.IterationPath,r,e),this.addCurrentIterationMacro=i,this.projectId=t}async getItems(e){var t;let r=await this.getIterationPathValues();const i=[...r,...null!==(t=null==e?void 0:e.filter(e=>e===a.key))&&void 0!==t?t:[]].map(e=>e.toString()),s=await this.getPathToNodeMap(i);e&&(e=(e=(0,o.subtract)(e,[a.key],c.localeIgnoreCaseComparer)).filter(e=>!!s.get(e.toString())),r=(0,b.union)(r,e,c.localeIgnoreCaseComparer));const n=[];r.forEach(async e=>{const t=s.get(e.toString());t&&n.push({path:e.toString(),node:t})}),n.sort((e,t)=>{const r=e.node,i=t.node,s=function(e,t){const r=d(e),i=d(t);return r instanceof Date&&i instanceof Date?r.getTime()-i.getTime():r instanceof Date?1:i instanceof Date?-1:0}(r,i);if(0!==s)return s;const a=(0,c.localeIgnoreCaseComparer)(r.name,i.name);return 0!==a?a:r.id-i.id});const l=n.map(e=>({key:e.path,value:e.path,display:e.node.name}));return this.addCurrentIterationMacro&&l.unshift(a),l}async getItemsForValues(e){const t=this.pageContext.getService("IWorkItemNodeService");let r=[];return e.forEach(e=>{if(e===S.WiqlOperators.MacroCurrentIteration)r.push(a);else{const i=t.findIterationNodeByPath(this.projectId,e.toString());i&&r.push(this.transformNode(e,i))}}),r}async getIterationPathValues(){return await this.dataSource.getUniqueValues(n.CoreFieldRefNames.IterationPath)}async getPathToNodeMap(e){const t=this.pageContext.getService("IWorkItemNodeService"),r=new Map;for(const i of e){const e=await t.findIterationNodeByPath(this.projectId,i);r.set(i,e)}return r}transformNode(e,t){return{key:e,value:e,display:t.name}}}}("FilterValueProviders"),function(e){t.AssignedToFilterProvider={};t.AssignedToFilterProvider.AssignedToFilterProvider=class extends N.FieldFilterProvider{constructor(e){super(n.CoreFieldRefNames.AssignedTo),this.currentUser=e}setFilter(e){super.setFilter(e);const t=Object.keys(this._filterValueMap);for(const e of t)if((0,c.equals)(e,S.WiqlOperators.MacroMe,!0)){const t=this.currentUser.uniqueName;delete this._filterValueMap[e],this._filterValueMap[t]=!0}}matchesFilter(e){var t,r;let i=void 0;if(e&&!(0,v.isWorkItemIdentityRef)(e)&&!(0,v.isIdentityRef)(e)&&!(i=(0,v.parseUniquefiedIdentityName)(e)).uniqueName)return super.matchesFilter(e);const s=i?i.uniqueName:e&&((null===(r=null===(t=e)||void 0===t?void 0:t.identityRef)||void 0===r?void 0:r.uniqueName)||e.uniqueName)||x.UnassignedFilterItem.key;return this._filterValueMap.hasOwnProperty(s)}}}(),function(e){t.FilterStateManager={};const r=1e3;t.FilterStateManager.FilterStateManager=class{constructor(e,t,s,a,n="Project"){this._scopeId=t,this._registryKey=s,this._filterState=a,this._scopeName=n,this._timerManagement=new i.TimerManagement(this),this._saveFilterThrottleDelegate=this._timerManagement.throttle(()=>{const e=this._pageContext.getService("ISettingsService"),t={[this._registryKey]:this._filterState};e.setEntries(t,0,this._scopeName,this._scopeId)},r),this._pageContext=e}saveFilter(e){this._filterState=e,this._saveFilterThrottleDelegate()}setFilterState(e){this._filterState=e}resetFilter(){this.saveFilter({})}getFilterState(){return this._filterState}}}(),function(e){t.IterationPathFilterProvider={};t.IterationPathFilterProvider.IterationPathFilterProvider=class extends N.FieldFilterProvider{constructor(e){super(n.CoreFieldRefNames.IterationPath),this.currentIterationPath=e}setFilter(e){if(super.setFilter(e),this.currentIterationPath){const e=Object.keys(this._filterValueMap);for(const t of e)t===S.WiqlOperators.MacroCurrentIteration&&(delete this._filterValueMap[t],this._filterValueMap[this.currentIterationPath]=!0)}}}}(),function(e){t.ParentFilterProvider={};t.ParentFilterProvider.ParentFilterProvider=class extends N.FieldFilterProvider{constructor(){super(n.CoreFieldRefNames.Parent),this._childToParentsMap=new Map}bind(e){this._dataProvider=e}dataUpdated(){this._childToParentsMap.clear()}getMatchingItems(e){null===e&&(e=this._dataProvider.getIds());const t=[];for(const r of e)this.matchesFilter(r)&&t.push(r);return t}matchesFilter(e){var t;if(null===(t=this._filter.options)||void 0===t?void 0:t.filterByTree){let t=this._childToParentsMap.get(e);return t||(this._childToParentsMap.set(e,this._dataProvider.getAllParents(e)),t=this._childToParentsMap.get(e)),this.matchesParentFilter(e)||t.some(e=>this.matchesParentFilter(e))}{const t=this._dataProvider.getValue(e,this._fieldName),r=null!=t?t:x.UnparentedFilterItem.key;return this.matchesParentFilter(r)}}matchesParentFilter(e){return String(e)in this._filterValueMap}}}(),function(e){O=t.SearchSearch={};t.SearchSearch.SearchCore=class{constructor(e,t){this.addItems=(e=>{this._strategy.processItems(e)}),this._strategy=e,this._adapter=t}beginSearch(e){var t;return this._adapter.isDataSetComplete()||this._adapter.addMoreItems(this.addItems,()=>{this.beginSearch(e)}),t=this._strategy.search(e),this._adapter.handleResults(t,!0,e),t}getStrategy(){return this._strategy}clearStrategyStore(){this.getStrategy().clearStrategyStore()}};class r{constructor(e){this._options=Object.assign({},e),this._options.specialCharacters&&this._options.specialCharacters.length&&this._buildSpecialCharacterHashSet(this._options.specialCharacters)}static getTerms(e,t){var r=new Object(void 0);for(let s of e){var i=s.toLocaleLowerCase().split(t||" ");for(let e=0,t=i.length;e<t;e++)i[e]&&(r[i[e]]=!0)}return Object.keys(r)}_buildSpecialCharacterHashSet(e){this._specialCharactersHashSet={};for(let t of e)this._specialCharactersHashSet[t.toLocaleLowerCase()]=!0}_getTerms(e){var t=r.getTerms(e,this._options.delimiter);if(this._specialCharactersHashSet)for(let e of t){for(var i=0,s=e.length;i<s&&this._specialCharactersHashSet.hasOwnProperty(e[i]);)i++;i>0&&i<s&&t.push(e.substr(i))}return t}processItems(e){}clearStrategyStore(){}search(e){return[]}dataExists(){return!1}getIndexedItemsCount(){return 0}getIndexTotalSize(){return 0}}t.SearchSearch.SearchStrategy=r;t.SearchSearch.SubstringSearchStrategy=class extends r{processItems(e){for(const t of e)0===t.terms.length||this._indexedItemsMap[t.item.toString()]||(this._indexedItemsMap[t.item.toString()]=t.terms.join(" ").toLowerCase())}getIndexTotalSize(){return Object.keys(this._indexedItemsMap).length}clearStrategyStore(){this._indexedItemsMap=new Map}getIndexedItemsCount(){return Object.keys(this._indexedItemsMap).length}search(e){const t=e.trim().toLowerCase();if(""===t)return Object.keys(this._indexedItemsMap).map(e=>parseInt(e));const r=[];for(const[e,i]of Object.entries(this._indexedItemsMap))i.includes(t)&&r.push(parseInt(e));return r}dataExists(){return this._indexedItemsMap.size>0}};t.SearchSearch.IndexedSearchStrategy=class extends r{constructor(e,t){if(super(t),e)this._searchStore=e;else{var r={comparer:this._options.comparer};t&&t.delimiter&&(r.delimiter=t.delimiter),this._searchStore=new n(r)}this._dataExists=!1,this._indexedItems=[]}getIndexTotalSize(){return this._searchStore.getStoreTotalSize()}clearStrategyStore(){this._dataExists=!1,this._indexedItems=[],this._searchStore.clearStrategyStore()}getIndexedItemsCount(){return this._indexedItems.length}processItems(e){for(let t of e)0!==t.terms.length&&this._searchStore.addToIndex(t.item,this._getTerms(t.terms))&&this._indexedItems.push(t.item);this._dataExists=!0}search(e){var t=e.trim();return""===t?this._indexedItems:this._searchStore.search(t)}dataExists(){return this._dataExists}};class i{constructor(e){this._options=e||{},this._comparer=this._options.comparer}search(e){return[]}addToIndex(e,t){return!1}clearStrategyStore(){}getStoreTotalSize(){return 0}}t.SearchSearch.IndexedSearchStore=i;class s{constructor(e){this.children={},this.content=[],e&&this.content.push(e)}}class a{constructor(e){this.root=new s,this.SIZEOF_KEY=2,this.SIZEOF_NUMBER=8,this._comparer=e,this._trieSize=0}insert(e,t){for(var r,i,a=this.root,n=0,o=e.length;n<o&&(i=a.children[e[n]]);++n)a=i;for(;n<o;++n)r=new s,this._trieSize+=this.SIZEOF_KEY,a.children[e[n]]=r,a=r;var l=!1;return-1===a.content.indexOf(t)&&(a.content.push(t),this._trieSize+=this.SIZEOF_NUMBER,l=!0),l}find(e){for(var t=this.root,r=0,i=e.length;r<i;++r){var s=e[r];if(!t.children[s])return null;t=t.children[s]}return this._getAllDescendantContent(t)}_getAllDescendantContent(e){var t,r=[],i=[];for(r.push(e);r.length;)if((t=r.pop()).content&&t.content.length&&(i=i.concat(t.content)),t.children)for(let e in t.children)r.push(t.children[e]);return o(i,this._comparer)}clear(){this.root=new s,this._trieSize=0}getTrieTotalSize(){return this._trieSize}}class n extends i{constructor(e){super(e),this._trie=new a(this._comparer)}search(e){var t=r.getTerms([e],this._options.delimiter),i=[];for(let e of t)if(e){var s=this._trie.find(e);if(0===(i=s?0===i.length?s:(0,b.intersectUniqueSorted)(i,s,this._comparer):[]).length)break}return i}addToIndex(e,t){var r=!0;for(let i of t)this._trie.insert(i,e)||(r=!1);return r}clearStrategyStore(){this._trie.clear()}getStoreTotalSize(){return this._trie.getTrieTotalSize()}}t.SearchSearch.TrieStore=n;t.SearchSearch.SearchAdapter=class{constructor(){}addMoreItems(e,t){}createSearchableObjects(){return[]}handleResults(e,t,r){}handleError(e){}handleClear(){}isDataSetComplete(){return!1}};function o(e,t){var r=e.length;if(r>1){e.sort(t);var i=new Array(r);i[0]=e[0];var s=0,a=1;for(let t=1;t<r;t++)e[t]!==e[s]&&(i[a++]=e[t],s=t);i.length=a,e=i}return e}t.SearchSearch.SearchableObject=class{constructor(e,t){this.item=e,this.terms=t}setTerms(e){this.terms=e}addTerm(e){this.terms.push(e)}},t.SearchSearch.fastUnique=o}(),function(e){U=t[e]={},t[e].TAG_SPLITTING_SEPARATOR=/[,;]/,t[e].splitAndTrimTags=function(r){if(!r)return[];var i=r.split(t[e].TAG_SPLITTING_SEPARATOR),s=[];for(var a of i){var n=a.trim();n&&s.push(n)}return s}}("UtilitiesUtilities"),function(e){t.TagsFilterProvider={};t.TagsFilterProvider.TagsFilterProvider=class extends N.FieldFilterProvider{constructor(){super(n.CoreFieldRefNames.Tags),this._filterValues=[]}setFilter(e){super.setFilter(e),this._filterValues=e?e.values:[]}matchesFilter(e){if(e){const t=(0,U.splitAndTrimTags)(e);return this._filter&&this._filter.options&&this._filter.options.useAndOperator?this._filterValues.every(e=>t.indexOf(e)>=0):t.some(e=>e in this._filterValueMap)}return!1}}}(),function(e){t[e]={},t[e].SearchStrategySpecialCharacters=["{","(","[","!","@","#","$","%","^","&","*","~","`","'",'"'];class r{constructor(){this._searchAdapter=this.getSearchAdapter(),this._searchCore=new O.SearchCore(this._createSearchStrategy(),this._searchAdapter),this._updateRequired=!0}bind(e){this._dataProvider=e}setFilter(e){this._searchValues=[],e&&e.values&&e.values.length&&(this._searchValues=e.values)}getFilter(){return{values:this._searchValues||[]}}clearFilters(){this._searchValues=null}dataUpdated(){this._updateRequired=!0}getMatchingItems(e){this._updateRequired&&(this._searchAdapter.setDataSource(this._dataProvider),this._searchCore.clearStrategyStore(),this._searchCore.addItems(this._searchAdapter.createSearchableObjects()),this._updateRequired=!1);let t=this._searchCore.beginSearch(this._searchValues.join(" "));return t&&e&&(t=(0,b.intersectPrimitives)(e,t)),t}isFiltering(){return!!this._searchValues&&this._searchValues.some(e=>""!==e)}_createSearchStrategy(){return new O.IndexedSearchStrategy(null,{specialCharacters:t[e].SearchStrategySpecialCharacters,delimiter:/[\s\\\/\.]/,comparer:(e,t)=>e-t})}}t[e].BaseTextFilterProvider=r,r.PROVIDER_TYPE="text";t[e].TextFilterProvider=class extends r{getSearchAdapter(){return new i}};class i extends O.SearchAdapter{setDataSource(e){this._dataSource=e}getDataSource(){return this._dataSource}createSearchableObjects(){const e=[],t=this._dataSource.getIds();for(const r of t){const t=this.createSearchableObject(r);t&&e.push(t)}return e}createSearchableObject(e){const t=new O.SearchableObject(e,[]),r=this._dataSource.getVisibleFields();for(const i of r){const r=this._dataSource.getValue(e,i),s=typeof r;if("string"===s)t.addTerm(r);else if("number"===s)t.addTerm(r+"");else if(r&&(0,v.isWorkItemIdentityRef)(r)&&r.identityRef&&r.identityRef.displayName)t.addTerm(r.identityRef.displayName);else if(r&&(0,v.isIdentityRef)(r)&&r.displayName)t.addTerm(r.displayName);else{if(null==r)continue;{const e=(0,a.convertValueToDisplayString)(r);e&&t.addTerm(e)}}}return t}handleResults(e,t,r){}handleError(e){}handleClear(){}isDataSetComplete(){return!0}addMoreItems(e,t){}}t[e].TextSearchAdapter=i;class s extends r{getSearchAdapter(){return new l}}t[e].TextFilterProviderWithUnassigned=s;class l extends i{constructor(){super(...arguments),this._containsAssignedToMeColumn=!1}createSearchableObjects(){const e=this.getDataSource();return this._containsAssignedToMeColumn=(0,o.contains)(e.getVisibleFields(),n.CoreFieldRefNames.AssignedTo),super.createSearchableObjects()}createSearchableObject(e){const t=super.createSearchableObject(e),r=this.getDataSource();return this._containsAssignedToMeColumn&&!r.getValue(e,n.CoreFieldRefNames.AssignedTo)&&t.addTerm(C.AssignedToEmptyText),t}}t[e].SubstringTextFilterProvider=class extends s{_createSearchStrategy(){return new O.SubstringSearchStrategy}}}("TextFilterProvider")},["Resources","Constants/Constants","FilterManager","FieldFilterProvider","AreaPathHelper","AreaPathFilterProvider","Utilities/Array","WorkItemFilter","FilterValueProviders","AssignedToFilterProvider","FilterStateManager","IterationPathFilterProvider","ParentFilterProvider","Search/Search","Utilities/Utilities","TagsFilterProvider","TextFilterProvider"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.filter-content"}}));