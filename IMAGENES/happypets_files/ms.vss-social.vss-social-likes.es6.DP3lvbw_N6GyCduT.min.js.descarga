"use strict";define("Likes",["require","exports","VSS/Reflux/Action","VSS/Platform/Context","VSS/Platform/RestClientBase","react","VSS/Core/Util/Accessibility","VSSUI/Button","VSSUI/Spinner","VSSUI/TooltipEx","VSS/Core/Util/Object","VSSUI/Util","VSS/Core/Util/String","VSS/Reflux/Store","VSS/Platform/Layout"],function(e,t,i,s,a,n,o,r,c,l,k,d,h,L,u){var g,S,p,m,C,f,_,y;g=t.Resources={},t.Resources.DefaultLikedAriaLabel="Liked",t.Resources.DefaultUnLikedAriaLabel="Like",t.Resources.LikesCountAriaLabel="{0} likes. Liked by {1}",t.Resources.UnLikedString="Like",t.Resources.LikedString="Liked",t.Resources.NMoreUsers="+{0} users",t.Resources.OneMoreUser="+1 user",t.Resources.UsersInfoSpinner="Fetching users info",t.LikeModels={},S=t.LikesConstants={},(t.LikesConstants.LikesConstants||(t.LikesConstants.LikesConstants={})).TopLikedUsersFetchCount=10,t.Constants={},(t.Constants.SocialScopes||(t.Constants.SocialScopes={})).Collection="Collection",function(e){p=t.ActionsHub={};t.ActionsHub.LikeActions=class{constructor(){this.createLikeStarted=new i.Action,this.createLikeFailed=new i.Action,this.likeInfoReceived=new i.Action,this.deleteLikeStarted=new i.Action,this.deleteLikeFailed=new i.Action,this.likedUsersInfoReceived=new i.Action}}}(),function(e){t[e]={};t[e].SocialClientName="ISocialRestClient",t[e].getSocialClient=function(i,s){return i.getRestClient(t[e].SocialClientName,s)},s.RestClients.add(t[e].SocialClientName,{factory:class extends a.RestClientBase{constructor(e){super(e)}async createSocialEngagement(e){return this.beginRequest({apiVersion:"5.0-preview.1",method:"POST",routeTemplate:"_apis/Social/SocialEngagement",body:e})}async deleteSocialEngagement(e,t,i,s,a){const n={artifactType:e,artifactId:t,engagementType:i,artifactScopeType:s,artifactScopeId:a};return this.beginRequest({apiVersion:"5.0-preview.1",method:"DELETE",routeTemplate:"_apis/Social/SocialEngagement",queryParams:n})}async getSocialEngagement(e,t,i,s,a){const n={artifactType:e,artifactId:t,engagementType:i,artifactScopeType:s,artifactScopeId:a};return this.beginRequest({apiVersion:"5.0-preview.1",routeTemplate:"_apis/Social/SocialEngagement",queryParams:n})}async getSocialEngagementAggregateMetric(e,t,i,s,a){const n={artifactType:e,artifactId:t,engagementType:i,artifactScopeType:s,artifactScopeId:a};return this.beginRequest({apiVersion:"5.0-preview.1",routeTemplate:"_apis/Social/SocialEngagementAggregateMetric",queryParams:n})}async getSocialEngagementProviders(){return this.beginRequest({apiVersion:"5.0-preview.1",routeTemplate:"_apis/Social/SocialEngagementProviders"})}async getEngagedUsers(e,t,i,s,a,n,o){const r={artifactType:e,artifactId:t,engagementType:i,artifactScopeType:s,artifactScopeId:a,top:n,skip:o};return this.beginRequest({apiVersion:"5.0-preview.1",routeTemplate:"_apis/Social/SocialEngagementUsers",queryParams:r})}}})}("RestClientSocial"),function(e){m=t.LikeSource={};t.LikeSource.LikeSource=class{constructor(e){this._pageContext=e,this._socialClient=this._pageContext.getRestClient("ISocialRestClient")}async getLikes(e){return this._socialClient.getSocialEngagement(e.artifactType,e.artifactId,0,e.artifactScopeType,e.artifactScopeId)}async deleteLike(e){return this._socialClient.deleteSocialEngagement(e.artifactType,e.artifactId,0,e.artifactScopeType,e.artifactScopeId)}async createLike(e){let t={artifactId:e.artifactId,artifactType:e.artifactType,engagementType:0,artifactScope:{id:e.artifactScopeId,name:"",type:e.artifactScopeType}};return this._socialClient.createSocialEngagement(t)}async getLikedUsers(e){return this._socialClient.getEngagedUsers(e.artifactType,e.artifactId,0,e.artifactScopeType,e.artifactScopeId,S.LikesConstants.TopLikedUsersFetchCount)}}}(),function(e){var i;C=t.SocialTelemetry={},function(e){e.AREA="Social",e.LIKE_TOGGLE_CLICK="ToggleLikesClick"}(i=t.SocialTelemetry.SocialCustomerIntelligenceConstants||(t.SocialTelemetry.SocialCustomerIntelligenceConstants={}));t.SocialTelemetry.SocialTelemetry=class{constructor(e){this._telemetryService=e.getService("IVssTelemetryService"),this._navigationService=e.getService("IVssNavigationService")}logToggleLikeClicked(e,t){let s={artifactType:e,liked:t};this.publish(i.LIKE_TOGGLE_CLICK,s)}publish(e,t={},s=!1){let a=this._navigationService.getCurrentRoute().routeId;t.routeId=a,this._telemetryService.publishEvent(i.AREA,e,t)}}}(),function(e){f=t.LikeActionCreator={};t.LikeActionCreator.LikeActionCreator=class{constructor(e,t,i){this._actions=e,this._pageContext=t,this._likeSource=i,this._socialTelemetry=new C.SocialTelemetry(this._pageContext)}getLikes(e){return this.likeSource.getLikes(e).then(e=>{this._invokeDataReceivedAction(e)},e=>{})}fetchLikedUsers(e){this.likeSource.getLikedUsers(e).then(e=>{this._invokeLikedUsersInfoReceivedAction(e)},e=>{})}deleteLike(e){this._socialTelemetry.logToggleLikeClicked(e.artifactType,!1),this._actions.deleteLikeStarted.invoke(void 0),this.likeSource.deleteLike(e).then(t=>{this.fetchLikedUsers(e)},t=>{this.getLikes(e),this._actions.deleteLikeFailed.invoke(t)})}createLike(e){this._socialTelemetry.logToggleLikeClicked(e.artifactType,!0),this._actions.createLikeStarted.invoke(void 0),this.likeSource.createLike(e).then(t=>{this.fetchLikedUsers(e)},t=>{this.getLikes(e),this._actions.createLikeFailed.invoke(t)})}_invokeDataReceivedAction(e){let t=!1;null!=e.creationDate&&(t=!0),this._actions.likeInfoReceived.invoke({likeCount:e.socialEngagementStatistics.userCount,isLiked:t})}_invokeLikedUsersInfoReceivedAction(e){this._actions.likedUsersInfoReceived.invoke(e.map(e=>e.displayName))}get likeSource(){return this._likeSource||(this._likeSource=new m.LikeSource(this._pageContext)),this._likeSource}}}(),function(e){_=t.LikeHeart={};const i=(0,k.getId)("likes-count");(0,k.getId)("likes-heart");t.LikeHeart.LikeHeart=(e=>{e.ariaLabelLiked?e.ariaLabelLiked:g.DefaultLikedAriaLabel,e.ariaLabelUnLiked?e.ariaLabelUnLiked:g.DefaultUnLikedAriaLabel;return n.createElement("div",{className:(0,d.css)(e.className,"like-heart-component")},n.createElement(r.Button,{subtle:!0,className:"like-heart-button",iconProps:{iconName:e.isLiked?"HeartFill":"Heart"},ariaPressed:e.isLiked,onClick:function(){e.onLikeHeartClick(!e.isLiked),e.isLiked||(0,o.announce)((0,h.format)(g.LikesCountAriaLabel,e.likedCount+1))}},n.createElement("span",{className:"like-string"},e.isLiked?g.LikedString:g.UnLikedString)),n.createElement(t.LikeHeart.LikeCount,Object.assign({},e)))});t.LikeHeart.LikeCount=(e=>{const t=n.createElement("div",{className:"like-count-no-tooltip"},n.createElement("span",{className:"like-count-element","aria-label":(0,h.format)(g.LikesCountAriaLabel,e.likedCount)},e.likedCount)),s=n.createElement(l.Tooltip,{anchorOffset:{horizontal:0,vertical:-8},anchorOrigin:{horizontal:"center",vertical:"start"},id:i,renderContent:function(){if(e.likedBy&&e.likedBy.length>0){const t=e.likedBy,i=t.map((e,t)=>n.createElement("li",{key:e+t},e));if(e.likedBy.length===S.LikesConstants.TopLikedUsersFetchCount&&e.likedCount>e.likedBy.length){const t=e.likedCount-e.likedBy.length,s=1===t?g.OneMoreUser:g.NMoreUsers;i.push(n.createElement("li",{className:"user-item",key:"nmoreusers"},(0,h.format)(s,t)))}return n.createElement("div",{className:"liked-users-tooltip"},n.createElement("ul",{className:"users-list"},i))}return e.fetchLikedUsers&&e.fetchLikedUsers(),n.createElement(c.Spinner,{label:g.UsersInfoSpinner})},showOnFocus:!0,text:"",tooltipOrigin:{horizontal:"center",vertical:"end"}},n.createElement("span",{className:"like-count-element focusable","aria-label":(0,h.format)(g.LikesCountAriaLabel,e.likedCount,function(){let t=[];if(e.likedBy&&e.likedBy.length>0&&(t=e.likedBy.map((e,t)=>e),e.likedBy.length===S.LikesConstants.TopLikedUsersFetchCount&&e.likedCount>e.likedBy.length)){const i=e.likedCount-e.likedBy.length,s=1===i?g.OneMoreUser:g.NMoreUsers;t.push((0,h.format)(s,i))}return t.join(", ")}()),tabIndex:0},n.createElement("span",{"aria-hidden":!0},e.likedCount)));return 0===e.likedCount?t:e.likedBy&&e.likedBy.length>0?s:e.fetchLikedUsers?s:n.createElement("div",null)})}(),function(e){y=t.LikeStore={};t.LikeStore.LikeStore=class extends L.Store{constructor(e,t){super("likesChangedEvent"),this._actions=e,this._onLikeInfoReceived=(e=>{this.isLoading()?(this._state=Object.assign(Object.assign({},e),{topLikedUsers:this._state.topLikedUsers}),this._loading=!1,this.emitChanged()):this._state.isLiked===e.isLiked&&this._state.likeCount===e.likeCount||(this._state=Object.assign(Object.assign({},e),{topLikedUsers:this._state.topLikedUsers}),this.emitChanged())}),this._onCreateSocialEngagementStarted=(()=>{this._state.isLiked=!0,this._state.likeCount=this.getState().likeCount+1,this.emitChanged()}),this._onDeleteSocialEngagementStarted=(()=>{this._state.isLiked=!1,this.getState().likeCount>0&&(this._state.likeCount=this.getState().likeCount-1),this.emitChanged()}),this._onLikedUsersInfoReceived=(e=>{this._state.topLikedUsers=e,this.emitChanged()}),this._loading=!0,this._state=t||{isLiked:!1,likeCount:0},this._actions.likeInfoReceived.addListener(this._onLikeInfoReceived),this._actions.createLikeStarted.addListener(this._onCreateSocialEngagementStarted),this._actions.deleteLikeStarted.addListener(this._onDeleteSocialEngagementStarted),this._actions.likedUsersInfoReceived.addListener(this._onLikedUsersInfoReceived)}getState(){return this._state}isLoading(){return this._loading}dispose(){this._actions.likeInfoReceived.removeListener(this._onLikeInfoReceived),this._actions.createLikeStarted.removeListener(this._onCreateSocialEngagementStarted),this._actions.deleteLikeStarted.removeListener(this._onDeleteSocialEngagementStarted),this._actions.likedUsersInfoReceived.removeListener(this._onLikedUsersInfoReceived)}}}(),function(e){t.StatefulLikeHeart={};const i="81c27cc8-7a9f-48ee-b63f-df1e1d0412dd",s="/Social";class a extends u.VssComponent{constructor(e,t){super(e,t),this._onLikeHeartClick=(e=>{e?this._actionsCreator.createLike(this.props.likeArtifactInfo):this._actionsCreator.deleteLike(this.props.likeArtifactInfo)}),this._onFetchLikedUsers=(()=>{this._actionsCreator.fetchLikedUsers(this.props.likeArtifactInfo)}),this._onStoreChanged=(()=>{this.setState(this._store.getState())}),this._pageContext=t.pageContext;const a=this._pageContext.getService("IVssSecurityService");if(this._hasReadPermission=a.hasPermission(i,s,1),!this._hasReadPermission)return;let n;n=e.initialLikeInfo?e.initialLikeInfo:{isLiked:!1,likeCount:0},this.state=n,this._initializeFlux(n),e.initialLikeInfo||this._actionsCreator.getLikes(this.props.likeArtifactInfo)}componentDidMount(){this._hasReadPermission&&this._store.addChangedListener(this._onStoreChanged)}render(){return this._hasReadPermission?(this.props.onLikeHeartRender&&this.props.onLikeHeartRender(),this._store.isLoading()?n.createElement("div",null):n.createElement(_.LikeHeart,{className:this.props.className,onLikeHeartClick:this._onLikeHeartClick,isLiked:this.state.isLiked,ariaLabelLiked:this.props.ariaLabelLiked,ariaLabelUnLiked:this.props.ariaLabelUnLiked,likedBy:this.state.topLikedUsers,fetchLikedUsers:this._onFetchLikedUsers,likedCount:this.state.likeCount})):null}componentWillUnmount(){this._hasReadPermission&&(this._store.removeChangedListener(this._onStoreChanged),this._store.dispose())}_initializeFlux(e){const t=new p.LikeActions;this._store=new y.LikeStore(t,e),this._actionsCreator=new f.LikeActionCreator(t,this._pageContext)}}t.StatefulLikeHeart.StatefulLikeHeart=a,a.componentType="statefulLikeHeart",u.VssComponent.register(a.componentType,a)}()},["Resources","LikeModels","LikesConstants","Constants","ActionsHub","RestClient/Social","LikeSource","SocialTelemetry","LikeActionCreator","LikeHeart","LikeStore","StatefulLikeHeart"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-social.vss-social-likes"}}));