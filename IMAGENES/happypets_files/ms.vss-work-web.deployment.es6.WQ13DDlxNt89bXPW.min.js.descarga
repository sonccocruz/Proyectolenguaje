"use strict";define("Wit/Deployment",["require","exports","Wit/Common/Constants/CustomerInteligence","react","VSS/Core/Util/String","VSS/Platform/Layout","VSSUI/Card","VSSUI/Icon","VSSUI/Link","VSSUI/Status","VSSUI/TooltipEx","VSSUI/Util","VSSUI/Utilities/Date","VSSUI/Image","VSSUI/Spinner"],function(e,t,n,s,a,r,o,i,l,c,m,p,d,u,g){var h,y,I,S;h=t.Resources={},t.Resources.ZeroDataMessage1="To track releases associated with this work item, go to ",t.Resources.ZeroDataMessageLinkText="Releases",t.Resources.ZeroDataMessage2=" and turn on deployment status reporting for Boards in your pipeline's Options menu.",t.Resources.ZeroDataLearnMore="Learn more about deployment status reporting",t.Resources.Loading="Loading...",t.Resources.Pending="Pending",t.Resources.Inprogress="In-Progress",t.Resources.Successful="Succeeded",t.Resources.Canceled="Canceled",t.Resources.Failed="Failed",t.Resources.Rolledback="Rolled back",t.Resources.Unknown="Unknown",t.Resources.PipelineSecondaryText="{0} on {1}",t.Resources.Production="Production",t.Resources.Staging="Staging",t.Resources.Testing="Testing",t.Resources.Development="Development",t.Resources.Unmapped="Unmapped",y=t.Constants={},(t.Constants.DeploymentIntegrationConstants||(t.Constants.DeploymentIntegrationConstants={})).LearnMoreDeployments="https://aka.ms/boardsdeploymentintegration",t.Constants.environmentTypeOrderMap={production:5,staging:4,testing:3,development:2,unmapped:1},t.Contracts={},function(e){I=t[e]={},t[e].WITCIDeploymentsIntegrationFeature="DeploymentsIntegration",function(e){e.SHOW_ZERO_DATA="SHOW_ZERO_DATA",e.SHOW_DEPLOYMENTS="SHOW_DEPLOYMENTS",e.TOGGLE_PIPELINE="TOGGLE_PIPELINE"}(t[e].DeploymentsIntegrationCIActions||(t[e].DeploymentsIntegrationCIActions={})),t[e].publishDeploymentsIntegrationTrace=function(s,a,r={}){s.getService("IVssTraceService").traceError(n.WITCustomerIntelligenceArea,t[e].WITCIDeploymentsIntegrationFeature,a,r)},t[e].publishDeploymentsTelemetry=function(s,a,r={}){s.getService("IVssTelemetryService").publishEvent(n.WITCustomerIntelligenceArea,t[e].WITCIDeploymentsIntegrationFeature,Object.assign({action:a},r))}}("telemetryDeployments"),function(e){S=t.ComponentsPipelineCard={};t.ComponentsPipelineCard.PipelineCard=class extends r.VssComponent{constructor(e,t){super(e,t),this.toggleContentClick=(e=>{"A"!==e.target.tagName&&this.toggleContent()}),this.toggleContentEnter=(e=>{13===e.which&&this.toggleContent()}),this.toggleContent=(()=>{(0,I.publishDeploymentsTelemetry)(this.context.pageContext,I.DeploymentsIntegrationCIActions.TOGGLE_PIPELINE,{isExpanded:!this.state.isExpanded}),this.setState({isExpanded:!this.state.isExpanded})}),this.state={isExpanded:!1}}render(){const{pipeline:e}=this.props,{isExpanded:t}=this.state;return s.createElement(o.Card,{className:"pipeline-card",contentProps:{contentPadding:!1}},s.createElement("div",{className:"pipeline-container",onClick:this.toggleContentClick,onKeyDown:this.toggleContentEnter,role:"button",tabIndex:0},s.createElement("div",{className:"fixed-width"},this.getStatus(e.status)),s.createElement("div",{className:"content"},s.createElement("div",{className:"header"},s.createElement(l.Link,{className:"body-m primary-text title",href:e.url,target:"_blank"},e.name," (",e.stages.length,")"),s.createElement("div",{className:"body-s secondary-text text-ellipsis"},e.stages.length>0&&(0,a.format)(h.PipelineSecondaryText,(0,d.ago)(e.date),e.stages[0].name))),s.createElement("div",{className:(0,p.css)("stages",!t&&"collapsed")},this.renderStages(e.stages))),s.createElement("div",{className:"fixed-width"},s.createElement(i.Icon,{ariaLabel:"Chevron icon",iconName:"ChevronUp",className:(0,p.css)("chevron",!t&&"collapsed")}))))}getToolTipText(e){return`${this.localizedStatus(e.status)} ${(0,d.ago)(e.date)}`}renderStages(e){return e.map(e=>{const t=`${e.runId}-${e.name}-${e.sequenceNumber}`;return s.createElement(m.Tooltip,{text:this.getToolTipText(e),key:t},s.createElement("div",{className:"stage flex",key:t},this.getStatus(e.status),"Â ",s.createElement("span",{className:"body-s primary-text"},s.createElement(l.Link,{href:e.url,target:"_blank"},"#",e.runId),s.createElement(i.Icon,{ariaLabel:"Forward icon",className:"stage-arrow-icon",iconName:"Forward"})," ",e.name)))})}localizedStatus(e){switch(e){case"pending":return h.Pending;case"in_progress":return h.Inprogress;case"successful":return h.Successful;case"canceled":return h.Canceled;case"failed":return h.Failed;case"rolled_back":return h.Rolledback;default:return h.Unknown}}getStatus(e){const t={successful:c.Statuses.Success,failed:c.Statuses.Failed,unknown:c.Statuses.Failed,pending:c.Statuses.Waiting,in_progress:c.Statuses.Running,canceled:c.Statuses.Canceled,rolled_back:c.Statuses.Failed};return s.createElement(c.Status,Object.assign({},t[e],{key:e,size:"16",className:"deployment-status"}))}}}(),function(e){t.ComponentsDeployment={};class n extends r.VssComponent{constructor(e,t){super(e,t),this.releasesUrl="",this.updateDeploymentsData=(async()=>{const e=this.state.workItemId;let t;try{t=await this.fetchDeploymentsData()}catch(e){t=[],(0,I.publishDeploymentsIntegrationTrace)(this.context.pageContext,"DataProvider failed",e)}if(this._isMounted&&e===this.props.workItemId){const e=this.groupDeployments(t);this.setState({deployments:e,isLoading:!1})}}),this.fetchDeploymentsData=(async()=>await this.contributionService.getDataAsync("ms.vss-work-web.work-item-external-deployments-data-provider",{workItemId:this.state.workItemId})||[]),this.locationService=this.context.pageContext.getService("IVssLocationService"),this.contributionService=this.context.pageContext.getService("IVssContributionService");try{this.releasesUrl=this.locationService.routeUrl("ms.vss-releaseManagement-web.hub-explorer-3-default-route",{project:this.props.projectName})}catch(e){}this._isMounted=!1,this.state={deployments:null,workItemId:this.props.workItemId,isLoading:!0}}static getDerivedStateFromProps(e,t){return e.workItemId!==t.workItemId?{deployments:t.deployments,workItemId:e.workItemId,isLoading:!0}:null}render(){const{deployments:e,isLoading:t}=this.state;return s.createElement("div",{className:"deployment-control-container"},e&&e.length>0?this.renderDeploymentsDetails(e):this.renderZeroData(),t&&this.renderSpinner())}componentDidUpdate(e,t){this.state.isLoading&&this.updateDeploymentsData()}componentDidMount(){this._isMounted=!0,this.updateDeploymentsData()}componentWillUnmount(){this._isMounted=!1}localizedEnvironmentType(e){switch(e){case"production":return h.Production;case"testing":return h.Testing;case"development":return h.Development;case"staging":return h.Staging;default:return h.Unmapped}}groupDeployments(e){const t=[];return e.sort((e,t)=>y.environmentTypeOrderMap[t.environment.type]-y.environmentTypeOrderMap[e.environment.type]||t.statusDate.getTime()-e.statusDate.getTime()).forEach(e=>{let n=this.localizedEnvironmentType(e.environment.type),s=t.find(e=>e.name===n);s||(s={name:n,pipelines:[]},t.push(s));let a=s.pipelines.find(t=>t.id==e.pipeline.id);a||(a={name:e.pipeline.displayName,id:e.pipeline.id,status:e.status,date:e.statusDate,url:e.pipeline.url,stages:[]},s.pipelines.push(a));const r={name:e.environment.displayName,runId:e.runId,status:e.status,sequenceNumber:e.sequenceNumber,url:e.url,date:e.statusDate};a.stages.find(e=>e.name===r.name&&(e.runId>r.runId||e.runId===r.runId&&e.sequenceNumber>r.sequenceNumber))||(a.stages.push(r),"successful"===a.status&&(a.status=r.status))}),t}renderZeroData(){(0,I.publishDeploymentsTelemetry)(this.context.pageContext,I.DeploymentsIntegrationCIActions.SHOW_ZERO_DATA);const e=this.locationService.getAssetLocation("ms.vss-build-web/common-library/Nav-Launch.png");return s.createElement("div",{className:"deployments-zero-data"},s.createElement("div",{"aria-hidden":!0},s.createElement(u.Image,{className:"zero-data-icon",src:e})),this.getZeroDataMessage())}getZeroDataMessage(){return s.createElement("span",null,h.ZeroDataMessage1,this.releasesUrl?s.createElement(l.Link,{href:this.releasesUrl,target:"_blank"},h.ZeroDataMessageLinkText):h.ZeroDataMessageLinkText,h.ZeroDataMessage2," ",s.createElement(l.Link,{href:y.DeploymentIntegrationConstants.LearnMoreDeployments,target:"_blank"},h.ZeroDataLearnMore))}renderDeploymentsDetails(e){return(0,I.publishDeploymentsTelemetry)(this.context.pageContext,I.DeploymentsIntegrationCIActions.SHOW_DEPLOYMENTS,this.getPipelinesAndStagesCount(e)),s.createElement("div",null,e.map(e=>s.createElement("div",{key:e.name},s.createElement("div",{className:"body-m font-weight-semibold type-title"},e.name),e.pipelines.map(e=>s.createElement(S.PipelineCard,{pipeline:e,key:e.id})))))}renderSpinner(){return s.createElement("div",{className:"spinner-container"},s.createElement(g.Spinner,{className:"loading-spinner",size:"medium",label:h.Loading}))}getPipelinesAndStagesCount(e){let t=0,n=0;return e.forEach(e=>{e.pipelines.forEach(e=>{t++,n+=e.stages.length})}),{numPipelines:t,numStages:n}}}t.ComponentsDeployment.Deployment=n,r.VssComponent.register("DeploymentControl",n)}()},["Resources","Constants","Contracts","telemetry/Deployments","Components/PipelineCard","Components/Deployment"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.deployment"}}));