"use strict";define("WidgetCommon/WitUtils",["require","exports","VSS/Platform/Context","VSS/Platform/RestClientBase","VSS/Core/Util/String","VSS/Platform/Location","Tfs/Widget/Context","WidgetCommon/DateUtils/DateUtils"],function(e,t,r,o,a,i,n,s){var c,l,u,m,p,d,T,y,g;c=t.Constants={},(g=t.Constants.CoreFieldRefNames||(t.Constants.CoreFieldRefNames={})).Id="System.Id",g.Title="System.Title",g.WorkItemType="System.WorkItemType",(y=t.Constants.ActionUrl||(t.Constants.ActionUrl={})).ACTION="action",y.ACTION_QUERY="query",y.ACTION_EDIT="edit",(T=t.Constants.ActionParameters||(t.Constants.ActionParameters={})).TEMPQUERYID="tempQueryId",T.PATH="path",T.ID="id",(d=t.Constants.WorkItemStateCategory||(t.Constants.WorkItemStateCategory={}))[d.Proposed=1e3]="Proposed",d[d.InProgress=2e3]="InProgress",d[d.Resolved=3e3]="Resolved",d[d.Completed=4e3]="Completed",d[d.Removed=5e3]="Removed",function(e){var r;l=t[e]={},function(e){e[e.Global=0]="Global",e[e.Project=1]="Project",e[e.Team=2]="Team"}(r=t[e].LocalStorageScope||(t[e].LocalStorageScope={}));class o{constructor(e){this.context=e}write(e,t,o=r.Global){const a=this._getScopedKey(e,o);if(a)try{window.localStorage.setItem(a,JSON.stringify({v:t}))}catch(e){console.error("Failed to write to local storage: "+e)}}read(e,t,o=r.Global){const a=this._getScopedKey(e,o);if(a)try{const e=window.localStorage.getItem(a);if(e&&"string"==typeof e)return JSON.parse(e).v}catch(e){}return t}_getScopedKey(e,t){switch(t){case r.Global:return o.GLOBAL_SETTING_KEY+"/"+e;case r.Project:if(!this.context.projectId)return;return o.PROJECT_SETTING_KEY+"/"+this.context.projectId+"/"+e;case r.Team:if(!this.context.teamId)return;return o.TEAM_SETTING_KEY+"/"+this.context.teamId+"/"+e;default:return}}}t[e].LocalStorageWrapper=o,o.GLOBAL_SETTING_KEY="global",o.PROJECT_SETTING_KEY="project",o.TEAM_SETTING_KEY="team"}("LocalStorageLocalStorageWrapper"),function(e){u=t[e]={};t[e].TemporaryDataClientName="VelocityWidget-TemporaryData.ITemporaryDataRestClient",t[e].getTemporaryDataClient=function(r,o){return r.getRestClient(t[e].TemporaryDataClientName,o)},r.RestClients.add(t[e].TemporaryDataClientName,{factory:class extends o.RestClientBase{constructor(e){super(e)}async createTemporaryData(e,t){return this.beginRequest({apiVersion:"5.0-preview.1",method:"PUT",routeTemplate:"_apis/properties/{id}",routeValues:{id:t},body:e})}async getTemporaryData(e){return this.beginRequest({apiVersion:"5.0-preview.1",routeTemplate:"_apis/properties/{id}",routeValues:{id:e}})}},options:{serviceInstanceType:"00025394-6065-48ca-87d9-7f5672854ef7"}})}("TemporaryDataClientRestClientTemporaryData"),m=t.TempQueryUtils={},(t.TempQueryUtils.TempQueryUtils||(t.TempQueryUtils.TempQueryUtils={})).beginCreateTemporaryQueryId=function(e,t,r){const o=(0,u.getTemporaryDataClient)(e),i=(0,a.newGuid)(),n={queryText:t,queryType:r};return o.createTemporaryData({value:n},i).then(e=>e.id)},function(e){p=t.UrlUtils={};const r="ms.vss-work-web.query-route-basic";function o(e,t,o){return`${(0,i.routeUrl)(e,r,{project:t})}?${o}`}t.UrlUtils.getQueriesHubUrl=o,t.UrlUtils.getTempQueryUrl=function(e,t,r){return`${o(e,t,function(e){const t=[];for(const r in e){const o=e[r];if(null!=o){const e="action"===r?"_a":r;t.push(e+"="+encodeURIComponent(o))}}return t.join("&")}({[c.ActionUrl.ACTION]:c.ActionUrl.ACTION_QUERY,[c.ActionParameters.TEMPQUERYID]:r}))}`}}(),function(e){t.WiqlUrlBuilder={};class r{constructor(e){this.context=e,this._createdNewTempQueryId=!1}async BuildQueryURL(e,t,r){const o=this.context.getService("IVssLocationService"),a=(0,n.getProject)(this.context),i=o.routeUrl("ms.vss-work-web.query-search:route",{project:a.name,wiql:e,name:t});if(this.isUrlWithinConstraints(i))return Promise.resolve(i);try{const o=await this._buildTempQueryId(e,t,r);return Promise.resolve(p.getTempQueryUrl(this.context,a.name,o))}catch(e){return Promise.reject(e)}}_buildTempQueryId(e,t,o){const a=this._getWitLocalStorageInfo(o);let i=!0;if(this._createdNewTempQueryId=!1,a.Wiql===e){const e=(0,s.shiftToUtc)(new Date(Number(a.queryTimeStamp))),t=(0,s.shiftToUtc)(new Date);(0,s.daysBetweenDates)(e,t,!0)<r.COPY_QUERY_URL_DAYS_TO_EXPIRE&&(i=!1)}const n=t=>(this.setWitLocalStorageInfo({Wiql:e,tempQueryId:t,queryTimeStamp:(new Date).getTime().toString()},o),this._createdNewTempQueryId=!0,t),c=e=>e.message;return i?m.TempQueryUtils.beginCreateTemporaryQueryId(this.context,e,t).then(n,c):Promise.resolve(a.tempQueryId)}newTempQueryCreated(){return this._createdNewTempQueryId}_getWitLocalStorageInfo(e){const t={Wiql:"undefined",tempQueryId:"undefined",queryTimeStamp:(new Date).getTime().toString()},o=this.getLocalStorageWrapper(e).read(r.storageKey,void 0,l.LocalStorageScope.Project);if(void 0===o)return t;try{return JSON.parse(o)}catch(e){return t}}isUrlWithinConstraints(e){return e.length<=2e3}setWitLocalStorageInfo(e,t){this.getLocalStorageWrapper(t).write(r.storageKey,JSON.stringify(e),l.LocalStorageScope.Project)}getLocalStorageWrapper(e){return new l.LocalStorageWrapper({projectId:(0,n.getProject)(this.context).id,teamId:e})}}t.WiqlUrlBuilder.WiqlURLBuilder=r,r.COPY_QUERY_URL_DAYS_TO_EXPIRE=90,r.storageKey="WitWidgetTempQuery"}()},["Constants","LocalStorage/LocalStorageWrapper","TemporaryDataClient/RestClient/TemporaryData","TempQueryUtils","UrlUtils","WiqlUrlBuilder"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-dashboards-web.widget-wit-utils"}}));