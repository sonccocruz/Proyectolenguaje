"use strict";define("Widgets/VelocityWidget",["require","exports","WidgetCommon/ModernWidgetTypes/ActionCreatorBase","Tfs/Widget/LinkPermissionsHelper","VSS/Features/Charts/Contracts","WidgetCommon/ModernWidgetTypes/ChartOptionFactoryBase","Analytics/Boards/BoardsQueries/WitFieldUtilities","VSS/Core/Util/String","WidgetCommon/ModernWidgetTypes/CommonConfigurationTypes","WidgetCommon/WitUtils/Constants","Analytics/Boards/BoardsQueries/IterationsQuery","Reporting/Visuals/LayoutComponents/Widgets/Demands/DemandType","Reporting/Visuals/LayoutComponents/Widgets/LayoutState","Analytics/Boards/VelocityQueries/AggregationWorkItemTypeFieldsQuery","Analytics/Boards/VelocityQueries/CompletedLateMetastateByIterationDetailsQuery","Analytics/Boards/VelocityQueries/CompletedLateMetastateByIterationsQuery","Analytics/Boards/VelocityQueries/MetastateByIterationDetailsQuery","Analytics/Boards/VelocityQueries/MetastateByIterationsQuery","Analytics/Boards/VelocityQueries/PlannedWorkByDayDetailsQuery","Analytics/Boards/VelocityQueries/PlannedWorkByDayQuery","Dashboards/WidgetCommon/WidgetTelemetry","WidgetCommon/ModernWidgetTypes/WidgetDataManagerBase","WidgetCommon/WitUtils/WiqlUrlBuilder","Analytics/Boards/BoardsQueries/ProcessesQuery","Analytics/Common/Utilities/AnalyticsExceptionUtilities","Dashboards/WidgetCommon/DashboardsCacheableQueryService","Tfs/Widget/Context","WidgetCommon/ModernWidgetTypes/SettingsManagerBase","Analytics/Common/Resources","react","Reporting/Lightbox/Lightbox","VSS/Platform/Components/Format","VSS/Platform/Location","WidgetCommon/ModernWidgetTypes/ViewComponentBase","VSS/Platform/Layout"],function(e,t,o,a,i,r,n,s,l,c,d,g,y,m,u,p,C,h,W,k,V,I,S,D,f,M,T,x,A,v,R,w,L,P,_){var F,b,B,N,Q,E,O,q,U,j,K,H;F=t.Resources={},t.Resources.VelocityChart_CompletedLate_StateName="Completed Late",t.Resources.VelocityChart_Completed_StateName="Completed",t.Resources.VelocityChart_Incomplete_StateName="Incomplete",t.Resources.VelocityChart_Planned_StateName="Planned",t.Resources.KanbanTime_DefaultSettings_FailedToFindAnyBacklogsError="Please configure backlogs and try again.",t.Resources.VelocityWidget_IterationsSubtitle="Last {0} iterations",t.Resources.VelocityWidget_NoIterations="No iterations",t.Resources.VelocityWidget_SingleIterationSubtitle="Last iteration",t.Resources.Velocity_DefaultWidgetName="Velocity",t.Resources.VelocityWidget_AverageVelocity="Average Velocity",t.Resources.VelocityWidget_CountOfWorkItems="Count of work items",t.Resources.VelocityWidget_LearnMore="Learn more about the Velocity Widget",t.Resources.VelocityWidget_Loading="Loading...",t.Resources.MessageCard_Unconfigured="Configure widget",t.Resources.VelocityWidget_WidgetErrorFormat="Widget failed to load",t.Resources.VelocityWidget_ErrorDetails="More details",t.Resources.VelocityWidget_ErrorDetailsAriaLabel="More information about the widget error.",t.Resources.VelocityWidget_WidgetError="Widget error",t.Resources.ModernWidget_TeamSettingsErrorFormat="VS403646: Unable to retrieve team settings. {0}",t.Resources.VelocityWidget_LearnMoreLink="https://go.microsoft.com/fwlink/?LinkID=760415",t.Resources.VelocityWidget_SetIterationDatesAriaLabel="Set start and end dates for iterations",t.Resources.VelocityWidget_SetIterationDatesLink="Set iteration dates",t.Resources.VelocityWidget_UnexpectedAggregationError="Unexpected aggregation mode: '{0}'",t.Resources.VelocityWidget_NoPropNameFoundForAggregation="No property name found for aggregation setting: '{0}'",function(e){b=t.VelocityWidgetComponentsVelocityActionCreator={};t.VelocityWidgetComponentsVelocityActionCreator.VelocityActionCreator=class extends o.ActionCreatorBase{}}(),function(e){B=t.VelocityWidgetComponentsVelocityConstants={};class o{}t.VelocityWidgetComponentsVelocityConstants.VelocityConstants=o,o.featureName="VelocityWidget",o.queryResult="AggregationResult"}(),N=t[H="VelocityWidgetComponentsVelocityDataContract"]={},(K=t[H].WorkItemStateCategory||(t[H].WorkItemStateCategory={}))[K.Proposed=1e3]="Proposed",K[K.InProgress=2e3]="InProgress",K[K.Resolved=3e3]="Resolved",K[K.Completed=4e3]="Completed",K[K.Removed=5e3]="Removed",(j=t[H].WorkItemTypeFilterMode||(t[H].WorkItemTypeFilterMode={}))[j.WorkItemType=0]="WorkItemType",j[j.BacklogCategory=1]="BacklogCategory",function(e){Q=t.VelocityWidgetComponentsVelocityChartOptionFactory={};class o extends r.ChartOptionFactoryBase{constructor(e){super(),this.context=e}static handleClick(e,t,o){const a=t.seriesName,i=o[t.seriesDataIndex];e.handleChartClick({stateName:a,iteration:i,valueAtPoint:t.itemY})}static customTooltipMapping(e){return e.map(e=>{const t=(Math.round(10*+e.values[0])/10).toLocaleString();return{styleType:{color:e.color,type:1},text:`${e.seriesName}: ${t}`}})}createChartOptions(e){return e.isAdvancedChart?this.renderAdvanced(e):this.renderSimple(e)}renderAdvanced(e){const t=[];e.iterations.map((o,a)=>{t[a]=0,e.plannedWorkByDayResult&&e.plannedWorkByDayResult.map(e=>{o.IterationSK===e.IterationSK&&(t[a]=e.AggregationResult)})});const a=this.renderSimple(e);return a.series.forEach(e=>{e.stackGroup=o.endIterationStackGroup}),a.series.unshift({name:F.VelocityChart_Planned_StateName,data:t,stackGroup:o.startIterationStackGroup,color:"#86CCDE"}),a}renderSimple(e){const t=[],r=[],n=[],s=[],l=a.LinkPermissionsHelper.canUserAccessWITQueriesPage(this.context);e.iterations.map((o,a)=>{o.IterationName&&s.push(o.IterationName),t[a]=0,n[a]=0,r[a]=0,null!=e.completedLateResult&&e.completedLateResult.map(e=>{o.IterationSK===e.IterationSK&&(r[a]=e.AggregationResult)}),e.metastateResult.map(e=>{o.IterationSK===e.IterationSK&&(e.StateCategory===N.WorkItemStateCategory[N.WorkItemStateCategory.Completed]?t[a]=e.AggregationResult-r[a]:e.StateCategory===N.WorkItemStateCategory[N.WorkItemStateCategory.InProgress]&&(n[a]=e.AggregationResult))})});const c={pageContext:this.context,chartType:i.ChartTypesConstants.StackedColumn,series:[{name:F.VelocityChart_Completed_StateName,data:t,color:"#107c10"},{name:F.VelocityChart_Incomplete_StateName,data:n,color:"#0078d4"}],xAxis:{labelValues:s},tooltip:{customTooltipMapping:o.customTooltipMapping},legendClick:t=>e.velocityClickHandler.handleLegendClick(),suppressAnimation:e.suppressAnimations};return l&&(c.click=(t=>o.handleClick(e.velocityClickHandler,t,e.iterations))),null!=e.completedLateResult&&c.series.splice(1,0,{name:F.VelocityChart_CompletedLate_StateName,data:r,color:"#8DC54B"}),c}}t.VelocityWidgetComponentsVelocityChartOptionFactory.VelocityChartOptionFactory=o,o.startIterationStackGroup="start",o.endIterationStackGroup="end"}(),function(e){E=t.VelocityWidgetComponentsVelocityDataHelper={};class o{static getScalarMeasure(e,t){switch(t.identifier){case l.AggregationMode.Sum:return o.getWorkItemTypeFieldName(e,t.settings);case l.AggregationMode.Count:return F.VelocityWidget_CountOfWorkItems}}static getQueryAggregation(e){switch(e.identifier){case l.AggregationMode.Sum:const t=n.WitFieldUtilities.getFieldODataPropertyName(e.settings);if(null==t||0===t.trim().length)throw new Error((0,s.format)(F.VelocityWidget_NoPropNameFoundForAggregation,e.settings));return`aggregate(${t} with sum as ${B.VelocityConstants.queryResult})`;case l.AggregationMode.Count:return`aggregate($count as ${B.VelocityConstants.queryResult})`;default:throw new Error((0,s.format)(F.VelocityWidget_UnexpectedAggregationError,e.identifier))}}static getAverageVelocity(e,t){let o=0,a=0;return t.map(t=>{t.IsEnded&&(e.map(e=>{e.StateCategory===c.WorkItemStateCategory[c.WorkItemStateCategory.Completed]&&e.IterationSK===t.IterationSK&&(o+=e.AggregationResult)}),a++)}),a>0?Math.round(o/a):0}static getSubtitle(e){return 1===e?F.VelocityWidget_SingleIterationSubtitle:e>1?(0,s.format)(F.VelocityWidget_IterationsSubtitle,e.toString()):F.VelocityWidget_NoIterations}static getWorkItemTypeFieldName(e,t){let o="";for(const a of e)if(!(0,s.localeIgnoreCaseComparer)(a.FieldReferenceName,t)){o=a.FieldName;break}return o}}t.VelocityWidgetComponentsVelocityDataHelper.VelocityDataHelper=o}(),t.VelocityWidgetComponentsVelocitySettings={},function(e){O=t.VelocityWidgetComponentsVelocityDataManager={};t.VelocityWidgetComponentsVelocityDataManager.VelocityDataManager=class extends I.WidgetDataManagerBase{constructor(e,t,o="Velocity"){super(e,t),this.command=o,this.dataService=this.context.getService(M.IDashboardsCacheableQueryServiceName),this.teamContext=t.widgetTelemetryProps.teamContext}async getData(){const e=new Set;if(this.demandTracker.isDemandPresent(g.DemandType.subtitle)||this.demandTracker.isDemandPresent(g.DemandType.scalar)||this.demandTracker.isDemandPresent(g.DemandType.chart)){const t=JSON.parse(this.settings||""),o=t.teamId,a=t.projectId,i=t.numberOfIterations,r=t.aggregation;r.settings||(r.settings="");const n=this.getIterations(a,o,i,e);return this.getWorkItemTypes(t).then(i=>n.then(async n=>{if(n&&n.length>0){const s=[];n.filter(e=>e.IterationSK).map(e=>{s.push(e.IterationSK)});const l=this.getMetastate(s,a,o,r,i,e),c=null!=t.lateWorkDelay?this.getCompletedLateMetastate(n,a,o,r,i,t.lateWorkDelay,e):Promise.resolve(void 0),d=null!=t.plannedWorkDelay?this.getPlannedWorkByDay(a,o,n,r,i,t.plannedWorkDelay,e):Promise.resolve(void 0),g=this.getAggregationWorkItemTypeFields(a),[m,u,p,C]=await Promise.all([l,c,d,g]);if(0===m.length)return this.packMessageAsState(y.MessageType.NoData);this.queryContext={velocitySettings:t,workItemTypes:i};const h={velocityClickHandler:this,iterations:n,metastateResult:m,plannedWorkByDayResult:p,completedLateResult:u,suppressAnimations:this.suppressAnimations,isAdvancedChart:null!=t.plannedWorkDelay},W=await new Q.VelocityChartOptionFactory(this.context).createChartOptions(h);return this.currentState={showMessage:!1,title:{text:this.title},subtitle:{text:E.VelocityDataHelper.getSubtitle(n.length)},scalarData:{description:F.VelocityWidget_AverageVelocity,measure:E.VelocityDataHelper.getScalarMeasure(C,r),value:m&&m.length>0?E.VelocityDataHelper.getAverageVelocity(m,n):0},chartData:{chartOptions:W},warningsData:Array.from(e)},this.currentState}return this.packMessageAsState(y.MessageType.SetIterationDates)})).then(null,e=>{let t=y.MessageType.WidgetError;(0,f.recognizeAnalyticsException)(e)===f.AnalyticsExceptionType.DataNotReady&&(t=y.MessageType.AxFaultIn),(0,f.recognizeAnalyticsException)(e)===f.AnalyticsExceptionType.MissingAnalyticsPermissions&&(t=y.MessageType.MissingPermissions);const o=(0,f.extractODataError)(e);return this.packMessageAsState(t,o)})}return Promise.resolve(this.currentState)}handleLegendClick(){V.onWidgetClick(this.context,this.widgetPropsForTelemetry,{linkDescription:"LegendClicked"})}handleChartClick(e,t){if(e.valueAtPoint){const o=window.open();let a;switch(e.stateName){case F.VelocityChart_Planned_StateName:a=this.getPlannedWorkByDayDetails(this.queryContext.velocitySettings.projectId,this.queryContext.velocitySettings.teamId,e.iteration,this.queryContext.workItemTypes,this.queryContext.velocitySettings.plannedWorkDelay);break;case F.VelocityChart_CompletedLate_StateName:a=this.getCompletedLateMetastateDetails(this.queryContext.velocitySettings.projectId,this.queryContext.velocitySettings.teamId,e.iteration,this.queryContext.workItemTypes,this.queryContext.velocitySettings.lateWorkDelay,t);break;case F.VelocityChart_Completed_StateName:a=this.getCompletedMetastateDetails(this.queryContext.velocitySettings.projectId,this.queryContext.velocitySettings.teamId,e.iteration,this.queryContext.workItemTypes,this.queryContext.velocitySettings.lateWorkDelay,t);break;case F.VelocityChart_Incomplete_StateName:a=this.getIncompleteMetastateDetails(this.queryContext.velocitySettings.projectId,this.queryContext.velocitySettings.teamId,e.iteration,this.queryContext.workItemTypes,t);break;default:a=null}null!=a&&a.then(t=>{const a=t.map(e=>e.WorkItemId);V.onWidgetClick(this.context,this.widgetPropsForTelemetry,{linkDescription:"ChartClicked"}),null!=o&&this.navigateToWorkItemList(e.stateName||"",e.iteration,a,o)}).then(void 0,e=>{V.onWidgetFailure(this.context,this.widgetPropsForTelemetry,"Failure handling chart click in Velocity Chart.","handleChartClick",{ErrorDetail:JSON.stringify(e)})})}}async getWorkItemTypes(e){if(e.workItemTypeFilter.identifier===N.WorkItemTypeFilterMode[N.WorkItemTypeFilterMode.BacklogCategory]){const t=this.context.getService(M.IDashboardsCacheableQueryServiceName),o=D.ProcessesQuery.onTeam(this.context,e.projectId,e.teamId),a=await t.getCacheableQueryResult(o),i=e.workItemTypeFilter.settings;return a.map(e=>e.BacklogCategoryReferenceName===i?e.WorkItemType:"").filter(e=>""!=e)}return Promise.resolve([e.workItemTypeFilter.settings])}getIterations(e,t,o,a){const i=d.IterationsQuery.onTeam(e,t,o);return this.runQuery("getIterations",i,void 0,a)}getMetastate(e,t,o,a,i,r){const n=new h.MetastateByIterationsQuery(this.command,t,o,e,a,i);return this.runQuery("getMetastate",n,void 0,r)}getCompletedLateMetastate(e,t,o,a,i,r,n){const s=new p.CompletedLateMetastateByIterationsQuery(this.command,t,o,e,a,i,r);return this.runQuery("getCompletedLateMetastate",s,void 0,n)}getPlannedWorkByDay(e,t,o,a,i,r,n){const s=new k.PlannedWorkByDayQuery(this.command,e,t,o,a,i,r);return this.runQuery("getPlannedWorkByDay",s,void 0,n)}getIncompleteMetastateDetails(e,t,o,a,i){const r=new C.MetastateByIterationDetailsQuery(this.command,o.IterationSK||"",e,t,a);return this.runQuery("getMetastate",r,e=>Promise.resolve(e.filter(e=>e.StateCategory===N.WorkItemStateCategory[N.WorkItemStateCategory.InProgress])),i)}getCompletedLateMetastateDetails(e,t,o,a,i,r){const n=new u.CompletedLateMetastateByIterationDetailsQuery(this.command,o,e,t,a,i);return this.runQuery("getCompletedLateMetastate",n,void 0,r)}getPlannedWorkByDayDetails(e,t,o,a,i,r){const n=new W.PlannedWorkByDayDetailsQuery(this.command,e,t,o,a,i);return this.runQuery("getPlannedWorkByDay",n,void 0,r)}getAggregationWorkItemTypeFields(e){const t=new m.AggregationWorkItemTypeFieldsQuery(this.command,e);return this.runQuery("getAggregationWorkItemTypeFields",t)}getCompletedMetastateDetails(e,t,o,a,i,r){const n=new C.MetastateByIterationDetailsQuery(this.command,o.IterationSK||"",e,t,a);let s=Promise.resolve([]);return null!=i&&(s=this.getCompletedLateMetastateDetails(e,t,o,a,i)),this.runQuery("getMetastate",n,e=>s.then(t=>{const o=e.filter(e=>e.StateCategory===N.WorkItemStateCategory[N.WorkItemStateCategory.Completed]);return this.arraySubtract(o,t)}),r)}runQuery(e,t,o,a){o||(o=(e=>Promise.resolve(e)));const i=V.executeAndTimeAsync(this.context,B.VelocityConstants.featureName,e,()=>this.dataService.getCacheableQueryResult(t).then(o),f.extractODataError);return this.addDataQualityWarnings(this.dataService.getDataQualityWarnings(t),a),i}navigateToWorkItemList(e,t,o,a){const i=`SELECT [${c.CoreFieldRefNames.Id}],[${c.CoreFieldRefNames.WorkItemType}],[${c.CoreFieldRefNames.Title}] `+`FROM WorkItems WHERE [${c.CoreFieldRefNames.Id}] IN ({0})`,r=(0,s.format)(i,o.join(",")),n=`${this.title} - ${t.IterationName} - ${e}`;this.navigateToQueryPage(r,n,a)}navigateToQueryPage(e,t,o){new S.WiqlURLBuilder(this.context).BuildQueryURL(e,t,this.teamContext.id).then(e=>{o.location.href=e})}arraySubtract(e,t){return e.filter(e=>t.findIndex(t=>t.WorkItemId===e.WorkItemId)<0)}addDataQualityWarnings(e,t){t&&e.then(e=>{e.forEach(e=>{t.add(e)})})}}}(),function(e){q=t[e]={};function o(e,t,o,a){return{lastArtifactName:void 0,teamId:e.teamId,projectId:e.projectId,aggregation:o||{identifier:l.AggregationMode.Count,settings:""},lateWorkDelay:0,plannedWorkDelay:0,numberOfIterations:a||6,workItemTypeFilter:{identifier:N.WorkItemTypeFilterMode[N.WorkItemTypeFilterMode.BacklogCategory],settings:t||"Microsoft.RequirementCategory"}}}t[e].default=class extends x.SettingsManagerBase{constructor(e,t){super(),this.pageContext=e,this.teamContext=t}getFeatureName(){return B.VelocityConstants.featureName}generateDefaultSettings(){const e=this.packContext(this.teamContext);return Promise.resolve(o(e))}packContext(e){return{teamId:e.id,projectId:T.getProject(this.pageContext).id}}},t[e].packSettings=o}("VelocityWidgetComponentsVelocitySettingsManager"),function(e){U=t.VelocityWidgetComponentsVelocityViewComponent={};t.VelocityWidgetComponentsVelocityViewComponent.default=class extends P.ViewComponentBase{constructor(e){super(e)}createDataManager(e){return new O.VelocityDataManager(this.props.context,e,this.computeCommandName())}createActionCreator(){return new b.VelocityActionCreator(this.props.context,this.dataManager,this.store,this.actions,B.VelocityConstants.featureName,f.extractODataError)}createSettingsManager(){return new q.default(this.props.context,this.props.teamContext)}getMessageOptions(){let e;switch(this.getStoreState().messageType){case y.MessageType.AxFaultIn:e={actionText:F.VelocityWidget_LearnMore,actionAriaLabel:F.VelocityWidget_LearnMore,actionOnClickDelegate:()=>window.open(F.VelocityWidget_LearnMoreLink,"_blank")};break;case y.MessageType.SetIterationDates:const t=(0,L.routeUrl)(this.context.pageContext,"ms.vss-admin-web.project-admin-hub-route",{project:(0,T.getProject)(this.props.context).name,adminPivot:"work"});e={actionText:F.VelocityWidget_SetIterationDatesLink,actionAriaLabel:F.VelocityWidget_SetIterationDatesAriaLabel,actionOnClickDelegate:()=>window.open(t,"_blank")};break;case y.MessageType.MissingPermissions:e={actionOnClickDelegate:()=>{(0,R.showActionRequiredDialog)(this.context.pageContext,A.PermissionDeniedTitleText,v.createElement(w.FormatComponent,{format:A.PermissionDeniedDetailText},v.createElement("a",{href:A.PermissionDeniedDetailLinkAddress},A.PermissionDeniedDetailLinkText)))}};break;default:e=void 0}return e}packWidgetLoadedTelemetryData(e){return e&&this.props.teamContext?{WorkItemFilterKey:e.workItemTypeFilter.identifier,WorkItemFilterValue:e.workItemTypeFilter.identifier,AggregationKey:l.AggregationMode[e.aggregation.identifier],AggregationValue:e.aggregation.settings,NumberOfIterations:e.numberOfIterations,LateWorkDelayEnabled:void 0!==e.lateWorkDelay,LateWorkDelay:e.lateWorkDelay,PlannedWorkDelayEnabled:void 0!==e.plannedWorkDelay,PlannedWorkDelay:e.plannedWorkDelay}:{}}computeCommandName(){return"embedded-View"===this.props.presentationMode?"VelocityReport":"Velocity"}}}(),function(e){t.VelocityWidget={};class o extends _.VssComponent{constructor(e,t){super(e,t)}render(){return v.createElement(U.default,Object.assign({},this.props,{context:this.context.pageContext,suppressAnimations:!this.props.showLoadAnimations,onRenderCompletion:this.props.onWidgetLoaded}))}}t.VelocityWidget.VelocityWidget=o,o.componentType="velocityWidget",_.VssComponent.register(o.componentType,o)}()},["Resources","VelocityWidgetComponents/VelocityActionCreator","VelocityWidgetComponents/VelocityConstants","VelocityWidgetComponents/VelocityDataContract","VelocityWidgetComponents/VelocityChartOptionFactory","VelocityWidgetComponents/VelocityDataHelper","VelocityWidgetComponents/VelocitySettings","VelocityWidgetComponents/VelocityDataManager","VelocityWidgetComponents/VelocitySettingsManager","VelocityWidgetComponents/VelocityViewComponent","VelocityWidget"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-dashboards-web.velocity-widget-content"}}));