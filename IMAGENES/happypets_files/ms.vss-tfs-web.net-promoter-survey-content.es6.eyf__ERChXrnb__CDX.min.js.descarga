"use strict";define("TFS/NetPromoterSurvey",["require","exports","VSS/Platform/Context","VSS/Platform/RestClientBase","VSS/Platform/Util/Cookie","VSS/Core/Util/String","VSS/Platform/Trace","OfficeFabric/Label","react","OfficeFabric/Dropdown","VSSUI/Button","VSSUI/Checkbox","VSSUI/Link","VSSUI/TextField","VSS/Platform/Layout","VSSUI/Icon","VSS/Platform/Feature","VSS/Platform/UserClaims"],function(e,t,o,s,n,a,r,i,c,l,m,u,d,p,h,g,y,S){var b,v,D,C,I,R,P,N,f;b=t.Resources={},t.Resources.AzureDevOpsBrandName="Azure DevOps",t.Resources.BrandNameTemplate="Azure {0}",t.Resources.CloseButtonTitle="Close",t.Resources.ContactMeLabel="It's okay to contact me for more details on my comments.",t.Resources.PrivacyLabel="Your privacy is important to us.",t.Resources.PrivacyUrl="https://go.microsoft.com/fwlink/?LinkId=264782",t.Resources.ReasonLabel="Please explain why you gave this score.",t.Resources.RoleLabel="What is your primary role?",t.Resources.RoleList="Analyst,Architect,Designer,DevOps,Developer,ITPro,Management,Product Owner,Project Manager,Student,Tester/QA,Other",t.Resources.RolePlaceholder="i.e. Project Manager, Engineer, etc.",t.Resources.Score0Label="Not likely",t.Resources.Score10Label="Extremely likely",t.Resources.ScoreLabel="How likely are you to recommend {0} to a colleague?",t.Resources.Step0Title="",t.Resources.Step1Title="Thanks for your feedback. Why did you give {0} a {1}?",t.Resources.Step2Title="Thanks for your feedback!",t.Resources.SubmitLabel="Submit",t.Resources.SuiteName="DevOps",t.Resources.ThankYouBody="Our goal is to create the best possible product for you and your team. Your thoughts, ideas, and suggestions play a major role in helping us identify opportunities to improve.",t.Resources.VSTSBrandName="Azure DevOps Services",function(e){t[e]={};t[e].InteractionClientName="IInteractionRestClient",t[e].getInteractionClient=function(o,s){return o.getRestClient(t[e].InteractionClientName,s)},o.RestClients.add(t[e].InteractionClientName,{factory:class extends s.RestClientBase{constructor(e){super(e)}async add(e){return this.beginRequest({apiVersion:"3.2-preview.1",method:"POST",routeTemplate:"_apis/Interaction/Interaction",body:e})}async get(e){const t={interactionId:e};return this.beginRequest({apiVersion:"3.2-preview.1",routeTemplate:"_apis/Interaction/Interaction",queryParams:t})}},options:{serviceInstanceType:"00000041-0000-8888-8000-000000000000"}})}("clientRestClientInteraction"),function(e){t[e]={};t[e].RecommendationClientName="IRecommendationRestClient",t[e].getRecommendationClient=function(o,s){return o.getRestClient(t[e].RecommendationClientName,s)},o.RestClients.add(t[e].RecommendationClientName,{factory:class extends s.RestClientBase{constructor(e){super(e)}async read(e){const t={engagementId:e};return this.beginRequest({apiVersion:"3.2-preview.1",routeTemplate:"_apis/Recommendation/EngagementData",queryParams:t})}async readEngagementIds(){return this.beginRequest({apiVersion:"3.2-preview.1",routeTemplate:"_apis/Recommendation/EngagementData"})}async write(e){return this.beginRequest({apiVersion:"3.2-preview.1",method:"POST",routeTemplate:"_apis/Recommendation/EngagementData",body:e})}async logRecommendation(e,t){const o={type:e,engagementId:t};return this.beginRequest({apiVersion:"3.2-preview.1",method:"POST",routeTemplate:"_apis/Recommendation/RecommendationHistory",queryParams:o})}async getEngagementRecommendation(e){return this.beginRequest({apiVersion:"3.2-preview.1",method:"POST",routeTemplate:"_apis/Recommendation/Recommendations",body:e})}async getRecommendations(e,t){const o={type:e,input:t};return this.beginRequest({apiVersion:"3.2-preview.1",routeTemplate:"_apis/Recommendation/Recommendations",queryParams:o})}},options:{serviceInstanceType:"00000041-0000-8888-8000-000000000000"}})}("clientRestClientRecommendation"),v=t.Common={},(f=t.Common.DataKeys||(t.Common.DataKeys={})).AnonymousAccess="AnonymousAccess",f.ContactMe="OkToContactMe",f.DeferredTimes="DeferredTimes",f.ExitMethod="ExitMethod",f.FeatureAvailability="FeatureAvailability",f.HubGroupId="HubGroupId",f.HubId="HubId",f.Interaction="Interaction",f.InteractionType="InteractionType",f.MaxAllowableDeferTimes="MaxAllowableDeferTimes",f.Navigation="Navigation",f.NPSDebugCookieEnabled="NPSDebugCookieEnabled",f.OperationDate="OperationDate",f.ProductName="ProductName",f.PromptId="PromptId",f.Reason="Reason",f.Response="Response",f.Score="Score",f.SurveyId="SurveyId",f.Url="Url",f.UserRole="UserRole",f.VerticalNavigationEnabled="VerticalNavigationEnabled",function(e){var o;D=t.RecommendersRecommender={},function(e){e.EngagementId="EngagementId",e.InteractionIds="InteractionIds",e.AccountId="AccountId",e.CollectionId="CollectionId",e.ProjectId="ProjectId",e.PageId="PageId",e.ProductName="ProductName"}(o=t.RecommendersRecommender.DataConstants||(t.RecommendersRecommender.DataConstants={}));class s{constructor(e,t){this._context=e,this._productName=t}recommmend(){const e=this._context.getRestClient("IRecommendationRestClient"),t={},a="00000000-0000-0000-0000-000000000000";t[o.EngagementId]=s.NetPromoterSurveyId,t[o.AccountId]=a,t[o.CollectionId]=a,t[o.ProjectId]=a,t[o.ProductName]=this._productName;const r={recommendationInputData:t,recommendationType:1};if("TRUE"===(0,n.getCookie)("TFS-NPS-DEBUG")){const e={};return e[v.DataKeys.DeferredTimes]="0",e[v.DataKeys.MaxAllowableDeferTimes]="3",e[v.DataKeys.NPSDebugCookieEnabled]="TRUE",e[v.DataKeys.PromptId]="DEBUG",Promise.resolve({isPositive:!0,data:e})}return new Promise(t=>{e.getEngagementRecommendation(r).then(e=>{const n=e.recommendationData[o.EngagementId];n&&n.toLowerCase()===s.NetPromoterSurveyId.toLowerCase()&&t({isPositive:!0,data:e.recommendationData}),t({isPositive:!1})}).catch(()=>t({isPositive:!1}))})}logRecommendation(){return this._context.getRestClient("IRecommendationRestClient").logRecommendation(5,s.NetPromoterSurveyId)}logInteraction(e){const t=this._context.getRestClient("IInteractionRestClient"),o={id:s.NetPromoterSurveyId,accountId:"00000000-0000-0000-0000-000000000000",projectId:"00000000-0000-0000-0000-000000000000",timestamp:new Date,interactionInputData:e};return t.add(o)}}t.RecommendersRecommender.Recommender=s,s.NetPromoterSurveyId="NetPromoterSurvey"}(),function(e){C=t.RecommendersAnonymousRecommender={};class o{constructor(e){this._getNPSData=(e=>{const t=e.getService("IVssContributionService"),o="ms.vss-tfs-web.net-promoter-survey-context";return t.getDataAsync(o).then(e=>{if(e){const t={samplingRate:e.samplingRate,delayInDaysForSubmit:e.delayInDaysForSubmit,delayInDaysForPostpone:e.delayInDaysForPostpone,maxAllowableDeferTimes:e.maxAllowableDeferTimes,minDelayInHoursBetweenPrompts:e.minDelayInHoursBetweenPrompts};return Promise.resolve(t)}return Promise.reject(void 0)}).catch(e=>((0,r.traceError)(this._context,"Engagement","NetPromoterSurvey",(0,a.format)("Data provider {0} failed: {1}",o,e)),Promise.reject(void 0)))}),this._context=e}recommmend(){return new Promise(e=>{this._getNPSData(this._context).then(t=>{this.settings=t;const s=localStorage.getItem(o.LocalStorageRecommendationKey);null==s&&this.logRecommendation();const n=new Date(Number(s)),a=JSON.parse(localStorage.getItem(o.LocalStorageInteractionKey)||"{}",(e,t)=>"timestamp"===e?new Date(t):t);let r;this.shouldPrompt(n,a).then(t=>{t&&((r=a&&a.interactionInputData?a.interactionInputData:{})[v.DataKeys.AnonymousAccess]="true",r[D.DataConstants.EngagementId]="NetPromoterSurvey",r[v.DataKeys.MaxAllowableDeferTimes]=this.settings.maxAllowableDeferTimes.toString()),e({isPositive:t,data:r})})})})}logRecommendation(){return new Promise(e=>{localStorage.setItem(o.LocalStorageRecommendationKey,(new Date).getTime().toString()),e()})}logInteraction(e){return new Promise(()=>{const t={id:"NetPromoterSurvey",accountId:"00000000-0000-0000-0000-000000000000",projectId:"00000000-0000-0000-0000-000000000000",timestamp:new Date,interactionInputData:e};localStorage.setItem(o.LocalStorageInteractionKey,JSON.stringify(t))})}shouldPrompt(e,t){return new Promise(o=>{this.evaluateLastRecommendationDate(e)||o(!1),this.evaluateNextPromptDate(t)||o(!1),this.isUserInRandomSample()||o(!1),o(!0)})}evaluateLastRecommendationDate(e){if(e.getTime()!==new Date(Number(null)).getTime()){const t=this.settings.minDelayInHoursBetweenPrompts;if(null!=e)return((new Date).getTime()-e.getTime())/36e5>t}return!1}evaluateNextPromptDate(e){if(e&&e.interactionInputData&&e.interactionInputData[v.DataKeys.InteractionType]){const t=this.getNextPromptDate(e.timestamp,e.interactionInputData[v.DataKeys.InteractionType]);if((new Date).getTime()<t.getTime())return!1}return!0}isUserInRandomSample(){const e=this.settings.samplingRate;return this._random((new Date).getTime())<e}getNextPromptDate(e,t){const o=new Date(e.getTime());let s=this.settings.delayInDaysForSubmit;return"postpone"===t.toLowerCase()&&(s=this.settings.delayInDaysForPostpone),o.setDate(e.getDate()+s),o}_random(e){const t=1e4*Math.sin(e++);return t-Math.floor(t)}}t.RecommendersAnonymousRecommender.AnonymousRecommender=o,o.LocalStorageRecommendationKey="NetPromoterSurvey_Recommendation",o.LocalStorageInteractionKey="NetPromoterSurvey_Interaction"}(),function(e){I=t.ComponentsScoreChoiceGroup={};t.ComponentsScoreChoiceGroup.ScoreChoiceGroup=(e=>{const t=[];for(let o=0;o<=e.scoreCount;o++){const s=e.selected===o,n="nps-score-choice"+o.toString();t.push(c.createElement("li",{key:o.toString(),className:"nps-score-choice"},c.createElement("input",{type:"radio",id:n,name:n,checked:s,onChange:()=>e.onChange({score:o}),onClick:()=>{e.onClick&&e.onClick()}}),c.createElement("label",{className:"fontSizeM fontWeightSemiBold"+(s?" selected":""),htmlFor:n},o)))}return c.createElement("div",{className:"nps-score"},c.createElement(i.Label,{className:"fontSizeM fontWeightSemiBold nps-score-label"},e.label),c.createElement("ul",null,t),c.createElement("div",{className:"fontSizeS fontWeightSemiBold flex-row"},c.createElement("span",{className:"flex-grow"},b.Score0Label),c.createElement("span",null,b.Score10Label)))})}(),function(e){R=t.ComponentsSubmissionDetail={};t.ComponentsSubmissionDetail.SubmissionDetail=(e=>{const t=e.roleList.split(",").map(e=>({key:e,text:e}));return c.createElement("div",null,c.createElement(i.Label,{className:"fontSizeM fontWeightSemiBold"},e.reasonLabel),c.createElement(p.TextField,{className:"nps-dialog-reason",multiline:!0,rows:3,resizable:!1,value:e.reason,onChange:(t,o)=>{e.onChange({reason:o})}}),c.createElement(l.Dropdown,{calloutProps:{directionalHintFixed:!1},label:e.roleLabel,placeholder:e.rolePlaceholder,options:t,selectedKey:e.role,onChanged:t=>{e.onChange({role:t.key.toString()})}}),!e.hideContactConsented&&c.createElement(u.Checkbox,{className:"nps-contact-consented-checkbox",label:e.contactConsentedLabel,checked:!!e.contactConsented,onChange:(t,o)=>{e.onChange({contactConsented:o})}}),c.createElement("div",{className:"flex-row nps-dialog-footer"},c.createElement(d.Link,{className:"flex-grow flex-self-center",target:"_blank",href:e.privacyUrl},e.privacyText),c.createElement(m.Button,{primary:!0,onClick:e.onSubmit,text:b.SubmitLabel,disabled:e.submitDisabled})))})}(),function(e){P=t.ComponentsStepByStepSurveyDialog={};t.ComponentsStepByStepSurveyDialog.StepByStepSurveyDialog=class extends h.VssComponent{constructor(e){super(e),this.next=(()=>{if(this.state.step+1===2&&void 0===this.props.response.score)return document.removeEventListener("mousedown",this._handleClick),void this.props.close();this.setState({step:this.state.step+1})}),this.step0=(()=>c.createElement(I.ScoreChoiceGroup,{selected:this.props.response.score,scoreCount:10,label:(0,a.format)(b.ScoreLabel,this.props.productName),labelMinimum:b.Score0Label,labelMaximum:b.Score10Label,onChange:e=>{this.props.change(e),this.props.submit(Object.assign(Object.assign({},this.props.response),e),"score-click")},onClick:()=>{this.next()}})),this.step1=(()=>c.createElement("div",null,c.createElement(d.Link,{onClick:()=>{this.setState({step:0})},target:"_blank"},c.createElement(g.Icon,{iconName:"Back"})," Back"),c.createElement(R.SubmissionDetail,{reason:this.props.response.reason,reasonLabel:(0,a.format)(b.Step1Title,this.props.productName,this.props.response.score),role:this.props.response.role,roleLabel:b.RoleLabel,roleList:b.RoleList,rolePlaceholder:b.RolePlaceholder,hideContactConsented:!this.props.isAuthenticated,contactConsentedLabel:b.ContactMeLabel,contactConsented:this.props.response.contactConsented,privacyText:b.PrivacyLabel,privacyUrl:b.PrivacyUrl,onChange:this.props.change,onSubmit:()=>{this.next(),this.props.submit(this.props.response,"submit")}}))),this.step2=(()=>c.createElement("div",null,c.createElement(i.Label,{className:"fontSizeM fontWeightSemiBold"},b.Step2Title),c.createElement("p",null,b.ThankYouBody))),this._handleClick=(()=>{2===this.state.step&&(document.removeEventListener("mousedown",this._handleClick),this.props.close())}),this.state={step:0},document.addEventListener("mousedown",this._handleClick)}render(){switch(this.state.step){case 0:return this.step0();case 1:return this.step1();case 2:return this.step2();default:return c.createElement("div",null)}}}}(),function(e){var o;N=t.SurveyComponent={},function(e){e.AreaName="Survey",e.SubmitFeature="User.Submit",e.PostponeFeature="User.Postpone",e.AppearFeature="Dialog.Appear",e.CloseFeature="Dialog.Close"}(o||(o={}));t.SurveyComponent.SurveyComponent=class extends h.VssComponent{constructor(e,t){super(e,t),this._handleChange=(e=>{this.setState({response:Object.assign(Object.assign({},this.state.response),e)})}),this._appear=(()=>{this.publishTelemetry(o.AppearFeature,{})}),this._close=(()=>{this.setState({showSurvey:!1},()=>{this.publishTelemetry(o.CloseFeature,{}),this.props.onDismiss()})}),this._submit=((e,t)=>{const s=this._buildTelemetryData(e,"submit",0,t,!0);this.props.recommender.logInteraction(this._buildInteractionData("submit",0)),this.publishTelemetry(o.SubmitFeature,s),this.setState({hasScoreBeenSubmitted:!0})}),this._postpone=((e,t)=>{if(this._close(),!this.state.hasScoreBeenSubmitted){let s="postpone",n=(Number(this.props.data[v.DataKeys.DeferredTimes])||0)+1;n>=Number(this.props.data[v.DataKeys.MaxAllowableDeferTimes])&&(s="submit",n=0),this.props.recommender.logInteraction(this._buildInteractionData(s,n));const a=this._buildTelemetryData(e,s,n,t,!1);this.publishTelemetry(o.PostponeFeature,a)}}),this._buildCoreData=((e,t,o)=>{const s={};return s[v.DataKeys.UserRole]=o,s[v.DataKeys.InteractionType]=e,s[v.DataKeys.DeferredTimes]=t,s}),this._buildInteractionData=((e,t)=>this._buildCoreData(e,t,this.state.response.role)),this._buildTelemetryData=((e,t,o,s,n)=>{const a={};return a[v.DataKeys.Interaction]=this._buildCoreData(t,o,e.role),a[v.DataKeys.ExitMethod]=s,a[v.DataKeys.Response]=n?e:void 0,a}),this._buildCoreTelemetryData=(()=>{const e={};return e[v.DataKeys.SurveyId]="NetPromoterSurvey",e[v.DataKeys.Url]=window.location.href,e[v.DataKeys.OperationDate]=(new Date).toISOString(),e[v.DataKeys.FeatureAvailability]={},e[v.DataKeys.FeatureAvailability].StepByStepSurveyEnabled=!0,e[v.DataKeys.FeatureAvailability].UseNewBranding=Boolean(this.props.useNewBranding),e[v.DataKeys.FeatureAvailability].VerticalNavigationEnabled=Boolean(this.props.verticalNavigationEnabled),e[v.DataKeys.FeatureAvailability].VerticalBranding=Boolean(this.props.verticalBrandingEnabled),e[v.DataKeys.AnonymousAccess]=!this.props.isAuthenticated,e[v.DataKeys.HubGroupId]=this.props.selectedHubGroupId,e[v.DataKeys.HubId]=this.props.selectedHubId,e[v.DataKeys.ProductName]=this.props.productName,e[v.DataKeys.PromptId]=this.props.data[v.DataKeys.PromptId],e}),this.publishTelemetry=((e,t)=>{const s=this._buildCoreTelemetryData();s[v.DataKeys.NPSDebugCookieEnabled]=this.props.data[v.DataKeys.NPSDebugCookieEnabled],this._telemetryService.publishEvent(o.AreaName,e,Object.assign(Object.assign({},s),t))}),this._setWrapperRef=(e=>{this.dialogWrapper=e}),this._setServices=(()=>{this._telemetryService=this.context.pageContext.getService("IVssTelemetryService")}),this.state={showSurvey:!1,response:{role:this.props.data[v.DataKeys.UserRole]},hasScoreBeenSubmitted:!1},this._setServices()}componentDidMount(){this._selectedHubIsValid()&&this.setState({showSurvey:!0},()=>{this._appear()})}render(){return this.state.showSurvey?c.createElement("div",{id:"nps-dialog",className:(0,a.format)("nps-dialog nps-dialog-{0}","step-by-step"),ref:this._setWrapperRef},c.createElement(m.Button,{subtle:!0,iconProps:{iconName:"Cancel"},className:"nps-dialog-close",ariaLabel:b.CloseButtonTitle,onClick:()=>{this._postpone(this.state.response,"close")}}),c.createElement(P.StepByStepSurveyDialog,{productName:this.props.productName,response:this.state.response,isAuthenticated:this.props.isAuthenticated,change:this._handleChange,submit:this._submit,postpone:this._postpone,close:this._close})):c.createElement("div",null)}_selectedHubIsValid(){const e=this.context.pageContext.getService("IVssNavigationService").getDisplayedNavigation(),t=e.length>2&&e[2]||"N/A",o=e.length>3&&e[3]||"N/A";return t===this.props.selectedHubGroupId&&o===this.props.selectedHubId}}}(),function(e){t.NetPromoterService={};o.Services.add("INetPromoterService",{serviceFactory:class extends o.VssService{constructor(){super(...arguments),this._buildDisplayedProductName=((e,t,o)=>{if(!t)return b.VSTSBrandName;const s=o?this._hubGroupToProductName(e):b.SuiteName;return(0,a.format)(b.BrandNameTemplate,s)})}async initialize(){const e=this._isAuthenticated(),t=this._getSelectedHub();let o;try{o=await this._recommend(e,this._hubGroupToProductName(t[0]))}catch(e){(0,r.traceError)(this.pageContext,"Engagement","NetPromoterSurvey",(0,a.format)("Recommend Failed: {0}",e)),o={isPositive:!1}}if(o.isPositive){this._recommender.logRecommendation();const s=(0,y.isFeatureFlagEnabled)(this.pageContext,"VisualStudio.Services.WebPlatform.UseNewBranding",!1),n=(0,y.isFeatureFlagEnabled)(this.pageContext,"WebAccess.Survey.NetPromoter.VerticalBranding",!1),a=n,r=this.pageContext.getService("IVssLayoutManager");document.getElementById("nps-dialog")||r.renderCallout(r=>c.createElement(N.SurveyComponent,{recommender:this._recommender,isAuthenticated:e,verticalNavigationEnabled:!0,verticalBrandingEnabled:n,useNewBranding:s,productName:this._buildDisplayedProductName(t[0],s,a),selectedHubGroupId:t[0],selectedHubId:t[1],data:o.data||{},onDismiss:r})||{})}}async _recommend(e,t){return this._recommender=e?new D.Recommender(this.pageContext,t):new C.AnonymousRecommender(this.pageContext),this._recommender.recommmend()}_isAuthenticated(){return!(0,S.userHasClaim)(this.pageContext,"anonymous")}_getSelectedHub(){const e=this.pageContext.getService("IVssNavigationService").getDisplayedNavigation();return[e.length>2&&e[2]||"N/A",e.length>3&&e[3]||"N/A"]}_hubGroupToProductName(e){switch(e){case"ms.vss-work-web.work-hub-group":return"Boards";case"ms.vss-code-web.code-hub-group":return"Repos";case"ms.vss-build-web.build-release-hub-group":return"Pipelines";case"ms.feed.package-hub-group":return"Artifacts";case"ms.vss-test-web.test-hub-group":return"Test Plans";default:return b.SuiteName}}}})}()},["Resources","client/RestClient/Interaction","client/RestClient/Recommendation","Common","Recommenders/Recommender","Recommenders/AnonymousRecommender","Components/ScoreChoiceGroup","Components/SubmissionDetail","Components/StepByStepSurveyDialog","SurveyComponent","NetPromoterService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-tfs-web.net-promoter-survey-content"}}));