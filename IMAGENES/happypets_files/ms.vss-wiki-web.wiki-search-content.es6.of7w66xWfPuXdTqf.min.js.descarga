"use strict";define("Wiki/Search",["require","exports","react","InstantSearch/Shared/Utils","InstantSearch/Shared/TelemetryWriter","VSS/Core/Observable","VSS/Platform/Context","VSS/Platform/Feature","InstantSearch/Shared/SearchSuggestions","VSS/Core/Util/Accessibility","VSS/Core/Util/String","VSS/Platform/FPS","VSS/Platform/Location","VSSUI/Util","VSSUI/Utilities/FriendlyNumber","Wiki/Clients/Search/RestClient/Search","InstantSearch/Shared/InstantSearchProviders/BaseInstantSearchProvider","InstantSearch/Shared/ResultRow"],function(e,t,s,i,r,n,o,a,c,h,u,l,p,g,m,d,S,k){var _,P,v,I;_=t.Resources={},t.Resources.WikiHeader="Wiki Pages",t.Resources.ViewAllResults="View all {0} wiki pages",t.Resources.SingleResultLoadedMessage="Result loaded.",t.Resources.ResultsLoadedMessage="Results loaded.",t.Resources.NoSearchSuggestionsInProjectMessage="No {0} results found in {1}.",t.Resources.WikiText="wiki",t.Resources.NoSearchSuggestionsMessage="No {0} results found.",t.Resources.GenericErrorMessage="Oops, something went wrong. Please try again.",t.Resources.RecentWikiPagesHeader="Recent wiki pages",t.Resources.RecentWikiPageLoadedMessage="Recent wiki pages loaded.",P=t.Constants={},(I=t.Constants.CustomerIntelligenceConstants||(t.Constants.CustomerIntelligenceConstants={})).TtiSearchScenarioName="WikiSearchTTIScenario",I.SubSequentSearchScenarioName="WikiSearchTTIScenario",function(e){v=t.SearchResult={};t.SearchResult.WikiSearchResultComponent=class extends s.Component{constructor(){super(...arguments),this.onSearchResultSet=(e=>{this.forceUpdate()})}render(){return s.createElement("div",null,"Wiki Search Results Placeholder")}componentDidMount(){this.props.searchStatus&&this.props.searchStatus.searchResult.subscribe(this.onSearchResultSet)}componentWillReceiveProps(e){this.props.searchStatus&&this.props.searchStatus.searchResult.unsubscribe(this.onSearchResultSet),e.searchStatus&&e.searchStatus.searchResult.subscribe(this.onSearchResultSet)}componentWillUnmount(){this.props.searchStatus&&this.props.searchStatus.searchResult.unsubscribe(this.onSearchResultSet)}}}(),function(e){t.SearchProvider={};const h="WebAccess.Search.Wiki.InfiniteScroll",u="WikiSearchSuggestions";o.Services.add("wiki-search-provider",{serviceFactory:class extends o.VssService{constructor(){super(...arguments),this._wikiSearchSuggestionsComponentRef=s.createRef()}execute(e){return{searchQuery:e,searchResult:new n.ObservableValue(void 0)}}getQuery(e){const t=Object.assign({type:"wiki",filters:{}},e),s=this.pageContext.getService("ITfsPageService").getData();return s&&s.project&&(t.filters.ProjectFilters=[s.project.name]),(0,a.isFeatureFlagEnabled)(this.pageContext,h,!1)&&(t.pageSize=25),t}help(e){return(0,a.isFeatureFlagEnabled)(this.pageContext,"Wiki.InstantSearch",!1)&&(0,a.isFeatureEnabled)(this.pageContext,"ms.vss-tfs-web.enable-search-suggestions",!1)?s.createElement(c.InstantSearchSuggestionsComponent,{ref:this._wikiSearchSuggestionsComponentRef,hubName:"Wiki",featureName:u,searchInput:e}):null}performAction(e){if((0,a.isFeatureFlagEnabled)(this.pageContext,"Wiki.InstantSearch",!1)&&(0,a.isFeatureEnabled)(this.pageContext,"ms.vss-tfs-web.enable-search-suggestions",!1)){if(!this.pageContext.getService("IInvokedProvidersManager").shouldAllowImmersiveSearch())return Promise.resolve(!0);const t=this._wikiSearchSuggestionsComponentRef.current;if(t&&!e.openInNewWindow)return t.invokeActionOfSelectedItem(),Promise.resolve(!0);e.queryText=(0,i.getQueryTextWithWildCardChar)(e.queryText),this.telemetryWriter.publish("WikiImmersiveSearchPerformed")}return Promise.resolve(!1)}render(e){return s.createElement(v.WikiSearchResultComponent,{searchStatus:e})}get telemetryWriter(){return this._telemetryWriter||(this._telemetryWriter=new r.TelemetryWriter(this.pageContext,u)),this._telemetryWriter}}})}(),function(e){t.WikiSuggestionsProvider={};const i=5;class r extends S.BaseInstantSearchProvider{constructor(){super(...arguments),this._contributionId="ms.vss-wiki-web.wiki-suggestions-project-menu-provider",this._providerId="",this._projectFilter="",this._navigateToWikiPage=((e,t,s,i)=>{if(s){const t=this._getPageUrl(e),s=window.open(t,"_blank");s&&s.opener&&(s.opener=null)}else(0,l.onClickFPS)(this.pageContext,this._getPageUrl(e),!0,t);i&&i()}),this._getWikiPageHitDisplayName=(e=>{const t=this._removeSpecialCharsFromWikiPath(e.fileName),s=this._removeExtensionfromPagePath(t);return decodeURIComponent(s)}),this._getPageUrl=(e=>{const t=this._removeMappedPathFromWikiPath(e),s=this._removeSpecialCharsFromWikiPath(t),i={wikiIdentifier:e.wiki.name,wikiVersion:"GB"+e.wiki.version,pagePath:s,project:e.project.name};return(0,p.routeUrl)(this.pageContext,"ms.vss-wiki-web.wiki-overview-route",i)}),this._removeSpecialCharsFromWikiPath=(e=>{return this._removeExtensionfromPagePath(e).replace(/-/g," ").replace("%2D","-")}),this._removeExtensionfromPagePath=(e=>{const t=e.lastIndexOf(".");return 0===".md".toLocaleUpperCase().localeCompare(e.substring(t).toLocaleUpperCase())?e.substring(0,t):e}),this._removeMappedPathFromWikiPath=(e=>{let t=e.wiki.mappedPath?e.wiki.mappedPath:"/";return t.length>0&&"/"==t.charAt(t.length-1)||(t=t.concat("/")),e.path.substring(t.length-1)}),this._executeSearch=((e,t,s,i,r)=>{this.pageContext.getService("IExecuteSearchService").executeSearch(e,t,s,i,r)}),this._recordWikiClickTelemetry=((e,t)=>{t.publish("ResultClicked",{index:e,resultType:"WikiInstantSearch"})}),this._onViewAllResultsClick=((e,t,s)=>{t(!0),s.publish("ResultClicked",{index:e,resultType:"ViewAllWikiLink"})})}_serviceStart(e){super._serviceStart(e),this._initContribution(this._contributionId)}_getMenuItems(e,t,s,i){return s&&i?this.getSuggestions(i,t,"WikiSuggestionsFetched",P.CustomerIntelligenceConstants.TtiSearchScenarioName,P.CustomerIntelligenceConstants.SubSequentSearchScenarioName):this._menuItems.splice(0,this._menuItems.length),this._menuItems}_initContribution(e){if(super._initContribution(e),this._contribution){const{searchProjectFilter:e,searchProviderId:t}=this._contribution;this._providerId=t||"",this._projectFilter=e||""}}_fetchResults(e,t){const s=this.projectProperties?this.projectProperties.id:"",r=this.projectProperties?this.projectProperties.name:"",n=r&&this._projectFilter?{[this._projectFilter]:[r]}:{},o={searchText:e,$skip:0,$top:i,$orderBy:[],filters:n,includeFacets:!1};return(0,d.getSearchClient)(this.pageContext).fetchWikiSearchResults(o,s)}_onFetchSuccess(e,t,r,n){const{searchInput:o,telemetryWriter:a,onFocus:c,invokedProvidersProps:l}=t;if(this._menuItems.splice(0,this._menuItems.length),this.shouldInvokeProvider(t)&&!o.queryText().trim())return;const p=l&&l.props?l.props.header:_.WikiHeader,{results:d,count:S}=r,P=d,v=S;if(P&&P.length>0){this._menuItems.push({id:"",groupKey:this._groupKey,rank:this._rank,itemType:2,text:p,className:"search-suggestion-header"});const t=1===P.length;if(P.forEach((e,i)=>{const r=this._getWikiPageHitDisplayName(e);this._menuItems.push({id:"",className:(0,g.css)(t&&0===i&&"focused"),groupKey:this._groupKey,rank:this._rank,renderMenuCell:(e,t,i)=>{switch(i.onFocusItem=c,e){case 2:return s.createElement(k.ResultRow,{iconProps:{iconName:"TextDocument"},title:r});default:return}},onActivate:(t,s)=>this._navigateToWikiPage(e,s,s&&(s.ctrlKey||s.metaKey),()=>this._recordWikiClickTelemetry(i,a))})}),v>P.length){const t=(0,u.format)(_.ViewAllResults,(0,m.getFriendlyDisplayValue)(v));this._menuItems.push({id:"",groupKey:this._groupKey,rank:this._rank,renderMenuCell:(e,i,r)=>{switch(r.onFocusItem=c,e){case 2:return s.createElement(k.ResultRow,{iconProps:{iconName:"Search"},title:t});default:return}},onActivate:(t,s)=>this._executeSearch(e,this._providerId,"wiki",s.ctrlKey,()=>this._onViewAllResultsClick(i,o.setHelpVisibility,a))})}(0,h.announce)(1===P.length?_.SingleResultLoadedMessage:_.ResultsLoadedMessage)}else if(P&&0===P.length){const e=this.projectProperties?(0,u.format)(_.NoSearchSuggestionsInProjectMessage,_.WikiText,this.projectProperties.name):(0,u.format)(_.NoSearchSuggestionsMessage,_.WikiText);l&&this._menuItems.push({id:"",groupKey:this._groupKey,rank:this._rank,itemType:2,text:p,className:"search-suggestion-header"}),this._menuItems.push({id:"",itemType:2,className:"suggestion-message",groupKey:this._groupKey,rank:this._rank,text:e}),(0,h.announce)(e),a.publish("NoSuggestionsFound",{type:"WikiInstantSearch"})}}_onFetchFail(e,t,s){t.activityId&&s.addProperties({responseActivityId:t.activityId});const{invokedProvidersProps:i}=e,r=i&&i.props?i.props.header:_.WikiHeader;this._menuItems.splice(0,this._menuItems.length),this._menuItems.push({id:"",groupKey:this._groupKey,rank:this._rank,itemType:2,text:r,className:"search-suggestion-header"},{id:"",itemType:2,className:"suggestion-message",groupKey:this._groupKey,rank:this._rank,text:_.GenericErrorMessage}),(0,h.announce)(_.GenericErrorMessage)}get projectProperties(){if(!this._projectProperties){const e=this.pageContext.getService("ITfsPageService").getData();this._projectProperties=e?e.project:void 0}return this._projectProperties}}t.WikiSuggestionsProvider.WikiSuggestionsProvider=r,o.Services.add("project-wiki-suggestions-provider-service",{serviceFactory:r})}(),function(e){t.RecentWikiPagesProvider={};const i=5;class r extends S.BaseInstantSearchProvider{constructor(){super(...arguments),this._contributionId="ms.vss-wiki-web.recent-wikipages-project-menu-provider",this._recordWikiPageClickTelemetry=((e,t)=>{t.publish("ResultClicked",{index:e,resultType:"RecentWikiPage"})}),this._navigateToWikiPage=((e,t,s,i,r,n)=>{if(r){const i=this._getPageUrl(e,t,s),r=window.open(i,"_blank");r&&r.opener&&(r.opener=null)}else(0,l.onClickFPS)(this.pageContext,this._getPageUrl(e,t,s),!0,i);n&&n()}),this._getPageUrl=((e,t,s)=>{const i={wikiIdentifier:t,pageId:s,project:e};return(0,p.routeUrl)(this.pageContext,"ms.vss-wiki-web.wiki-overview-nwp-route2",i)})}_serviceStart(e){super._serviceStart(e),this._initContribution(this._contributionId)}_getMenuItems(e,t,s,i){return s&&!i?this.getSuggestions("",t,"CachedRecentWikiPagesFetched",P.CustomerIntelligenceConstants.TtiSearchScenarioName,P.CustomerIntelligenceConstants.SubSequentSearchScenarioName):this._menuItems.splice(0,this._menuItems.length),this._menuItems}_fetchResults(e,t){return this.pageContext.getService("IPrefetchInstantSearchContentService").recentWikiPagesCache}_onFetchSuccess(e,t,r){const{searchInput:n,telemetryWriter:o,onFocus:a,invokedProvidersProps:c}=t;if(this._menuItems.splice(0,this._menuItems.length),!this.shouldInvokeProvider(t)||!n.queryText().trim())if(r&&r.length>0){const e=c&&c.props?c.props.emptyTextHeader:_.RecentWikiPagesHeader;this._menuItems.push({id:"",groupKey:this._groupKey,rank:this._rank,itemType:2,text:e,className:"search-suggestion-header"});const t=Math.min(i,r.length);for(let e=0;e<t;e++){const t=r[e],i=t.artifactId.split("/"),n=i[0],c=i[1],h=JSON.parse(t.activityDetails).PagePath.split("/"),u=h[h.length-1];this._menuItems.push({id:"",groupKey:this._groupKey,rank:this._rank,renderMenuCell:(e,t,i)=>{switch(i.onFocusItem=a,e){case 2:return s.createElement(k.ResultRow,{iconProps:{iconName:"TextDocument"},title:u});default:return}},onActivate:(e,t)=>this._navigateToWikiPage(this.projectProperties?this.projectProperties.id:"",n,c,t,t&&(t.ctrlKey||t.metaKey),()=>this._recordWikiPageClickTelemetry(e.data,o))})}(0,h.announce)(_.RecentWikiPageLoadedMessage)}else(r&&0===r.length||!r)&&o.publish("NoSuggestionsFound",{type:"RecentWikiPages"})}_onFetchFail(e,t){const{invokedProvidersProps:s}=e,i=s&&s.props?s.props.emptyTextHeader:_.RecentWikiPagesHeader;this._menuItems.splice(0,this._menuItems.length),this._menuItems.push({id:"",groupKey:this._groupKey,rank:this._rank,itemType:2,text:i,className:"search-suggestion-header"},{id:"",itemType:2,className:"suggestion-message",groupKey:this._groupKey,rank:this._rank,text:_.GenericErrorMessage}),(0,h.announce)(_.GenericErrorMessage)}get projectProperties(){if(!this._projectProperties){const e=this.pageContext.getService("ITfsPageService").getData();this._projectProperties=e?e.project:void 0}return this._projectProperties}}t.RecentWikiPagesProvider.RecentWikiPagesProvider=r,o.Services.add("project-recent-wikipages-provider-service",{serviceFactory:r})}()},["Resources","Constants","SearchResult","SearchProvider","WikiSuggestionsProvider","RecentWikiPagesProvider"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-wiki-web.wiki-search-content"}}));