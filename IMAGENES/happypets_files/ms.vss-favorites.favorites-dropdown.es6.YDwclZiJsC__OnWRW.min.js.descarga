"use strict";define("Favorites/Dropdown",["require","exports","Favorites/Common/Resources","react","VSS/Core/Observable","VSS/Core/Util/String","VSS/Platform/UserClaims","VSSUI/Button","VSSUI/List","VSSUI/Observer","VSSUI/Table","VSSUI/Util","VSSUI/Utilities/AggregateItemProvider","VSSUI/Utilities/GroupedItemProvider","VSSUI/Dropdown","VSSUI/Icon","VSSUI/TooltipEx"],function(t,e,i,s,r,o,a,d,n,c,l,v,h,f,p,u,g){!function(t){e.ArtifactDropdownProvider={};const p="default-pivot";class u{constructor(t){this.observers=[],this.resolvedArtifactsByPivot={},this.pivotArtifactsById={},this.disposed=!1,this.builtInGroups=[],this.favoritesByArtifactId={},this.initialFavoriteItems={},this.extendedFavoritesLoaded=!1,this.groupedProvider=new f.GroupedItemProvider([],[],!1),this.getItems=(()=>{const t=(0,a.userHasClaim)(this.options.pageContext,"member");if(!this.artifacts){this.artifacts=this.options.getArtifacts();const e=e=>{this.resolvedArtifacts=this.processResolvedArtifacts(e),this.artifactsLoaded=!0,t||(this.favoritesLoaded=!0),this.favoritesLoaded&&this.addResolvedItems(this.resolvedArtifacts)};if(this.artifacts.ready.value)e(this.artifacts.value);else{const t=t=>{t&&this.artifacts&&e(this.artifacts.value)};this.addObserver(this.artifacts.ready,t)}}if(!this.options.favoritesContext||!t)return;if(this.loadFavorites(),!this.favoritesCollection)return;const e=this.favoritesCollection.value.filter(t=>!t.artifactIsDeleted);this.initialFavoriteItems={};for(const t of e)this.favoritesByArtifactId[t.artifactId]?this.favoritesByArtifactId[t.artifactId].value=t:this.favoritesByArtifactId[t.artifactId]=new r.ObservableValue(t)}),this.getListItem=(t=>{const{getArtifactHref:e,getArtifactName:o,getArtifactId:a,getArtifactListGroupId:h,getArtifactIcon:f,getFavoriteFromArtifact:p,getArtifactTextNode:u}=this.options;let g=!0;const m={data:t,text:o(t),id:a(t)};return this.getFavoriteItem(a(t))?m.groupId="favorites":h&&(m.groupId=h(t)),m.groupId||(m.groupId="default"),f&&(m.iconProps=f(t)),this.favoritesByArtifactId[m.id]||(this.favoritesByArtifactId[m.id]=new r.ObservableValue(void 0)),m.render=((r,o,a,h)=>{let f=!0;if(m.id){this.getFavoriteItem(m.id)||p&&p(t)||(f=!1)}else f=!1;return h.tooltipProps||(h.tooltipProps={disabled:!0},g=!1),s.createElement(l.SimpleTableCell,{className:(0,v.css)(a.className,h.className,2===h.type&&"bolt-list-box-header","artifact-list-item"),columnIndex:o,key:o,tableColumn:a},h&&(0,n.renderListCell)(Object.assign(Object.assign({},h),{textNode:u?u(m):void 0,href:e&&m.data?e(m.data):void 0,textClassName:"flex-grow artifact-link"}),!g),f&&s.createElement(c.Observer,{favorite:this.favoritesByArtifactId[m.id]},t=>{const e=t.favorite?i.FavoriteStarFavoritedTitle:i.FavoriteStarUnfavoritedTitle;return s.createElement(d.Button,{ariaLabel:e,className:"artifact-item-favorite-button",iconProps:{iconName:t.favorite?"FavoriteStarFill":"FavoriteStar",className:(0,v.css)("artifact-item-favorite-icon ms-font-l",(!!t.favorite||this.initialFavoriteItems[m.id])&&"show-favorite")},subtle:!0,tooltipProps:{text:e},onClick:t=>this.onFavoriteClick(t,h)})}))}),m}),this.addObserver=((t,e)=>{t.subscribe(e),this.observers.push({observable:t,observer:e})}),this.forgetCachedArtifacts=(t=>{t?this.pivotArtifactsById[t]={}:(this.artifacts=void 0,this.pivotArtifactsById={},this.resolvedArtifacts=void 0)}),this.onGroupLoadRequest=((t,e=0)=>{if("favorites"===t||"default"===t){const t=new r.ReadyableObservableArray;return t.ready.value=!0,t}const i=this.options.getArtifacts(t),s=this.options.groupToPivotMap&&this.options.groupToPivotMap[t]||"",o=new r.ReadyableObservableArray;this.resolvedArtifactsByPivot[s]=o;const a=i=>{const r=this.resolvedArtifactsByPivot[s]&&this.resolvedArtifactsByPivot[s].length;return o.push(...this.processResolvedArtifacts(i,s)),o.ready.value=!0,i.length>e&&this.resolvedArtifactsByPivot[s].length===r&&this.options.groups&&this.options.groups.some(e=>e.name===t&&Boolean(e.loading))?this.onGroupLoadRequest(t,i.length):this.resolvedArtifactsByPivot[s]};if(i.ready.value)a(i.value);else{const t=t=>{t&&a(i.value)};this.addObserver(i.ready,t)}return o}),this.addResolvedItems=(t=>{this.favoritesLoaded&&this.artifactsLoaded&&this.defaultGroup&&this.groupedProvider.setGroupLoading(this.defaultGroup.id,!1),t&&this.groupedProvider.push(...t)}),this.onFavoriteClick=((t,e)=>{let i=!1,s=this.getFavoriteItem(e.id);if(s)i=!0;else if(!(s=this.options.getFavoriteFromArtifact(e.data)))return;i?this.favoritesService.removeFavorite(s):this.favoritesService.addFavorite(s),t.preventDefault()}),this.favoritesErrorDelegate=(t=>{this.options.onFavoriteLoadError&&this.options.onFavoriteLoadError(t),this.favoritesLoaded=!0,this.addResolvedItems(this.resolvedArtifacts)}),this.onFavoritesLoaded=(t=>{if(this.disposed)return void t.dispose();this.favoritesCollection&&this.favoritesCollection!==this.options.favoritesContext.favorites&&this.favoritesCollection.dispose();const e=[...t.value].sort((t,e)=>(0,o.localeIgnoreCaseComparer)(t.artifactName,e.artifactName));if(this.favoritesCollection=t,t.subscribe(this.onFavoriteItemChanged),e.forEach(t=>{if(!t.artifactIsDeleted&&(this.initialFavoriteItems[t.artifactId]=!0,this.favoritesByArtifactId[t.artifactId]?this.favoritesByArtifactId[t.artifactId].value=t:this.favoritesByArtifactId[t.artifactId]=new r.ObservableValue(t),this.resolvedArtifacts)){const e=this.resolvedArtifacts.findIndex(e=>e.id===t.artifactId);e>-1&&this.resolvedArtifacts.splice(e,1,Object.assign(Object.assign({},this.resolvedArtifacts[e]),{groupId:this.favoriteGroup.id}))}}),this.options.onFavoritesLoaded&&this.options.onFavoritesLoaded(),this.favoritesLoaded=!0,this.options.getArtifactFromFavorite){const t=[];e.forEach(e=>{e.artifactIsDeleted||t.push(this.options.getArtifactFromFavorite(e))});const i=this.processResolvedArtifacts(t);this.addResolvedItems(i)}return this.resolvedArtifacts&&this.addResolvedItems(this.resolvedArtifacts),t}),this.onFavoriteItemChanged=((t,e)=>{if(t.addedItems)for(const e of t.addedItems)this.favoritesByArtifactId[e.artifactId].value=e;if(t.removedItems)for(const e of t.removedItems)this.favoritesByArtifactId[e.artifactId].value=void 0}),t&&this.initialize(t)}get length(){return this.aggregateProvider.length}get value(){return this.aggregateProvider.value}subscribe(t,e){return this.aggregateProvider.subscribe(t,e)}unsubscribe(t,e){return this.aggregateProvider.unsubscribe(t,e)}dispose(){this.favoritesCollection&&(this.options.favoritesContext.favorites===this.favoritesCollection&&this.favoritesCollection.dispose(),this.favoritesCollection=void 0),this.observers.forEach(t=>{t.observable.unsubscribe(t.observer)}),this.disposed=!0}initialize(t){if(this.options=t,this.aggregateProvider=new h.AggregateItemProvider,this.options.pivots)this.options.pivots.forEach(t=>{this.aggregateProvider.push(t.items)}),this.favoritesService=t.favoritesService||t.pageContext.getService("IFavoritesService");else{this.aggregateProvider.push(this.groupedProvider),this.initializeDefaultGroup();const e=t.favoritesContext;this.favoritesService=t.favoritesService||t.pageContext.getService("IFavoritesService"),e&&this.favoritesService.canUseFavorites()&&(this.initializeFavoriteGroup(),e.favorites&&this.onFavoritesLoaded(e.favorites))}}loadFavorites(){if(this.extendedFavoritesLoaded)return Promise.resolve(void 0);const t=this.options.favoritesContext,e=this.favoritesService.getFavorites(t.artifactType,t.artifactScope.type,t.artifactScope.id,!0).then(this.onFavoritesLoaded,this.favoritesErrorDelegate);return this.extendedFavoritesLoaded=!0,e}processResolvedArtifacts(t,e){const i=e||p,s=[];this.pivotArtifactsById[i]||(this.pivotArtifactsById[i]={});for(const e of t){const t=this.options.getArtifactId(e);this.pivotArtifactsById[i][t]||s.push(e),this.pivotArtifactsById[i][t]=e}return s.map(t=>this.getListItem(t))}initializeDefaultGroup(){const t={id:"default",name:this.options.defaultGroupHeader,loading:!0};this.artifactsLoaded=!1;const e=this.tryGetGroupSynchronously("default");e?this.defaultGroup=e:(this.defaultGroup=t,this.builtInGroups.push(t),this.groupedProvider.pushGroups(t))}initializeFavoriteGroup(){const t={id:"favorites",name:this.options.favoriteGroupHeader};this.favoritesLoaded=!1;const e=this.tryGetGroupSynchronously("favorites");e?this.favoriteGroup=e:(this.favoriteGroup=t,this.builtInGroups.unshift(t),this.groupedProvider.spliceGroups(0,0,t))}tryGetGroupSynchronously(t){const{groups:e}=this.options;if(e&&"function"!=typeof e.then)return e.filter(e=>e.id===t)[0]}getFavoriteItem(t){const e=this.favoritesByArtifactId[t];return e||!this.favoritesCollection||this.artifacts?e?e.value:e:this.favoritesCollection.value.filter(e=>e.artifactId===t)[0]}}e.ArtifactDropdownProvider.ArtifactDropdownProviderBase=u;e.ArtifactDropdownProvider.ArtifactDropdownProvider=class extends u{constructor(t){super(t)}}}(),function(t){e.ArtifactDropdown={};function o(t,e){let i=t.text||"";return e&&(i=e(t)),s.createElement("div",{className:"flex-row"},t.iconProps&&s.createElement(u.Icon,Object.assign({},t.iconProps,{className:(0,v.css)(t.iconProps.className,"artifact-dropdown-icon")})),s.createElement(g.Tooltip,{overflowOnly:!0},s.createElement("span",{className:"text-ellipsis"},i)))}e.ArtifactDropdown.ArtifactDropdown=class extends s.Component{constructor(t){super(t),this.provider=new h.AggregateItemProvider,this.searchResults=new r.ObservableArray,this.dropdown=s.createRef(),this.onExpand=(()=>{this.provider.collections.forEach(t=>{const e=t.provider;e.getItems&&e.getItems()})}),this.onSelect=((t,e)=>{e.data&&this.props.getArtifactHref&&(window.location.href=this.props.getArtifactHref(e.data)),this.props.onSelect&&this.props.onSelect(t,e)}),this.renderSelectedItems=((t,e)=>o(e[t.value[0].beginIndex])),this.selectedPivot=t.selectedPivot||new r.ObservableValue(t.pivots?t.pivots[0].id:""),this.provider.push(t.items),this.provider.push(this.searchResults),t.searchResultsGroupName&&this.searchResults.push({id:"search-results-header",text:t.searchResultsGroupName,type:2})}get actions(){const{browseAllText:t,onBrowseAllClick:e,otherActions:s}=this.props,r=s?[...s]:[];return e&&r.push({onClick:e,text:t||i.FavoriteItemPickerBrowseAllText,iconProps:{iconName:"Home"}}),r}render(){const{ariaLabel:t,calloutContentClassName:e,className:i,showFilterBox:r,filterPlaceholderText:o,filteredNoResultsText:a,filteredResultsLoadingText:d,loading:n,noItemsText:c,onFilterTextChanged:l,placeholder:v,pivots:h,renderExpandable:f,searching:u,selection:g,showItemsWhileSearching:m,userFilteredItems:I,width:A}=this.props,b={horizontal:"start",vertical:"end"},S={horizontal:"start",vertical:"start"},F=s.createElement(p.Dropdown,{ariaLabel:t,calloutContentClassName:e,className:i,filterThrottleWait:100,ref:this.dropdown,actions:this.actions,items:this.provider,loading:n,onExpand:this.onExpand,onSelect:this.onSelect,noItemsText:c,placeholder:v,renderCallout:t=>s.createElement(p.DropdownCallout,Object.assign({},t,{anchorOrigin:b,dropdownOrigin:S,filterPlaceholderText:o,filteredNoResultsText:a,filteredResultsLoadingText:d,onFilterTextChanged:(e,i)=>{t.onFilterTextChanged&&t.onFilterTextChanged(e,i),l&&l(e,i)}})),renderExpandable:f?t=>f(Object.assign(Object.assign({},t),{renderSelectedItems:this.renderSelectedItems})):void 0,searching:u,selection:g,showFilterBox:!1!==r,showItemsWhileSearching:m,userFilteredItems:I,width:A});return h?s.createElement(p.WithPivots,{selectedPivot:this.selectedPivot,onPivotClicked:this.onPivotClicked,pivots:h,calloutProps:{anchorOrigin:b,dropdownOrigin:S,onFilterTextChanged:l}},t=>s.cloneElement(F,t)):F}componentWillUnmount(){this.provider.collections.forEach(t=>{t.provider&&t.provider.dispose&&t.provider.dispose()})}expand(){this.dropdown.current&&this.dropdown.current.expand()}focus(){this.dropdown.current&&this.dropdown.current.focus()}onPivotClicked(t){this.selectedPivot.value=t.id}},e.ArtifactDropdown.renderSelectedItem=o}()},["ArtifactDropdownProvider","ArtifactDropdown"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-favorites.favorites-dropdown"}}));